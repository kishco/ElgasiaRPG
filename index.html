<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Elgasia RPG ver1.06</title>
  <style>
    body { background: #181828; color: #fff; margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif;}
    #mainwrap { max-width: 1500px; margin: 30px auto; display: flex; flex-direction: column; gap: 25px;}
    .rowflex { display: flex; flex-direction: row; gap: 30px; }
    #chatbox { background: #3c3c5a; border-radius: 28px; min-width: 340px; width: 340px; min-height: 420px; display: flex; align-items: center; justify-content: center; }
    #chatbox iframe { border-radius: 20px; border: none; width: 95%; height: 90%; min-height: 410px; }
    #stat-content-box { background: #191934; border-radius: 28px; flex: 1; min-width: 430px; padding: 32px 0 32px 0; min-height: 420px; display: flex; align-items: flex-start; justify-content: center;}
    #stat-content { width: 90%; }
    #sidebar { background: #191934; border-radius: 28px; min-width: 270px; width: 270px; padding: 24px 0; display: flex; flex-direction: column; gap: 15px; align-items: center;}
    .sidebtn { width: 200px; padding: 16px 0; font-size: 20px; border-radius: 12px; border: 2px solid #353575; background: #2e2e6e; color: #fff; margin-bottom: 6px; font-weight: bold; cursor: pointer; transition: background 0.13s;}
    .sidebtn:hover { background: #383890;}
    #battle-log-box { background: #161625; border-radius: 16px; min-height: 130px; margin: 0 0 0 0; }
    #battle-log { min-height: 130px; padding: 22px 28px; font-size: 18px; }
    /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ */
    .equipitem, .shop-item { margin:8px 0; padding:10px 12px; border-radius:8px; background: #21214a; }
    .inv-btn { margin-left: 8px; background: #384085; color: #fff; border: none; border-radius: 5px; padding: 2px 9px; font-size: 14px;}
    .inv-btn:disabled { color: #888;}
    .shop-title { color:#ffe680; font-size: 21px; margin-bottom:10px;}
    .succ-msg { color:#8aff8a; font-weight:bold;}
    .fail-msg { color:#ff6161; font-weight:bold;}
    .dead-log { color:#fa4247; font-weight:bold;}
    .set-bonus { color: #ffe161; font-weight: bold;}
    .monname { color:#ffd700; font-weight:bold;}
    .unique-monster { color:#ff5555; font-weight:bold;}
    .stat-box { margin-bottom: 28px; font-size: 18px;}
    .stat-box span { display: inline-block; margin-right: 18px; }
    /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
    ::-webkit-scrollbar {width:8px;}
    ::-webkit-scrollbar-thumb {background:#333;border-radius:6px;}
    ::selection { background: #384085; color:#fff; }
  </style>
</head>
<body>
  <div id="mainwrap">
    <div class="rowflex">
      <!-- ì™¼ìª½ ì±„íŒ… -->
      <div id="chatbox">
        <iframe src="https://tlk.io/elasiarpg" allowtransparency="true"></iframe>
      </div>
      <!-- ì¤‘ì•™ ìŠ¤íƒ¯/ë‚´ìš© -->
      <div id="stat-content-box">
        <div id="stat-content">ê²Œì„ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.</div>
      </div>
      <!-- ì˜¤ë¥¸ìª½ UI ë²„íŠ¼ -->
      <div id="sidebar">
        <button class="sidebtn" onclick="action('hunt')">ì‚¬ëƒ¥</button>
        <button class="sidebtn" onclick="dungeonEnterUI()">ë˜ì „</button>
        <button class="sidebtn" onclick="showChar()">ìŠ¤íƒ¯/ì¥ë¹„</button>
        <button class="sidebtn" onclick="showInv()">ì†Œì§€í’ˆ</button>
        <button class="sidebtn" onclick="showTown()">ë§ˆì„</button>
        <button class="sidebtn" onclick="saveGame()">ì„¸ì´ë¸Œ</button>
        <button class="sidebtn" onclick="showLoad()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
    <!-- í•˜ë‹¨ ì „íˆ¬ë¡œê·¸ -->
    <div id="battle-log-box">
      <div id="battle-log">ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”.</div>
    </div>
  </div>
<script>
/* ========== ì „ì—­ ë°ì´í„°/ìƒìˆ˜/ìœ í‹¸ ========== */
let user = null, saveSlot = 1;

function rint(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

const statNames = ["STR", "DEX", "INT", "VIT", "LUK"];
const equipSlots = ["ë¨¸ë¦¬", "ìƒì˜", "í•˜ì˜", "ì†", "ì‹ ë°œ", "ë¬´ê¸°", "ë°©íŒ¨"];
const itemStatTable = {
  "ì¼ë°˜":     { base:[0, 2],    atk:[1, 3]   },
  "ë ˆì–´":     { base:[2, 4],    atk:[3, 6]   },
  "ìœ ë‹ˆí¬":   { base:[4, 7],    atk:[6, 10]  },
  "ì—í”½":     { base:[7, 11],   atk:[10, 15] },
  "ë ˆì „ë”ë¦¬": { base:[12, 18],  atk:[16, 22] },
  "ìœ ì¼":     { base:[18, 27],  atk:[25, 35] }
};
const armorSkillEffectScale = {
  "ì¼ë°˜":     1,
  "ë ˆì–´":     1,
  "ìœ ë‹ˆí¬":   1.2,
  "ì—í”½":     1.5,
  "ë ˆì „ë”ë¦¬": 2,
  "ìœ ì¼":     3
};
const prefixes = ["ë¶ˆíƒ€ëŠ”", "ì‹ ì†í•œ", "ê³ ëŒ€ì˜", "ë¹›ë‚˜ëŠ”", "ê°•ì¸í•œ", "ì¬ë¹ ë¥¸", "í˜„ìì˜", "ì•”í‘ì˜", "ë‹¨ë‹¨í•œ", "ìš©ë§¹í•œ"];
const suffixes = ["ê´‘ê¸°", "ì§€í˜œ", "ì†ë„", "í–‰ìš´", "í˜", "ìˆ˜í˜¸", "íŒŒë©¸", "ë§ˆë²•", "ë¶ˆë©¸", "ìš©ê¸°"];
const rarityOrder = ["ì¼ë°˜","ë ˆì–´","ìœ ë‹ˆí¬","ì—í”½","ë ˆì „ë”ë¦¬","ìœ ì¼"];
const rarityColors = { "ì¼ë°˜":"equip-normal", "ë ˆì–´":"equip-rare", "ìœ ë‹ˆí¬":"equip-unique", "ì—í”½":"equip-epic", "ë ˆì „ë”ë¦¬":"equip-legend", "ìœ ì¼":"equip-myth" };
const rarityRate = [60,20,5,1,0.01,0];
const dungeonRate = [45,25,10,6,1,0.1];
const inventoryLimit = 40;
const skillTriggerRate = { "ì¼ë°˜": 0.02, "ë ˆì–´": 0.04, "ìœ ë‹ˆí¬": 0.07, "ì—í”½": 0.10, "ë ˆì „ë”ë¦¬": 0.15, "ìœ ì¼": 0.33 };
const skillGiveRate = { "ì¼ë°˜": 0.02, "ë ˆì–´": 0.06, "ìœ ë‹ˆí¬": 0.10, "ì—í”½": 0.18, "ë ˆì „ë”ë¦¬": 0.25, "ìœ ì¼": 1.0 };
const armorSkillTriggerRate = {"ì¼ë°˜": 0.03, "ë ˆì–´": 0.05, "ìœ ë‹ˆí¬": 0.07, "ì—í”½": 0.10, "ë ˆì „ë”ë¦¬": 0.13, "ìœ ì¼": 0.17};
const slotTypePool = {
  "ë¬´ê¸°": [
    {name:"ê²€",type:"ê·¼ì ‘"}, {name:"ë„ë¼",type:"ê·¼ì ‘"}, {name:"ì°½",type:"ê·¼ì ‘"}, {name:"ë ˆì´í”¼ì–´",type:"ê·¼ì ‘"},
    {name:"ëŒ€ê²€",type:"ê·¼ì ‘"}, {name:"ì–‘ì†ë„ë¼",type:"ê·¼ì ‘"},
    {name:"í™œ",type:"ì›ê±°ë¦¬"}, {name:"ì„ê¶",type:"ì›ê±°ë¦¬"}, {name:"ì´",type:"ì›ê±°ë¦¬"},
    {name:"ì›ë“œ",type:"ë§ˆë²•"}, {name:"ìŠ¤íƒœí”„",type:"ë§ˆë²•"}, {name:"ë“€ì–¼ê±´",type:"ë§ˆë²•"}
  ],
  "ë°©íŒ¨": [{name:"ë°©íŒ¨",type:"ë°©ì–´"}],
  "ë¨¸ë¦¬": [{name:"íˆ¬êµ¬"},{name:"ëª¨ì"},{name:"ë‘ê±´"}],
  "ìƒì˜": [{name:"ê°‘ì˜·"},{name:"ë¡œë¸Œ"},{name:"ìì¼“"}],
  "í•˜ì˜": [{name:"ë°”ì§€"},{name:"ë ˆê¹…ìŠ¤"}],
  "ì‹ ë°œ": [{name:"ë¶€ì¸ "},{name:"ì‹ ë°œ"},{name:"ì¥í™”"}],
  "ì†": [{name:"ì¥ê°‘"},{name:"ë°˜ì§€"}]
};
const skillPool = {
  "ê·¼ì ‘": ["íšŒì „ë² ê¸°", "ì§€ì§„ê°•íƒ€", "ê´‘ì—­ì°¸ê²©", "ì°¸ê²©", "ëŒì§„ë² ê¸°"],
  "ì›ê±°ë¦¬": ["ì—°ì†ì‚¬ê²©", "ê´€í†µí™”ì‚´", "ì €ê²©", "í­ë°œí™”ì‚´", "ì§‘ì¤‘ì‚¬ê²©"],
  "ë§ˆë²•": ["íŒŒì´ì–´ë³¼", "ì•„ì´ìŠ¤ìŠ¤í†°", "ì²´ì¸ë¼ì´íŠ¸ë‹", "ì•”í‘êµ¬", "ì—ë„ˆì§€ë¸”ë˜ìŠ¤íŠ¸"]
};
const monsterPrefixes = ["ë¶ˆíƒ€ëŠ”", "ì‚¬ë‚˜ìš´", "ê±°ëŒ€í•œ", "ë‚ ì¹´ë¡œìš´", "ì•”í‘ì˜", "ë¹™ê²°ì˜", "ê´‘ê¸°ì˜", "ë²ˆê°œì˜", "ë…ê¸°ì˜", "ì£½ìŒì˜"];
const monsterNames = [
  "ê·¸ë¦¼ì ë©§ë¼ì§€", "ë¹™ê²° ìŠ¬ë¼ì„", "ë¶ˆì‚¬ë¥¸ í•´ê³¨ê¸°ì‚¬", "ì§€ì˜¥ë°•ì¥", "ëŒì—°ë³€ì´ ëŠ‘ëŒ€",
  "ì•”í‘ì˜ ê³ ë¸”ë¦°", "ê´‘ê¸°ì˜ ì˜¤ìš°ê±°", "ì„œë¦¬ê³¨ë ˜", "ë¶ˆê½ƒ ì™€ì´ë²ˆ", "ì£½ìŒì˜ ë¦¬ì¹˜",
  "í˜¼ëˆì˜ ë¯¸ë…¸íƒ€ìš°ë¥´ìŠ¤", "ë§¹ë… ìŠ¤ì½œí”¼ì˜¨", "ë¬´ì‡  ê³°", "í‰í¬í•œ ëŠ‘ëŒ€", "ë…ì‚¬",
  "ì–´ë‘ ì˜ ì•”ì‚´ì", "ê´‘í¬í•œ ê³°", "ê³ ëŒ€ì˜ ê³¨ë ˜", "ë‚ ë µí•œ íŒ¬ì„œ", "ì €ì£¼ë°›ì€ í•´ê³¨ì „ì‚¬"
];
const uniqueMonsters = [
  "ê´‘íœ˜ë£¡ ë²¨ë¦¬ì˜¤ë¡œìŠ¤", "í‘ì„¬ë£¡ ì•„ë²¨ë¦¬ì˜¤ìŠ¤", "ìˆ˜ì•”ë£¡ íƒ€ë‚˜ë¡œí† ìŠ¤", "ì•”í† ë£¡ ìš°ë¡œë³´ë¡œìŠ¤"
];
const uniqueMonsterPrefixes = {
  "ê´‘íœ˜ë£¡ ë²¨ë¦¬ì˜¤ë¡œìŠ¤": "ê´‘íœ˜",
  "í‘ì„¬ë£¡ ì•„ë²¨ë¦¬ì˜¤ìŠ¤": "í‘ì„¬",
  "ìˆ˜ì•”ë£¡ íƒ€ë‚˜ë¡œí† ìŠ¤": "ìˆ˜ì•”",
  "ì•”í† ë£¡ ìš°ë¡œë³´ë¡œìŠ¤": "í† ì•”"
};
const uniqueSetBonus = {
  "ê´‘íœ˜": { name: "ê´‘íœ˜ ì„¸íŠ¸", desc: "1í„´ 2íšŒ ê³µê²©" },
  "í‘ì„¬": { name: "í‘ì„¬ ì„¸íŠ¸", desc: "ê³µê²© ì‹œ 30% í™•ë¥ ë¡œ 1í„´ ìŠ¤í„´" },
  "ìˆ˜ì•”": { name: "ìˆ˜ì•” ì„¸íŠ¸", desc: "í”¼ê²© ì‹œ 40% í™•ë¥ ë¡œ 50% ë°˜ì‚¬" },
  "í† ì•”": { name: "í† ì•” ì„¸íŠ¸", desc: "ì „íˆ¬ ì¤‘ 1íšŒ ì‚¬ë§ ì‹œ 50% ë¶€í™œ" }
};

function updateStatBox(html) { document.getElementById("stat-content").innerHTML = html; }
function log(msg) { document.getElementById("battle-log").innerHTML = msg; }

// ====== ê²Œì„ ì§„ì…ì‹œ ì„¸ì´ë¸Œ ìŠ¬ë¡¯ ì„ íƒ ======
window.onload = function() { renderSaveSlotSelect(); }
function renderSaveSlotSelect() {
  let html = `<div class="save-slot-select"><b>ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `ìŠ¬ë¡¯${i} (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `ìŠ¬ë¡¯${i} (ìƒˆ ì‹œì‘)`;
    html += `<div style="margin-bottom:8px;display:flex;align-items:center;">
      <button class="inv-btn" onclick="startGame(${i})">${btnText}</button>
      <button class="inv-btn" onclick="deleteSaveSlot(${i})" style="background:#d36c6c;">ì‚­ì œ</button>
    </div>`;
  }
  html += `</div>`;
  updateStatBox(html);
  log("ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”.");
}
function deleteSaveSlot(slot) {
  if(confirm(`ì •ë§ë¡œ ìŠ¬ë¡¯${slot}ì˜ ì €ì¥ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)){
    localStorage.removeItem("elgasia_save_"+slot);
    renderSaveSlotSelect();
  }
}
function startGame(slot) {
  saveSlot = slot;
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data); if(!user.storage) user.storage=[];
    showMainUI();
    updateUser();
    log(`<span style='color:#aff'>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìŠ¬ë¡¯ ${slot}</span>`);
  } else {
    user = {
      name: "ìš©ì‚¬", level: 1, exp: 0, rebirth: 0, gold: 100,
      stats: [1,1,1,1,1], statmax: 9999, hp: 30, maxhp: 30,
      equip: {}, inv: [], town: {restcount:0,skillstone:1}, stones: 0, storage: []
    };
    showMainUI();
    updateUser();
    log(`<b>í™˜ì˜í•©ë‹ˆë‹¤! ìºë¦­í„° ì´ë¦„ì„ ë¨¼ì € ì •í•´ì£¼ì„¸ìš”.</b> <br><div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="ìºë¦­í„° ì´ë¦„"/><button class="inv-btn" onclick="setCharName()">í™•ì¸</button></div>`);
  }
}
function setCharName() {
  let n = document.getElementById("newname").value.trim();
  if (!n) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  user.name = n;
  updateUser();
  log(`ì´ë¦„ì´ <b>${n}</b>ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  saveGame();
}
function showLoad() { renderSaveSlotSelect(); }

function showMainUI() { // ì¤‘ì•™ ë‚´ìš© ë‹¤ì‹œ stat-contentë§Œ ì“°ë„ë¡
  showChar();
}
</script>
<script>
/* ==== ê¸°ì¡´ ì½”ë“œì™€ 100% ì—°ë™ ==== */

// ìŠ¤íƒ¯, ì •ë³´, ì¥ë¹„ì°½
function updateUser() {
  if (!user.storage) user.storage = [];
  let statLabel = ["STR(ê·¼ë ¥)", "DEX(ë¯¼ì²©)", "INT(ì§€ëŠ¥)", "VIT(ì²´ë ¥)", "LUK(ìš´)"];
  let baseStats = user.stats.slice();
  let equipStats = user.stats.slice();
  let addATK = 0, addRATK = 0, addMATK = 0, addDEF = 0;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if (eq && eq.stat) {
      for (let i = 0; i < 5; i++) equipStats[i] += eq.stat[i] || 0;
      addATK += eq.stat[5] || 0;
      addRATK += eq.stat[6] || 0;
      addMATK += eq.stat[7] || 0;
      addDEF += eq.stat[3] || 0;
    }
  }
  let totalATK = addATK + equipStats[0];
  let totalRATK = addRATK + equipStats[1];
  let totalMATK = addMATK + equipStats[2];
  let totalDEF = equipStats[3];
  let baseStr = baseStats.map((v, i) => `${statLabel[i]}: ${v}`).join(" / ");
  let equipStr = equipStats.map((v, i) => `${statLabel[i]}: ${v}`).join(" / ");
  let eqhtml = "";
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if (eq) {
      eqhtml += `<div><b>${slot}:</b> ${itemDisplay(eq)}
      <button class="inv-btn" onclick="unequip('${slot}')">í•´ì œ</button></div>
      ${eq.skill ? `<div class="equip-bonus">ìŠ¤í‚¬: ${eq.skill}</div>` : ""}`;
    } else {
      eqhtml += `<div><b>${slot}:</b> <span style="color:#888">ë¹„ì–´ìˆìŒ</span></div>`;
    }
  }
  let setBonusKey = checkUniqueSetBonus();
  let setBonusMsg = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} ì„¸íŠ¸ íš¨ê³¼: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
  let html = `<div class="stat-box">
    <span>ì´ë¦„ <b>${user.name}</b> <button class="inv-btn" onclick="promptNameChange()">ë³€ê²½</button></span>
    <span>ë ˆë²¨ <b>${user.level}</b></span>
    <span>ê²½í—˜ì¹˜ <b>${user.exp}/${expNeed(user.level)}</b></span>
    <span>ê³¨ë“œ <b>${user.gold}</b></span>
    <span>HP <b>${user.hp}/${user.maxhp}</b></span>
    <span>ê°•í™”ì„ <b>${user.stones || 0}</b></span>
    <span>ì°½ê³  <b>${user.storage.length}/100</b></span>
  </div>
  <b>ê¸°ë³¸ ìŠ¤íƒ¯:</b> ${baseStr}<br>
  <b>ì¥ë¹„ ì ìš©:</b> ${equipStr}<br>
  <b>[ê³µê²©/ë°©ì–´]</b> ATK(ê·¼ì ‘): <b>${totalATK}</b> / RATK(ì›ê±°ë¦¬): <b>${totalRATK}</b> / MATK(ë§ˆë²•): <b>${totalMATK}</b> / DEF: <b>${totalDEF}</b><br>
  <b>HP:</b> ${user.hp}/${user.maxhp}<br>
  <b>ì¥ì°©ì¥ë¹„</b><br>${eqhtml}${setBonusMsg}`;
  updateStatBox(html);
}
function showChar() { updateUser(); }
function promptNameChange() {
  let n = prompt("ìƒˆ ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", user.name || "");
  if (!n) return;
  user.name = n;
  updateUser(); saveGame();
}
function expNeed(lv) { return Math.floor(Math.pow(lv, 1.5) * 12) + lv * 8; }
function checkUniqueSetBonus() {
  const armorSlots = ["ë¨¸ë¦¬", "ìƒì˜", "í•˜ì˜", "ì†", "ì‹ ë°œ"];
  let found = { ê´‘íœ˜: 0, í‘ì„¬: 0, ìˆ˜ì•”: 0, í† ì•”: 0 };
  for (let slot of armorSlots) {
    let eq = user.equip[slot];
    if (eq && eq.rarity === "ìœ ì¼") {
      let pre = eq.uniqPrefix || (eq.name.split("ì˜")[0]);
      if (found[pre] !== undefined) found[pre]++;
    }
  }
  for (let key in found) if (found[key] >= 4) return key;
  return null;
}
function unequip(slot) {
  if (!user.equip[slot]) return;
  addInv(user.equip[slot]);
  user.equip[slot] = undefined;
  showChar();
}
function saveGame() {
  if (!user) return;
  localStorage.setItem("elgasia_save_" + saveSlot, JSON.stringify(user));
  log(`<span style='color:#aaf'>ìŠ¬ë¡¯ ${saveSlot}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>`);
}

// ================= ì†Œì§€í’ˆ/ì°½ê³  ==================
function itemDisplay(item) {
  return `<span class="${rarityColors[item.rarity]}">[${item.rarity}]</span> ${item.name} <span class="equip-bonus">STR:${item.stat[0]} DEX:${item.stat[1]} INT:${item.stat[2]} VIT:${item.stat[3]} LUK:${item.stat[4]} ${item.attackType === "ê·¼ì ‘" ? `ATK:${item.stat[5]}` : ""}${item.attackType === "ì›ê±°ë¦¬" ? `RATK:${item.stat[6]}` : ""}${item.attackType === "ë§ˆë²•" ? `MATK:${item.stat[7]}` : ""}</span> ${item.skill ? `<span class="equip-bonus">ìŠ¤í‚¬:${item.skill}</span>` : ""}${item.armorSkill ? ` <span class="equip-bonus">ë°©ì–´êµ¬ìŠ¤í‚¬:${item.armorSkill.name}(+${typeof item.armorSkill.value === "number" ? item.armorSkill.value.toFixed(1) : item.armorSkill.value})</span>` : ""}${item.enh ? ` <span class="enh-lv">+${item.enh}</span>` : ""}`;
}
function showInv() {
  let invhtml = "";
  user.inv.forEach((item, i) => {
    invhtml += `<div class="equipitem">${itemDisplay(item)}
      <button class="inv-btn" onclick="equipItem(${i})">ì°©ìš©</button>
      <button class="inv-btn" onclick="sellInv(${i})">íŒë§¤</button></div>`;
  });
  if (!invhtml) invhtml = "<div style='color:#888'>ì†Œì§€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>";
  let html = `<b>[ì†Œì§€í’ˆ]</b> (${user.inv.length}/${inventoryLimit})<br>${invhtml}<br>
    <button class="inv-btn" onclick="sellAllInv()">ì „ì²´ íŒë§¤ (ì°©ìš© ì œì™¸)</button><br>
    <button class="inv-btn" onclick="showChar()">ëŒì•„ê°€ê¸°</button>`;
  updateStatBox(html);
}
function equipItem(idx) {
  let item = user.inv[idx];
  if (!item || !item.slot || equipSlots.indexOf(item.slot) === -1) return;
  if (user.equip[item.slot]) addInv(user.equip[item.slot]);
  user.equip[item.slot] = item;
  user.inv.splice(idx, 1);
  showInv(); updateUser();
}
function sellInv(idx) {
  let item = user.inv[idx];
  let sellValue = 5 + (rarityBonus(item.rarity) * 10);
  user.gold += sellValue;
  user.inv.splice(idx, 1);
  log(`${itemDisplay(item)}<br><span style="color:#ffe55e">${sellValue}Gì— íŒë§¤ë˜ì—ˆìŠµë‹ˆë‹¤!</span><br><button class="inv-btn" onclick="showInv()">ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function sellAllInv() {
  if (user.inv.length === 0) { log("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  let totalGold = 0;
  let soldNames = [];
  let filteredInv = user.inv.filter(item => {
    for (let slot of equipSlots) {
      if (user.equip[slot] && user.equip[slot].name === item.name) return false;
    }
    return true;
  });
  if (filteredInv.length === 0) { log("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. (ì°©ìš© ì¤‘ ì•„ì´í…œ ì œì™¸)"); return; }
  filteredInv.forEach(item => {
    let idx = user.inv.indexOf(item);
    if (idx >= 0) user.inv.splice(idx, 1);
    let sellValue = 5 + (rarityBonus(item.rarity) * 10);
    totalGold += sellValue;
    soldNames.push(item.name);
  });
  user.gold += totalGold;
  log(`ì°©ìš© ì¤‘ì´ ì•„ë‹Œ ëª¨ë“  ì•„ì´í…œ íŒë§¤ ì™„ë£Œ! ì´ ${totalGold}ê³¨ë“œë¥¼ ì–»ì—ˆë‹¤.<br>íŒë§¤í•œ ì•„ì´í…œ: ${soldNames.join(", ")}<br><button class="inv-btn" onclick="showInv()">ì†Œì§€í’ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function addInv(item) {
  if (user.inv.length >= inventoryLimit) { log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!"); return false; }
  user.inv.push(item); return true;
}
function rarityBonus(r) {
  if (r == "ì¼ë°˜") return 0; if (r == "ë ˆì–´") return 1; if (r == "ìœ ë‹ˆí¬") return 2;
  if (r == "ì—í”½") return 3; if (r == "ë ˆì „ë”ë¦¬") return 4; if (r == "ìœ ì¼") return 5;
  return 0;
}

// ====================== ë§ˆì„, ìƒì , ê°•í™” =====================
function showTown() {
  let html = `<b>[ë§ˆì„]</b><br>
    <button class="inv-btn" onclick="innRest()">ì—¬ê´€(íœ´ì‹)</button>
    <button class="inv-btn" onclick="showShop()">ì¥ë¹„ìƒì </button>
    <button class="inv-btn" onclick="showEnhance()">ê°•í™”ì†Œ</button>
    <button class="inv-btn" onclick="showChar()">ëŒì•„ê°€ê¸°</button>`;
  updateStatBox(html);
}
function innRest() {
  let cost = 20 + user.level * 5;
  if (user.gold < cost) { log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
  user.gold -= cost; user.hp = user.maxhp;
  log(`ì—¬ê´€ì—ì„œ íœ´ì‹ í›„ HP ì „ë¶€ íšŒë³µ! (${cost}ê³¨ë“œ ì†Œëª¨)<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function showShop() {
  let items = [];
  for (let i = 0; i < 5; i++) items.push(makeItem(false, true));
  let html = `<div class="shop-title">[ì¥ë¹„ ìƒì ] (ì—í”½ ë“±ê¸‰ ì´ìƒì€ ë¯¸ì¶œí˜„)</div>`;
  items.forEach((item, idx) => {
    html += `<div class="shop-item">${itemDisplay(item)}
      <button class="inv-btn" onclick="buyShopItem(${idx})">êµ¬ë§¤ (${50 + user.level * 8}G)</button></div>`;
  });
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  updateStatBox(html); window.shopItems = items;
}
function buyShopItem(idx) {
  let item = window.shopItems[idx];
  let cost = 50 + user.level * 8;
  if (user.gold < cost) { log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
  if (user.inv.length >= inventoryLimit) { log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!"); return; }
  user.gold -= cost;
  user.inv.push(item);
  log(`êµ¬ë§¤ ì™„ë£Œ!<br>${itemDisplay(item)}<br><button class="inv-btn" onclick="showShop()">ìƒì ìœ¼ë¡œ</button>`);
  updateUser();
}
function showEnhance() {
  let html = `<div class="shop-title">[ì¥ë¹„ ê°•í™”]</div>`;
  let equips = Object.values(user.equip).filter(e => e);
  if (!equips.length) {
    html += `<div style="color:#888">ê°•í™”í•  ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    equips.forEach((eq, idx) => {
      html += `<div class="shop-item">${itemDisplay(eq)}<button class="inv-btn" onclick="enhanceItem('${eq.slot}')">ê°•í™”</button></div>`;
    });
  }
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  updateStatBox(html);
}
function enhanceItem(slot) {
  let eq = user.equip[slot];
  if (!eq) return;
  let lv = eq.enh || 0;
  if (lv >= 20) { log("ìµœëŒ€ ê°•í™” ë‹¨ê³„ì…ë‹ˆë‹¤."); return; }
  let needStone = lv < 5 ? [1, 2, 4, 8, 20][lv] : lv < 10 ? 20 * Math.pow(2, lv - 4) : lv < 15 ? 60 * Math.pow(3, lv - 9) : 120 * Math.pow(4, lv - 14);
  let needGold = 100 + lv * 50;
  if (user.stones < needStone) { log("ê°•í™”ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
  if (user.gold < needGold) { log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
  let prob = lv < 4 ? 1 : lv < 10 ? 0.5 - (lv - 4) * 0.08 : lv < 15 ? 0.12 - (lv - 10) * 0.025 : 0.04 - (lv - 15) * 0.007;
  if (prob < 0.01) prob = 0.01;
  let succ = Math.random() < prob;
  user.stones -= needStone;
  user.gold -= needGold;
  if (succ) {
    eq.enh = lv + 1;
    if (eq.slot === "ë¬´ê¸°") {
      let atkIndex = 5;
      if (eq.attackType === "ì›ê±°ë¦¬") atkIndex = 6;
      else if (eq.attackType === "ë§ˆë²•") atkIndex = 7;
      eq.stat[atkIndex] = (eq.stat[atkIndex] || 0) + rint(1, 3);
      log(`<span class="succ-msg">[+${eq.enh} ê°•í™” ì„±ê³µ! ì£¼ìš” ê³µê²©ë ¥ì´ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!]</span> ê³¨ë“œ ${needGold}ì†Œëª¨, ê°•í™”ì„ ${needStone}ì†Œëª¨`);
    } else {
      let statIdx = rint(0, 4);
      eq.stat[statIdx] = (eq.stat[statIdx] || 0) + rint(1, 3);
      log(`<span class="succ-msg">[+${eq.enh} ê°•í™” ì„±ê³µ! ìŠ¤íƒ¯ì´ ëœë¤ìœ¼ë¡œ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!]</span> ê³¨ë“œ ${needGold}ì†Œëª¨, ê°•í™”ì„ ${needStone}ì†Œëª¨`);
    }
  } else {
    log(`<span class="fail-msg">[ê°•í™” ì‹¤íŒ¨] ê³¨ë“œ ${needGold}ì†Œëª¨, ê°•í™”ì„ ${needStone}ì†Œëª¨</span>`);
  }
  updateUser();
  showEnhance();
}

// ====== ì•„ì´í…œ ìƒì„±, ëª¬ìŠ¤í„° ìƒì„±, ì „íˆ¬, ì‚¬ëƒ¥, ë˜ì „ ======
</script>
<script>
/* ==== ì „íˆ¬/ë˜ì „/ì‚¬ëƒ¥/ë ˆë²¨ì—…/ëª¬ìŠ¤í„°/ì•„ì´í…œ ==== */

// ==== ëª¬ìŠ¤í„° ìƒì„± ====
function makeMonster(level, isDungeon = false) {
  if (isDungeon && Math.random() < 0.01) {
    let name = uniqueMonsters[rint(0, uniqueMonsters.length - 1)];
    let hp = Math.floor(40 + level * 4 + rint(10, 40));
    let atk = Math.floor(8 + level * 2 + rint(5, 10));
    let def = Math.floor(level / 6 + rint(2, 8));
    return { name, hp, atk, def, unique: true };
  }
  let prefix = monsterPrefixes[rint(0, monsterPrefixes.length - 1)];
  let nameBase = monsterNames[rint(0, monsterNames.length - 1)];
  let name = prefix + " " + nameBase;
  let hp = Math.floor(12 + level * 2.5 + rint(0, 4));
  let atk = Math.floor(3 + level * 0.8 + rint(0, 2));
  let def = Math.floor(level / 5 + rint(0, 1));
  return { name, hp, atk, def, unique: false };
}

// ==== ì•„ì´í…œ ìƒì„± ====
function makeItem(allowMyth, isShop, uniqueMonsterName = null) {
  let rate = allowMyth ? dungeonRate : rarityRate;
  let localRarityOrder = isShop ? ["ì¼ë°˜","ë ˆì–´","ìœ ë‹ˆí¬"] : rarityOrder;
  let localRate = isShop ? [70,25,5] : rate;
  let rarity = "ì¼ë°˜";
  let r = Math.random() * 100, acc = 0;
  for (let i=0;i<localRate.length;i++) { acc += localRate[i]; if (r < acc) { rarity = localRarityOrder[i]; break; } }
  if(!uniqueMonsterName && rarity === "ìœ ì¼") rarity = "ë ˆì „ë”ë¦¬";
  if(uniqueMonsterName) rarity = "ìœ ì¼";
  let slot = equipSlots[rint(0, equipSlots.length-1)];
  let pool = slotTypePool[slot];
  let baseObj = pool[rint(0, pool.length-1)];
  let itemType = baseObj.name;
  let itemAttackType = baseObj.type || null;
  // ìœ ì¼ ì•„ì´í…œ(ì´ë¦„/ìŠ¤íƒ¯/ìŠ¤í‚¬ ê·œì¹™ ì ìš©)
  if(rarity === "ìœ ì¼" && uniqueMonsterName) {
    let uniqPrefix = uniqueMonsterPrefixes[uniqueMonsterName] || "ìœ ì¼";
    let baseName = baseObj.name;
    let name = `${uniqPrefix}ì˜ ${baseName}`;
    let skill = "";
    if(itemAttackType && skillPool[itemAttackType])
      skill = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
    let stat = [];
    let sconf = itemStatTable["ìœ ì¼"];
    for(let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
    let atk = itemAttackType === "ê·¼ì ‘" ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let ratk= itemAttackType === "ì›ê±°ë¦¬"? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let matk= itemAttackType === "ë§ˆë²•"  ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    stat.push(atk); stat.push(ratk); stat.push(matk);
    return {
      name, rarity: "ìœ ì¼", slot, stat, type: baseName, attackType: itemAttackType,
      skill, enh: 0, ilv: null, unique: true, uniqPrefix
    };
  }
  // ì¼ë°˜~ë ˆì „ë”ë¦¬ ì•„ì´í…œ
  let prefix = prefixes[rint(0,prefixes.length-1)];
  let suffix = suffixes[rint(0,suffixes.length-1)];
  let name = `${prefix} ${suffix}ì˜ ${itemType}`;
  let skill = null, skillBase = null, skillBonus=1, trigger = skillTriggerRate[rarity] || 0.05;
  if (itemAttackType && skillPool[itemAttackType]) {
    let chance = skillGiveRate[rarity] || 0.1;
    if(Math.random() < chance) {
      skillBase = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
      skill = prefix ? `${prefix} ${skillBase}` : skillBase;
      if(prefix && prefix.includes("ë¶ˆíƒ€ëŠ”")) skillBonus = 1.2;
    }
  }
  let stat = [];
  let sconf = itemStatTable[rarity];
  for (let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
  let atk=0, ratk=0, matk=0;
  if(itemAttackType=="ê·¼ì ‘") atk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="ì›ê±°ë¦¬") ratk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="ë§ˆë²•") matk = rint(sconf.atk[0],sconf.atk[1]);
  stat.push(Math.floor(atk * skillBonus));
  stat.push(Math.floor(ratk * skillBonus));
  stat.push(Math.floor(matk * skillBonus));
  // ë°©ì–´êµ¬ ìŠ¤í‚¬ ë¶€ì—¬ (ë°©ì–´êµ¬ë§Œ, ë¬´ê¸°/ë°©íŒ¨/ìœ ì¼ ì œì™¸)
  let armorSkill = null;
  if (["ë¨¸ë¦¬","ìƒì˜","í•˜ì˜","ì†","ì‹ ë°œ"].includes(slot) && rarity !== "ìœ ì¼" && Math.random()<0.40) {
    let armorSkillPool = [
      { name: "ìƒëª…íšŒë³µ",     type: "regen",      base: [1, 2]  },
      { name: "í”¼í•´í¡í˜ˆ",     type: "leech",      base: [1, 2]  },
      { name: "ë°›ëŠ”í”¼í•´ê°ì†Œ", type: "dmgreduce",  base: [2, 4]  },
      { name: "ì²«í”¼ê²©ë¬´ì‹œ",   type: "ignorehit",  base: [1, 1]  },
      { name: "ì‚¬ë§ë°©ì§€",     type: "deathproof", base: [1, 1]  },
      { name: "ê³µê²©ë°˜ì‚¬",     type: "reflect",    base: [2, 3]  },
      { name: "íšŒí”¼ì¦ê°€",     type: "evadeup",    base: [3, 4]  },
      { name: "ì‹¤ë“œë¶€ì—¬",     type: "shield",     base: [20, 24]}
    ];
    let skillObj = armorSkillPool[rint(0, armorSkillPool.length-1)];
    let scale = armorSkillEffectScale[rarity] || 1;
    let val = rint(skillObj.base[0]*scale, skillObj.base[1]*scale);
    armorSkill = { name: skillObj.name, type: skillObj.type, value: val };
  }
  return {
    name: name, rarity: rarity, slot: slot, stat: stat, type: itemType,
    attackType: itemAttackType, skill: skill, skillBase: skillBase, skillBonus: skillBonus,
    skillTrigger: trigger, enh: 0, ilv: null, unique: false, armorSkill
  };
}

// ====== ì‚¬ëƒ¥/ë˜ì „ ë²„íŠ¼ ë™ì‘ ======
function action(type){
  // HPê°€ 1ì¼ ë•ŒëŠ” ì‚¬ëƒ¥, ë˜ì „ ëª¨ë‘ ë¶ˆê°€
  if(user.hp <= 1){
    log("<span class='dead-log'>HPê°€ 1ì¼ ë•ŒëŠ” ì „íˆ¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ì—¬ê´€ì—ì„œ íšŒë³µí•˜ì„¸ìš”.</span>");
    return;
  }
  battle(type);
}
function dungeonEnterUI() {
  log(`<b>[ë˜ì „ ì…ì¥]</b><br>
  <span style="color:#ffd700;">ë˜ì „ì—ì„œ ì£½ìœ¼ë©´ í™•ë¥ ì ìœ¼ë¡œ ì¥ë¹„ë¥¼ ìƒì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span><br><br>
  <button class="inv-btn" onclick="dungeonAction()">ì…ì¥í•˜ê¸°</button>
  <button class="inv-btn" onclick="showChar()">ì·¨ì†Œ</button>`);
}
function dungeonAction(){ battle("dungeon"); }

// ====== ì „íˆ¬ ======
function battle(type) {
  let isDungeon = (type === "dungeon");
  let monster = makeMonster(user.level, isDungeon);
  let userhp = { val: user.hp };
  let monhp = monster.hp + (isDungeon ? rint(5,18) : 0);
  let battleLog = [];
  let weapon = user.equip["ë¬´ê¸°"];
  let myATK = weapon ? (
    (weapon.attackType=="ê·¼ì ‘") ? (weapon.stat[5]||4) :
    (weapon.attackType=="ì›ê±°ë¦¬") ? (weapon.stat[6]||3) :
    (weapon.attackType=="ë§ˆë²•") ? (weapon.stat[7]||3) : 2
  ) : 2;
  myATK += user.stats[0] || 0;
  let myDEF = user.stats[3] || 0;
  let setBonusKey = checkUniqueSetBonus();
  let hasGwanghui = setBonusKey === "ê´‘íœ˜";
  let rebirthUsed = false;
  let maxTurn = 10;
  let shieldObj = { reducePct:0, reflectPct:0, evadeAdd:0, shield:0, skillRed:0 };
  let skillTurn = [], finalSkillMsg = "";
  let turn;
  for(turn=1; turn<=maxTurn && userhp.val>0 && monhp>0; turn++) {
    let attacksThisTurn = 1;
    if(hasGwanghui) attacksThisTurn += 1;
    let dexChance = Math.min(user.stats[1]/9999 * 0.7, 0.7);
    let dexExtra = (Math.random() < dexChance) ? 1 : 0;
    if(dexExtra) attacksThisTurn += 1;
    for(let atkNum=0; atkNum<attacksThisTurn; atkNum++) {
      let effects = [];
      let dmg = rint(myATK-2, myATK+3);
      let isStrong = (Math.random() < Math.min(user.stats[0]/9999 * 0.7, 0.7));
      if(isStrong) { dmg = dmg * 2; effects.push(`<span class="skill-log">ğŸ’¥ [í˜: ê°•ê³µê²©]</span>`);}
      let isSkill = weapon && weapon.skill && Math.random() < (weapon.skillTrigger||0);
      if(isSkill) {
        dmg = Math.floor(dmg*1.8) + rint(1,5);
        skillTurn.push(turn);
        finalSkillMsg = `[ìŠ¤í‚¬ ë°œë™] ${weapon.skill}ë¡œ ê°•ë ¥í•œ ì¼ê²©!`;
        effects.push(`<span class="skill-log">ğŸ”¥ [ë¬´ê¸°ìŠ¤í‚¬: ${weapon.skill}]</span>`);
      }
      monhp -= dmg;
      if(monhp < 0) monhp = 0;
      battleLog.push(`<b>[${turn}í„´ ê³µê²©${atkNum+1}]</b> ${effects.join(" ")}<span style="font-weight:bold;">${user.name}ì˜ ê³µê²©!</span> <span class="dmg-log">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}ì—ê²Œ ${dmg}ì˜ í”¼í•´</span> (ëª¬ìŠ¤í„° HP:${Math.max(monhp,0)})`);
      if(monhp <= 0) break;
    }
    if(monhp <= 0) break;
    // ëª¬ìŠ¤í„° ê³µê²©
    let monsterDmg = { val: Math.max(1, monster.atk - rint(Math.floor(myDEF/2), myDEF+1)) };
    userhp.val -= monsterDmg.val;
    battleLog.push(`${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}ì˜ ê³µê²©! <span class="dmg-log">${user.name}ì—ê²Œ ${monsterDmg.val} í”¼í•´</span> (ë‚´ HP:${Math.max(userhp.val,0)})`);
    if(userhp.val <= 0) { userhp.val = 0; break; }
  }
  turn--;
  let win = (monhp<=0 && turn<=maxTurn);
  if(turn>maxTurn) win = false;
  let baseExp = isDungeon ? Math.floor(user.level*4)+rint(16,32) : Math.floor(user.level*1.7)+rint(6,16);
  let baseGold = isDungeon ? rint(32,80)+Math.floor(user.level*4.2) : rint(10,20)+Math.floor(user.level*1.4);
  let hpLoss = user.hp-userhp.val;
  let rewardMsg = "";
  if(win){
    let gain = baseExp; let gold = baseGold; let dropMsg = "", stoneMsg="";
    if (Math.random() < (isDungeon?0.5:0.25)) {
      let item = makeItem(isDungeon, false, monster.unique ? monster.name : null);
      if (addInv(item)) dropMsg = `<br>ì•„ì´í…œ íšë“! ${itemDisplay(item)}`;
    }
    if(Math.random()<(isDungeon?0.15:0.10)){
      user.stones=(user.stones||0)+1;
      stoneMsg=`<br><span style="color:#77e;">ê°•í™”ì„ 1ê°œë¥¼ íšë“í–ˆë‹¤!</span>`;
    }
    user.exp += gain; user.gold += gold;
    user.hp = Math.max(1,userhp.val);
    let setBonusDesc = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} ì„¸íŠ¸ íš¨ê³¼: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
    rewardMsg = `<br><b>ìŠ¹ë¦¬!</b> ê²½í—˜ì¹˜ +${gain}, ê³¨ë“œ +${gold}, HP -${hpLoss}${finalSkillMsg?`<br><span class="skill-log">${finalSkillMsg}</span>`:""}${setBonusDesc}${dropMsg}${stoneMsg}`;
    levelupCheck();
  } else {
    user.hp = userhp.val; if(userhp.val<=0) user.hp=1;
    rewardMsg = `<br><span class="dead-log">íŒ¨ë°°! 10í„´ ì´ˆê³¼ í˜¹ì€ ëª¬ìŠ¤í„°ì—ê²Œ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤. HP ${userhp.val<=0?'1ë¡œ ë³µêµ¬':`(${userhp.val})`}.</span>`;
    if(isDungeon && userhp.val<=0){
      let lost = [];
      if(Math.random()<0.2){
        let candidates = equipSlots.filter(s=>user.equip[s]);
        if(candidates.length){
          let lostSlot = candidates[rint(0,candidates.length-1)];
          let lostItem = user.equip[lostSlot];
          user.equip[lostSlot] = undefined; lost.push(lostItem.name);
        }
      }
      if(lost.length) rewardMsg += `<br><span class="dead-log">[ì¥ë¹„ ì†ì‹¤] ${lost.join(", ")}</span>`;
    }
  }
  log(`[${isDungeon?'ë˜ì „':'ì‚¬ëƒ¥'}] <span class="monname">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}</span>ê³¼ì˜ í„´ì œ ì „íˆ¬ (ìµœëŒ€ 10í„´)<br>` + battleLog.join("<br>") + rewardMsg);
  updateUser();
}
function levelupCheck(){
  while(user.exp>=expNeed(user.level) && user.level<999){
    user.exp -= expNeed(user.level);
    user.level++;
    statRandAdd(user.stats);
    user.maxhp += 5+rint(0,5);
    user.hp = user.maxhp;
    log(`[LEVEL UP!] Lv.${user.level}ë¡œ ì˜¬ëìŠµë‹ˆë‹¤!`);
  }
}
function statRandAdd(stats){
  let idx = rint(0,stats.length-1);
  stats[idx]++;
}
</script>
</body>
</html>

