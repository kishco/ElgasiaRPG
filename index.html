<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Elgasia RPG ver1.06</title>
  <style>
    body { background: #181828; color: #fff; margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif;}
    #mainwrap { max-width: 1500px; margin: 30px auto; display: flex; flex-direction: column; gap: 25px;}
    .rowflex { display: flex; flex-direction: row; gap: 30px; }
    #chatbox { background: #3c3c5a; border-radius: 28px; min-width: 340px; width: 340px; min-height: 420px; display: flex; align-items: center; justify-content: center; }
    #chatbox iframe { border-radius: 20px; border: none; width: 95%; height: 90%; min-height: 410px; }
    #stat-content-box { background: #191934; border-radius: 28px; flex: 1; min-width: 430px; padding: 32px 0 32px 0; min-height: 420px; display: flex; align-items: flex-start; justify-content: center;}
    #stat-content { width: 90%; }
    #sidebar { background: #191934; border-radius: 28px; min-width: 270px; width: 270px; padding: 24px 0; display: flex; flex-direction: column; gap: 15px; align-items: center;}
    .sidebtn { width: 200px; padding: 16px 0; font-size: 20px; border-radius: 12px; border: 2px solid #353575; background: #2e2e6e; color: #fff; margin-bottom: 6px; font-weight: bold; cursor: pointer; transition: background 0.13s;}
    .sidebtn:hover { background: #383890;}
    #battle-log-box { background: #161625; border-radius: 16px; min-height: 130px; margin: 0 0 0 0; }
    #battle-log { min-height: 130px; padding: 22px 28px; font-size: 18px; }
    /* 기타 스타일 */
    .equipitem, .shop-item { margin:8px 0; padding:10px 12px; border-radius:8px; background: #21214a; }
    .inv-btn { margin-left: 8px; background: #384085; color: #fff; border: none; border-radius: 5px; padding: 2px 9px; font-size: 14px;}
    .inv-btn:disabled { color: #888;}
    .shop-title { color:#ffe680; font-size: 21px; margin-bottom:10px;}
    .succ-msg { color:#8aff8a; font-weight:bold;}
    .fail-msg { color:#ff6161; font-weight:bold;}
    .dead-log { color:#fa4247; font-weight:bold;}
    .set-bonus { color: #ffe161; font-weight: bold;}
    .monname { color:#ffd700; font-weight:bold;}
    .unique-monster { color:#ff5555; font-weight:bold;}
    .stat-box { margin-bottom: 28px; font-size: 18px;}
    .stat-box span { display: inline-block; margin-right: 18px; }
    /* 스크롤바 커스텀 */
    ::-webkit-scrollbar {width:8px;}
    ::-webkit-scrollbar-thumb {background:#333;border-radius:6px;}
    ::selection { background: #384085; color:#fff; }
  </style>
</head>
<body>
  <div id="mainwrap">
    <div class="rowflex">
      <!-- 왼쪽 채팅 -->
      <div id="chatbox">
        <iframe src="https://tlk.io/elasiarpg" allowtransparency="true"></iframe>
      </div>
      <!-- 중앙 스탯/내용 -->
      <div id="stat-content-box">
        <div id="stat-content">게임을 불러와주세요.</div>
      </div>
      <!-- 오른쪽 UI 버튼 -->
      <div id="sidebar">
        <button class="sidebtn" onclick="action('hunt')">사냥</button>
        <button class="sidebtn" onclick="dungeonEnterUI()">던전</button>
        <button class="sidebtn" onclick="showChar()">스탯/장비</button>
        <button class="sidebtn" onclick="showInv()">소지품</button>
        <button class="sidebtn" onclick="showTown()">마을</button>
        <button class="sidebtn" onclick="saveGame()">세이브</button>
        <button class="sidebtn" onclick="showLoad()">불러오기</button>
      </div>
    </div>
    <!-- 하단 전투로그 -->
    <div id="battle-log-box">
      <div id="battle-log">불러올 슬롯을 선택하세요.</div>
    </div>
  </div>
<script>
/* ========== 전역 데이터/상수/유틸 ========== */
let user = null, saveSlot = 1;

function rint(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

const statNames = ["STR", "DEX", "INT", "VIT", "LUK"];
const equipSlots = ["머리", "상의", "하의", "손", "신발", "무기", "방패"];
const itemStatTable = {
  "일반":     { base:[0, 2],    atk:[1, 3]   },
  "레어":     { base:[2, 4],    atk:[3, 6]   },
  "유니크":   { base:[4, 7],    atk:[6, 10]  },
  "에픽":     { base:[7, 11],   atk:[10, 15] },
  "레전더리": { base:[12, 18],  atk:[16, 22] },
  "유일":     { base:[18, 27],  atk:[25, 35] }
};
const armorSkillEffectScale = {
  "일반":     1,
  "레어":     1,
  "유니크":   1.2,
  "에픽":     1.5,
  "레전더리": 2,
  "유일":     3
};
const prefixes = ["불타는", "신속한", "고대의", "빛나는", "강인한", "재빠른", "현자의", "암흑의", "단단한", "용맹한"];
const suffixes = ["광기", "지혜", "속도", "행운", "힘", "수호", "파멸", "마법", "불멸", "용기"];
const rarityOrder = ["일반","레어","유니크","에픽","레전더리","유일"];
const rarityColors = { "일반":"equip-normal", "레어":"equip-rare", "유니크":"equip-unique", "에픽":"equip-epic", "레전더리":"equip-legend", "유일":"equip-myth" };
const rarityRate = [60,20,5,1,0.01,0];
const dungeonRate = [45,25,10,6,1,0.1];
const inventoryLimit = 40;
const skillTriggerRate = { "일반": 0.02, "레어": 0.04, "유니크": 0.07, "에픽": 0.10, "레전더리": 0.15, "유일": 0.33 };
const skillGiveRate = { "일반": 0.02, "레어": 0.06, "유니크": 0.10, "에픽": 0.18, "레전더리": 0.25, "유일": 1.0 };
const armorSkillTriggerRate = {"일반": 0.03, "레어": 0.05, "유니크": 0.07, "에픽": 0.10, "레전더리": 0.13, "유일": 0.17};
const slotTypePool = {
  "무기": [
    {name:"검",type:"근접"}, {name:"도끼",type:"근접"}, {name:"창",type:"근접"}, {name:"레이피어",type:"근접"},
    {name:"대검",type:"근접"}, {name:"양손도끼",type:"근접"},
    {name:"활",type:"원거리"}, {name:"석궁",type:"원거리"}, {name:"총",type:"원거리"},
    {name:"원드",type:"마법"}, {name:"스태프",type:"마법"}, {name:"듀얼건",type:"마법"}
  ],
  "방패": [{name:"방패",type:"방어"}],
  "머리": [{name:"투구"},{name:"모자"},{name:"두건"}],
  "상의": [{name:"갑옷"},{name:"로브"},{name:"자켓"}],
  "하의": [{name:"바지"},{name:"레깅스"}],
  "신발": [{name:"부츠"},{name:"신발"},{name:"장화"}],
  "손": [{name:"장갑"},{name:"반지"}]
};
const skillPool = {
  "근접": ["회전베기", "지진강타", "광역참격", "참격", "돌진베기"],
  "원거리": ["연속사격", "관통화살", "저격", "폭발화살", "집중사격"],
  "마법": ["파이어볼", "아이스스톰", "체인라이트닝", "암흑구", "에너지블래스트"]
};
const monsterPrefixes = ["불타는", "사나운", "거대한", "날카로운", "암흑의", "빙결의", "광기의", "번개의", "독기의", "죽음의"];
const monsterNames = [
  "그림자 멧돼지", "빙결 슬라임", "불사른 해골기사", "지옥박쥐", "돌연변이 늑대",
  "암흑의 고블린", "광기의 오우거", "서리골렘", "불꽃 와이번", "죽음의 리치",
  "혼돈의 미노타우르스", "맹독 스콜피온", "무쇠 곰", "흉포한 늑대", "독사",
  "어둠의 암살자", "광포한 곰", "고대의 골렘", "날렵한 팬서", "저주받은 해골전사"
];
const uniqueMonsters = [
  "광휘룡 벨리오로스", "흑섬룡 아벨리오스", "수암룡 타나로토스", "암토룡 우로보로스"
];
const uniqueMonsterPrefixes = {
  "광휘룡 벨리오로스": "광휘",
  "흑섬룡 아벨리오스": "흑섬",
  "수암룡 타나로토스": "수암",
  "암토룡 우로보로스": "토암"
};
const uniqueSetBonus = {
  "광휘": { name: "광휘 세트", desc: "1턴 2회 공격" },
  "흑섬": { name: "흑섬 세트", desc: "공격 시 30% 확률로 1턴 스턴" },
  "수암": { name: "수암 세트", desc: "피격 시 40% 확률로 50% 반사" },
  "토암": { name: "토암 세트", desc: "전투 중 1회 사망 시 50% 부활" }
};

function updateStatBox(html) { document.getElementById("stat-content").innerHTML = html; }
function log(msg) { document.getElementById("battle-log").innerHTML = msg; }

// ====== 게임 진입시 세이브 슬롯 선택 ======
window.onload = function() { renderSaveSlotSelect(); }
function renderSaveSlotSelect() {
  let html = `<div class="save-slot-select"><b>불러올 슬롯을 선택하세요</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `슬롯${i} (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `슬롯${i} (새 시작)`;
    html += `<div style="margin-bottom:8px;display:flex;align-items:center;">
      <button class="inv-btn" onclick="startGame(${i})">${btnText}</button>
      <button class="inv-btn" onclick="deleteSaveSlot(${i})" style="background:#d36c6c;">삭제</button>
    </div>`;
  }
  html += `</div>`;
  updateStatBox(html);
  log("불러올 슬롯을 선택하세요.");
}
function deleteSaveSlot(slot) {
  if(confirm(`정말로 슬롯${slot}의 저장 데이터를 삭제하시겠습니까? 복구할 수 없습니다.`)){
    localStorage.removeItem("elgasia_save_"+slot);
    renderSaveSlotSelect();
  }
}
function startGame(slot) {
  saveSlot = slot;
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data); if(!user.storage) user.storage=[];
    showMainUI();
    updateUser();
    log(`<span style='color:#aff'>불러오기 완료! 슬롯 ${slot}</span>`);
  } else {
    user = {
      name: "용사", level: 1, exp: 0, rebirth: 0, gold: 100,
      stats: [1,1,1,1,1], statmax: 9999, hp: 30, maxhp: 30,
      equip: {}, inv: [], town: {restcount:0,skillstone:1}, stones: 0, storage: []
    };
    showMainUI();
    updateUser();
    log(`<b>환영합니다! 캐릭터 이름을 먼저 정해주세요.</b> <br><div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="캐릭터 이름"/><button class="inv-btn" onclick="setCharName()">확인</button></div>`);
  }
}
function setCharName() {
  let n = document.getElementById("newname").value.trim();
  if (!n) { alert("이름을 입력해주세요."); return; }
  user.name = n;
  updateUser();
  log(`이름이 <b>${n}</b>으로 설정되었습니다!`);
  saveGame();
}
function showLoad() { renderSaveSlotSelect(); }

function showMainUI() { // 중앙 내용 다시 stat-content만 쓰도록
  showChar();
}
</script>
<script>
/* ==== 기존 코드와 100% 연동 ==== */

// 스탯, 정보, 장비창
function updateUser() {
  if (!user.storage) user.storage = [];
  let statLabel = ["STR(근력)", "DEX(민첩)", "INT(지능)", "VIT(체력)", "LUK(운)"];
  let baseStats = user.stats.slice();
  let equipStats = user.stats.slice();
  let addATK = 0, addRATK = 0, addMATK = 0, addDEF = 0;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if (eq && eq.stat) {
      for (let i = 0; i < 5; i++) equipStats[i] += eq.stat[i] || 0;
      addATK += eq.stat[5] || 0;
      addRATK += eq.stat[6] || 0;
      addMATK += eq.stat[7] || 0;
      addDEF += eq.stat[3] || 0;
    }
  }
  let totalATK = addATK + equipStats[0];
  let totalRATK = addRATK + equipStats[1];
  let totalMATK = addMATK + equipStats[2];
  let totalDEF = equipStats[3];
  let baseStr = baseStats.map((v, i) => `${statLabel[i]}: ${v}`).join(" / ");
  let equipStr = equipStats.map((v, i) => `${statLabel[i]}: ${v}`).join(" / ");
  let eqhtml = "";
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if (eq) {
      eqhtml += `<div><b>${slot}:</b> ${itemDisplay(eq)}
      <button class="inv-btn" onclick="unequip('${slot}')">해제</button></div>
      ${eq.skill ? `<div class="equip-bonus">스킬: ${eq.skill}</div>` : ""}`;
    } else {
      eqhtml += `<div><b>${slot}:</b> <span style="color:#888">비어있음</span></div>`;
    }
  }
  let setBonusKey = checkUniqueSetBonus();
  let setBonusMsg = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} 세트 효과: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
  let html = `<div class="stat-box">
    <span>이름 <b>${user.name}</b> <button class="inv-btn" onclick="promptNameChange()">변경</button></span>
    <span>레벨 <b>${user.level}</b></span>
    <span>경험치 <b>${user.exp}/${expNeed(user.level)}</b></span>
    <span>골드 <b>${user.gold}</b></span>
    <span>HP <b>${user.hp}/${user.maxhp}</b></span>
    <span>강화석 <b>${user.stones || 0}</b></span>
    <span>창고 <b>${user.storage.length}/100</b></span>
  </div>
  <b>기본 스탯:</b> ${baseStr}<br>
  <b>장비 적용:</b> ${equipStr}<br>
  <b>[공격/방어]</b> ATK(근접): <b>${totalATK}</b> / RATK(원거리): <b>${totalRATK}</b> / MATK(마법): <b>${totalMATK}</b> / DEF: <b>${totalDEF}</b><br>
  <b>HP:</b> ${user.hp}/${user.maxhp}<br>
  <b>장착장비</b><br>${eqhtml}${setBonusMsg}`;
  updateStatBox(html);
}
function showChar() { updateUser(); }
function promptNameChange() {
  let n = prompt("새 캐릭터 이름을 입력하세요", user.name || "");
  if (!n) return;
  user.name = n;
  updateUser(); saveGame();
}
function expNeed(lv) { return Math.floor(Math.pow(lv, 1.5) * 12) + lv * 8; }
function checkUniqueSetBonus() {
  const armorSlots = ["머리", "상의", "하의", "손", "신발"];
  let found = { 광휘: 0, 흑섬: 0, 수암: 0, 토암: 0 };
  for (let slot of armorSlots) {
    let eq = user.equip[slot];
    if (eq && eq.rarity === "유일") {
      let pre = eq.uniqPrefix || (eq.name.split("의")[0]);
      if (found[pre] !== undefined) found[pre]++;
    }
  }
  for (let key in found) if (found[key] >= 4) return key;
  return null;
}
function unequip(slot) {
  if (!user.equip[slot]) return;
  addInv(user.equip[slot]);
  user.equip[slot] = undefined;
  showChar();
}
function saveGame() {
  if (!user) return;
  localStorage.setItem("elgasia_save_" + saveSlot, JSON.stringify(user));
  log(`<span style='color:#aaf'>슬롯 ${saveSlot}에 저장되었습니다!</span>`);
}

// ================= 소지품/창고 ==================
function itemDisplay(item) {
  return `<span class="${rarityColors[item.rarity]}">[${item.rarity}]</span> ${item.name} <span class="equip-bonus">STR:${item.stat[0]} DEX:${item.stat[1]} INT:${item.stat[2]} VIT:${item.stat[3]} LUK:${item.stat[4]} ${item.attackType === "근접" ? `ATK:${item.stat[5]}` : ""}${item.attackType === "원거리" ? `RATK:${item.stat[6]}` : ""}${item.attackType === "마법" ? `MATK:${item.stat[7]}` : ""}</span> ${item.skill ? `<span class="equip-bonus">스킬:${item.skill}</span>` : ""}${item.armorSkill ? ` <span class="equip-bonus">방어구스킬:${item.armorSkill.name}(+${typeof item.armorSkill.value === "number" ? item.armorSkill.value.toFixed(1) : item.armorSkill.value})</span>` : ""}${item.enh ? ` <span class="enh-lv">+${item.enh}</span>` : ""}`;
}
function showInv() {
  let invhtml = "";
  user.inv.forEach((item, i) => {
    invhtml += `<div class="equipitem">${itemDisplay(item)}
      <button class="inv-btn" onclick="equipItem(${i})">착용</button>
      <button class="inv-btn" onclick="sellInv(${i})">판매</button></div>`;
  });
  if (!invhtml) invhtml = "<div style='color:#888'>소지품이 없습니다.</div>";
  let html = `<b>[소지품]</b> (${user.inv.length}/${inventoryLimit})<br>${invhtml}<br>
    <button class="inv-btn" onclick="sellAllInv()">전체 판매 (착용 제외)</button><br>
    <button class="inv-btn" onclick="showChar()">돌아가기</button>`;
  updateStatBox(html);
}
function equipItem(idx) {
  let item = user.inv[idx];
  if (!item || !item.slot || equipSlots.indexOf(item.slot) === -1) return;
  if (user.equip[item.slot]) addInv(user.equip[item.slot]);
  user.equip[item.slot] = item;
  user.inv.splice(idx, 1);
  showInv(); updateUser();
}
function sellInv(idx) {
  let item = user.inv[idx];
  let sellValue = 5 + (rarityBonus(item.rarity) * 10);
  user.gold += sellValue;
  user.inv.splice(idx, 1);
  log(`${itemDisplay(item)}<br><span style="color:#ffe55e">${sellValue}G에 판매되었습니다!</span><br><button class="inv-btn" onclick="showInv()">돌아가기</button>`);
  updateUser();
}
function sellAllInv() {
  if (user.inv.length === 0) { log("판매할 아이템이 없습니다."); return; }
  let totalGold = 0;
  let soldNames = [];
  let filteredInv = user.inv.filter(item => {
    for (let slot of equipSlots) {
      if (user.equip[slot] && user.equip[slot].name === item.name) return false;
    }
    return true;
  });
  if (filteredInv.length === 0) { log("판매할 아이템이 없습니다. (착용 중 아이템 제외)"); return; }
  filteredInv.forEach(item => {
    let idx = user.inv.indexOf(item);
    if (idx >= 0) user.inv.splice(idx, 1);
    let sellValue = 5 + (rarityBonus(item.rarity) * 10);
    totalGold += sellValue;
    soldNames.push(item.name);
  });
  user.gold += totalGold;
  log(`착용 중이 아닌 모든 아이템 판매 완료! 총 ${totalGold}골드를 얻었다.<br>판매한 아이템: ${soldNames.join(", ")}<br><button class="inv-btn" onclick="showInv()">소지품으로 돌아가기</button>`);
  updateUser();
}
function addInv(item) {
  if (user.inv.length >= inventoryLimit) { log("소지품이 가득 찼다!"); return false; }
  user.inv.push(item); return true;
}
function rarityBonus(r) {
  if (r == "일반") return 0; if (r == "레어") return 1; if (r == "유니크") return 2;
  if (r == "에픽") return 3; if (r == "레전더리") return 4; if (r == "유일") return 5;
  return 0;
}

// ====================== 마을, 상점, 강화 =====================
function showTown() {
  let html = `<b>[마을]</b><br>
    <button class="inv-btn" onclick="innRest()">여관(휴식)</button>
    <button class="inv-btn" onclick="showShop()">장비상점</button>
    <button class="inv-btn" onclick="showEnhance()">강화소</button>
    <button class="inv-btn" onclick="showChar()">돌아가기</button>`;
  updateStatBox(html);
}
function innRest() {
  let cost = 20 + user.level * 5;
  if (user.gold < cost) { log("골드가 부족합니다."); return; }
  user.gold -= cost; user.hp = user.maxhp;
  log(`여관에서 휴식 후 HP 전부 회복! (${cost}골드 소모)<br><button class='inv-btn' onclick='showTown()'>돌아가기</button>`);
  updateUser();
}
function showShop() {
  let items = [];
  for (let i = 0; i < 5; i++) items.push(makeItem(false, true));
  let html = `<div class="shop-title">[장비 상점] (에픽 등급 이상은 미출현)</div>`;
  items.forEach((item, idx) => {
    html += `<div class="shop-item">${itemDisplay(item)}
      <button class="inv-btn" onclick="buyShopItem(${idx})">구매 (${50 + user.level * 8}G)</button></div>`;
  });
  html += `<br><button class="inv-btn" onclick="showTown()">돌아가기</button>`;
  updateStatBox(html); window.shopItems = items;
}
function buyShopItem(idx) {
  let item = window.shopItems[idx];
  let cost = 50 + user.level * 8;
  if (user.gold < cost) { log("골드가 부족합니다."); return; }
  if (user.inv.length >= inventoryLimit) { log("소지품이 가득 찼다!"); return; }
  user.gold -= cost;
  user.inv.push(item);
  log(`구매 완료!<br>${itemDisplay(item)}<br><button class="inv-btn" onclick="showShop()">상점으로</button>`);
  updateUser();
}
function showEnhance() {
  let html = `<div class="shop-title">[장비 강화]</div>`;
  let equips = Object.values(user.equip).filter(e => e);
  if (!equips.length) {
    html += `<div style="color:#888">강화할 장비가 없습니다.</div>`;
  } else {
    equips.forEach((eq, idx) => {
      html += `<div class="shop-item">${itemDisplay(eq)}<button class="inv-btn" onclick="enhanceItem('${eq.slot}')">강화</button></div>`;
    });
  }
  html += `<br><button class="inv-btn" onclick="showTown()">돌아가기</button>`;
  updateStatBox(html);
}
function enhanceItem(slot) {
  let eq = user.equip[slot];
  if (!eq) return;
  let lv = eq.enh || 0;
  if (lv >= 20) { log("최대 강화 단계입니다."); return; }
  let needStone = lv < 5 ? [1, 2, 4, 8, 20][lv] : lv < 10 ? 20 * Math.pow(2, lv - 4) : lv < 15 ? 60 * Math.pow(3, lv - 9) : 120 * Math.pow(4, lv - 14);
  let needGold = 100 + lv * 50;
  if (user.stones < needStone) { log("강화석이 부족합니다."); return; }
  if (user.gold < needGold) { log("골드가 부족합니다."); return; }
  let prob = lv < 4 ? 1 : lv < 10 ? 0.5 - (lv - 4) * 0.08 : lv < 15 ? 0.12 - (lv - 10) * 0.025 : 0.04 - (lv - 15) * 0.007;
  if (prob < 0.01) prob = 0.01;
  let succ = Math.random() < prob;
  user.stones -= needStone;
  user.gold -= needGold;
  if (succ) {
    eq.enh = lv + 1;
    if (eq.slot === "무기") {
      let atkIndex = 5;
      if (eq.attackType === "원거리") atkIndex = 6;
      else if (eq.attackType === "마법") atkIndex = 7;
      eq.stat[atkIndex] = (eq.stat[atkIndex] || 0) + rint(1, 3);
      log(`<span class="succ-msg">[+${eq.enh} 강화 성공! 주요 공격력이 상승했습니다!]</span> 골드 ${needGold}소모, 강화석 ${needStone}소모`);
    } else {
      let statIdx = rint(0, 4);
      eq.stat[statIdx] = (eq.stat[statIdx] || 0) + rint(1, 3);
      log(`<span class="succ-msg">[+${eq.enh} 강화 성공! 스탯이 랜덤으로 상승했습니다!]</span> 골드 ${needGold}소모, 강화석 ${needStone}소모`);
    }
  } else {
    log(`<span class="fail-msg">[강화 실패] 골드 ${needGold}소모, 강화석 ${needStone}소모</span>`);
  }
  updateUser();
  showEnhance();
}

// ====== 아이템 생성, 몬스터 생성, 전투, 사냥, 던전 ======
</script>
<script>
/* ==== 전투/던전/사냥/레벨업/몬스터/아이템 ==== */

// ==== 몬스터 생성 ====
function makeMonster(level, isDungeon = false) {
  if (isDungeon && Math.random() < 0.01) {
    let name = uniqueMonsters[rint(0, uniqueMonsters.length - 1)];
    let hp = Math.floor(40 + level * 4 + rint(10, 40));
    let atk = Math.floor(8 + level * 2 + rint(5, 10));
    let def = Math.floor(level / 6 + rint(2, 8));
    return { name, hp, atk, def, unique: true };
  }
  let prefix = monsterPrefixes[rint(0, monsterPrefixes.length - 1)];
  let nameBase = monsterNames[rint(0, monsterNames.length - 1)];
  let name = prefix + " " + nameBase;
  let hp = Math.floor(12 + level * 2.5 + rint(0, 4));
  let atk = Math.floor(3 + level * 0.8 + rint(0, 2));
  let def = Math.floor(level / 5 + rint(0, 1));
  return { name, hp, atk, def, unique: false };
}

// ==== 아이템 생성 ====
function makeItem(allowMyth, isShop, uniqueMonsterName = null) {
  let rate = allowMyth ? dungeonRate : rarityRate;
  let localRarityOrder = isShop ? ["일반","레어","유니크"] : rarityOrder;
  let localRate = isShop ? [70,25,5] : rate;
  let rarity = "일반";
  let r = Math.random() * 100, acc = 0;
  for (let i=0;i<localRate.length;i++) { acc += localRate[i]; if (r < acc) { rarity = localRarityOrder[i]; break; } }
  if(!uniqueMonsterName && rarity === "유일") rarity = "레전더리";
  if(uniqueMonsterName) rarity = "유일";
  let slot = equipSlots[rint(0, equipSlots.length-1)];
  let pool = slotTypePool[slot];
  let baseObj = pool[rint(0, pool.length-1)];
  let itemType = baseObj.name;
  let itemAttackType = baseObj.type || null;
  // 유일 아이템(이름/스탯/스킬 규칙 적용)
  if(rarity === "유일" && uniqueMonsterName) {
    let uniqPrefix = uniqueMonsterPrefixes[uniqueMonsterName] || "유일";
    let baseName = baseObj.name;
    let name = `${uniqPrefix}의 ${baseName}`;
    let skill = "";
    if(itemAttackType && skillPool[itemAttackType])
      skill = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
    let stat = [];
    let sconf = itemStatTable["유일"];
    for(let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
    let atk = itemAttackType === "근접" ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let ratk= itemAttackType === "원거리"? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let matk= itemAttackType === "마법"  ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    stat.push(atk); stat.push(ratk); stat.push(matk);
    return {
      name, rarity: "유일", slot, stat, type: baseName, attackType: itemAttackType,
      skill, enh: 0, ilv: null, unique: true, uniqPrefix
    };
  }
  // 일반~레전더리 아이템
  let prefix = prefixes[rint(0,prefixes.length-1)];
  let suffix = suffixes[rint(0,suffixes.length-1)];
  let name = `${prefix} ${suffix}의 ${itemType}`;
  let skill = null, skillBase = null, skillBonus=1, trigger = skillTriggerRate[rarity] || 0.05;
  if (itemAttackType && skillPool[itemAttackType]) {
    let chance = skillGiveRate[rarity] || 0.1;
    if(Math.random() < chance) {
      skillBase = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
      skill = prefix ? `${prefix} ${skillBase}` : skillBase;
      if(prefix && prefix.includes("불타는")) skillBonus = 1.2;
    }
  }
  let stat = [];
  let sconf = itemStatTable[rarity];
  for (let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
  let atk=0, ratk=0, matk=0;
  if(itemAttackType=="근접") atk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="원거리") ratk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="마법") matk = rint(sconf.atk[0],sconf.atk[1]);
  stat.push(Math.floor(atk * skillBonus));
  stat.push(Math.floor(ratk * skillBonus));
  stat.push(Math.floor(matk * skillBonus));
  // 방어구 스킬 부여 (방어구만, 무기/방패/유일 제외)
  let armorSkill = null;
  if (["머리","상의","하의","손","신발"].includes(slot) && rarity !== "유일" && Math.random()<0.40) {
    let armorSkillPool = [
      { name: "생명회복",     type: "regen",      base: [1, 2]  },
      { name: "피해흡혈",     type: "leech",      base: [1, 2]  },
      { name: "받는피해감소", type: "dmgreduce",  base: [2, 4]  },
      { name: "첫피격무시",   type: "ignorehit",  base: [1, 1]  },
      { name: "사망방지",     type: "deathproof", base: [1, 1]  },
      { name: "공격반사",     type: "reflect",    base: [2, 3]  },
      { name: "회피증가",     type: "evadeup",    base: [3, 4]  },
      { name: "실드부여",     type: "shield",     base: [20, 24]}
    ];
    let skillObj = armorSkillPool[rint(0, armorSkillPool.length-1)];
    let scale = armorSkillEffectScale[rarity] || 1;
    let val = rint(skillObj.base[0]*scale, skillObj.base[1]*scale);
    armorSkill = { name: skillObj.name, type: skillObj.type, value: val };
  }
  return {
    name: name, rarity: rarity, slot: slot, stat: stat, type: itemType,
    attackType: itemAttackType, skill: skill, skillBase: skillBase, skillBonus: skillBonus,
    skillTrigger: trigger, enh: 0, ilv: null, unique: false, armorSkill
  };
}

// ====== 사냥/던전 버튼 동작 ======
function action(type){
  // HP가 1일 때는 사냥, 던전 모두 불가
  if(user.hp <= 1){
    log("<span class='dead-log'>HP가 1일 때는 전투를 할 수 없습니다! 여관에서 회복하세요.</span>");
    return;
  }
  battle(type);
}
function dungeonEnterUI() {
  log(`<b>[던전 입장]</b><br>
  <span style="color:#ffd700;">던전에서 죽으면 확률적으로 장비를 잃을 수 있습니다.</span><br><br>
  <button class="inv-btn" onclick="dungeonAction()">입장하기</button>
  <button class="inv-btn" onclick="showChar()">취소</button>`);
}
function dungeonAction(){ battle("dungeon"); }

// ====== 전투 ======
function battle(type) {
  let isDungeon = (type === "dungeon");
  let monster = makeMonster(user.level, isDungeon);
  let userhp = { val: user.hp };
  let monhp = monster.hp + (isDungeon ? rint(5,18) : 0);
  let battleLog = [];
  let weapon = user.equip["무기"];
  let myATK = weapon ? (
    (weapon.attackType=="근접") ? (weapon.stat[5]||4) :
    (weapon.attackType=="원거리") ? (weapon.stat[6]||3) :
    (weapon.attackType=="마법") ? (weapon.stat[7]||3) : 2
  ) : 2;
  myATK += user.stats[0] || 0;
  let myDEF = user.stats[3] || 0;
  let setBonusKey = checkUniqueSetBonus();
  let hasGwanghui = setBonusKey === "광휘";
  let rebirthUsed = false;
  let maxTurn = 10;
  let shieldObj = { reducePct:0, reflectPct:0, evadeAdd:0, shield:0, skillRed:0 };
  let skillTurn = [], finalSkillMsg = "";
  let turn;
  for(turn=1; turn<=maxTurn && userhp.val>0 && monhp>0; turn++) {
    let attacksThisTurn = 1;
    if(hasGwanghui) attacksThisTurn += 1;
    let dexChance = Math.min(user.stats[1]/9999 * 0.7, 0.7);
    let dexExtra = (Math.random() < dexChance) ? 1 : 0;
    if(dexExtra) attacksThisTurn += 1;
    for(let atkNum=0; atkNum<attacksThisTurn; atkNum++) {
      let effects = [];
      let dmg = rint(myATK-2, myATK+3);
      let isStrong = (Math.random() < Math.min(user.stats[0]/9999 * 0.7, 0.7));
      if(isStrong) { dmg = dmg * 2; effects.push(`<span class="skill-log">💥 [힘: 강공격]</span>`);}
      let isSkill = weapon && weapon.skill && Math.random() < (weapon.skillTrigger||0);
      if(isSkill) {
        dmg = Math.floor(dmg*1.8) + rint(1,5);
        skillTurn.push(turn);
        finalSkillMsg = `[스킬 발동] ${weapon.skill}로 강력한 일격!`;
        effects.push(`<span class="skill-log">🔥 [무기스킬: ${weapon.skill}]</span>`);
      }
      monhp -= dmg;
      if(monhp < 0) monhp = 0;
      battleLog.push(`<b>[${turn}턴 공격${atkNum+1}]</b> ${effects.join(" ")}<span style="font-weight:bold;">${user.name}의 공격!</span> <span class="dmg-log">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}에게 ${dmg}의 피해</span> (몬스터 HP:${Math.max(monhp,0)})`);
      if(monhp <= 0) break;
    }
    if(monhp <= 0) break;
    // 몬스터 공격
    let monsterDmg = { val: Math.max(1, monster.atk - rint(Math.floor(myDEF/2), myDEF+1)) };
    userhp.val -= monsterDmg.val;
    battleLog.push(`${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}의 공격! <span class="dmg-log">${user.name}에게 ${monsterDmg.val} 피해</span> (내 HP:${Math.max(userhp.val,0)})`);
    if(userhp.val <= 0) { userhp.val = 0; break; }
  }
  turn--;
  let win = (monhp<=0 && turn<=maxTurn);
  if(turn>maxTurn) win = false;
  let baseExp = isDungeon ? Math.floor(user.level*4)+rint(16,32) : Math.floor(user.level*1.7)+rint(6,16);
  let baseGold = isDungeon ? rint(32,80)+Math.floor(user.level*4.2) : rint(10,20)+Math.floor(user.level*1.4);
  let hpLoss = user.hp-userhp.val;
  let rewardMsg = "";
  if(win){
    let gain = baseExp; let gold = baseGold; let dropMsg = "", stoneMsg="";
    if (Math.random() < (isDungeon?0.5:0.25)) {
      let item = makeItem(isDungeon, false, monster.unique ? monster.name : null);
      if (addInv(item)) dropMsg = `<br>아이템 획득! ${itemDisplay(item)}`;
    }
    if(Math.random()<(isDungeon?0.15:0.10)){
      user.stones=(user.stones||0)+1;
      stoneMsg=`<br><span style="color:#77e;">강화석 1개를 획득했다!</span>`;
    }
    user.exp += gain; user.gold += gold;
    user.hp = Math.max(1,userhp.val);
    let setBonusDesc = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} 세트 효과: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
    rewardMsg = `<br><b>승리!</b> 경험치 +${gain}, 골드 +${gold}, HP -${hpLoss}${finalSkillMsg?`<br><span class="skill-log">${finalSkillMsg}</span>`:""}${setBonusDesc}${dropMsg}${stoneMsg}`;
    levelupCheck();
  } else {
    user.hp = userhp.val; if(userhp.val<=0) user.hp=1;
    rewardMsg = `<br><span class="dead-log">패배! 10턴 초과 혹은 몬스터에게 쓰러졌습니다. HP ${userhp.val<=0?'1로 복구':`(${userhp.val})`}.</span>`;
    if(isDungeon && userhp.val<=0){
      let lost = [];
      if(Math.random()<0.2){
        let candidates = equipSlots.filter(s=>user.equip[s]);
        if(candidates.length){
          let lostSlot = candidates[rint(0,candidates.length-1)];
          let lostItem = user.equip[lostSlot];
          user.equip[lostSlot] = undefined; lost.push(lostItem.name);
        }
      }
      if(lost.length) rewardMsg += `<br><span class="dead-log">[장비 손실] ${lost.join(", ")}</span>`;
    }
  }
  log(`[${isDungeon?'던전':'사냥'}] <span class="monname">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}</span>과의 턴제 전투 (최대 10턴)<br>` + battleLog.join("<br>") + rewardMsg);
  updateUser();
}
function levelupCheck(){
  while(user.exp>=expNeed(user.level) && user.level<999){
    user.exp -= expNeed(user.level);
    user.level++;
    statRandAdd(user.stats);
    user.maxhp += 5+rint(0,5);
    user.hp = user.maxhp;
    log(`[LEVEL UP!] Lv.${user.level}로 올랐습니다!`);
  }
}
function statRandAdd(stats){
  let idx = rint(0,stats.length-1);
  stats[idx]++;
}
</script>
</body>
</html>

