<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Elgasia - Text RPG ver1.06</title>
  <style>
    body { font-family: 'Malgun Gothic', sans-serif; background: #232236; color: #fff; margin: 0; padding: 0;}
    #main { max-width: 900px; margin: 40px auto; background: #181828; padding: 30px; border-radius: 20px; box-shadow: 0 0 30px #0008;}
    .stat-box { margin: 12px 0 24px 0; }
    .stat-box span { display: inline-block; margin-right: 18px; font-size: 18px; }
    .btn-bar button { background: #384085; color: #fff; border: none; border-radius: 7px; margin: 4px; padding: 10px 20px; font-size: 17px; cursor: pointer; transition: background 0.15s;}
    .btn-bar button:disabled { background: #333; color: #aaa; cursor: not-allowed; }
    .equip-rare { color: #51cafc; } .equip-unique { color: #d76bff; }
    .equip-normal { color: #fff;}
.equip-epic {
  color: #ff90b5;
  font-weight: bold;
  text-shadow:
    0 0 8px #ff90b5,
    0 0 22px #f080c1,
    0 0 35px #ffe2f1;
  animation: epic-glow 1.5s infinite alternate;
}
@keyframes epic-glow {
  from { filter: brightness(1) drop-shadow(0 0 8px #ff90b5); }
  to   { filter: brightness(1.24) drop-shadow(0 0 14px #ff90b5) drop-shadow(0 0 25px #f080c1); }
}

.equip-legend {
  color: gold;
  font-weight: bold;
  text-shadow:
    0 0 12px #ffe161,
    0 0 32px #ffd966,
    0 0 44px #ffe161;
  animation: legend-glow 1.1s infinite alternate;
  letter-spacing: 1.1px;
}
@keyframes legend-glow {
  from { filter: brightness(1.08) drop-shadow(0 0 10px #ffe161); }
  to   { filter: brightness(1.33) drop-shadow(0 0 24px #ffd700) drop-shadow(0 0 32px #ffe161); }
}

.equip-myth {
  color: #b366ff;
  font-weight: bold;
  text-shadow:
    0 0 13px #d76bff,
    0 0 24px #a559f3,
    0 0 38px #b366ff;
  animation: myth-glow 1.4s infinite alternate;
  letter-spacing: 1.15px;
}
@keyframes myth-glow {
  from { filter: brightness(1.10) drop-shadow(0 0 11px #cdaaff); }
  to   { filter: brightness(1.38) drop-shadow(0 0 23px #b366ff) drop-shadow(0 0 27px #a559f3); }
}

.equip-inferno {
  color: #ff2424;
  font-weight: bold;
  font-size: 18px;
  letter-spacing: 1.4px;
  text-shadow:
    0 0 15px #fa2525,
    0 0 38px #ff2323,
    0 0 60px #ff3939,
    0 0 90px #ff6868;
  filter: brightness(1.28) drop-shadow(0 0 12px #ff6464);
  animation: doomglow 0.93s infinite alternate, inferno-blink 1.8s infinite alternate;
}
@keyframes doomglow {
  from { text-shadow: 0 0 26px #ff2323, 0 0 55px #ff6d6d; }
  to   { text-shadow: 0 0 45px #ff5656, 0 0 95px #ff2323; }
}
@keyframes inferno-blink {
  from { opacity: 0.96; }
  to   { opacity: 1; filter: brightness(1.39) drop-shadow(0 0 18px #ff2323); }
}
    .log { border: 1px solid #222; background: #191934; margin: 16px 0; border-radius: 10px; min-height: 120px; padding: 14px; font-size:17px;}
   .inv-btn {
  min-width: 74px;
  text-align: center;
  margin-right: 5px;
}
    .inv-btn:disabled { color: #888;}
.equipitem {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  padding: 3px 0 2px 0;
  margin: 2px 0;
  border-bottom: 1px solid #29293f;
  white-space: nowrap;
}
.equipitem.combine2row {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-bottom: 18px;
  border-bottom: 1px solid #29293f;
  padding-bottom: 7px;
  padding-top: 7px;
}
.combine-itembox {
  width: 100%;
  margin-bottom: 2px;
}
.combine-itembox:last-of-type {
  margin-bottom: 5px;
}
.combine-btnbox {
  width: 100%;
  display: flex;
  justify-content: flex-end;
  margin-top: 3px;
}
.item-btns {
  display: flex;
  gap: 6px;
  margin-left: 12px;
}
.equipitem .item-btns {
  display: flex;
  gap: 6px;
  margin-left: 12px;
}
.equip-bonus, .stat-label {
  color: #aaffb8;
  margin-left: 10px;
  font-size: 13px;
  font-weight: 400;
}

    .equip-bonus {font-size:14px;color:#b8ffad;}
    .namebox input { font-size:18px; padding:3px 8px; border-radius:7px; border:1px solid #555;}
    .save-bar button { background: #515b9d; color: #fff; border: none; border-radius: 6px; margin: 2px; padding: 7px 15px; font-size: 15px;}
    .save-slot-btn { background:#2e2e4e; color:#fff; margin:7px; padding:15px 30px; font-size:22px; border-radius:10px; border:none;}
    .shop-item { margin:8px 0; padding:12px; border-radius:10px; background: #21214a; box-shadow: 0 2px 8px #0003;}
    .shop-item .equip-bonus { color:#bbeeff; }
    .shop-title { color:#ffe680; font-size: 21px; margin-bottom:10px;}
    .enhance-btn { background: #1f8e26; color: #fff; margin-left:12px; border-radius:6px;}
    .fail-msg { color:#ff6161; font-weight:bold; }
    .succ-msg { color:#8aff8a; font-weight:bold; }
    .enh-lv {color: #ffe161; font-weight: bold; margin-left: 6px;}
    .monname { color:#ffd700; font-weight:bold;}
    .save-del-btn { background:#a23c3c; color:#fff; border-radius:7px; border:none; font-size:14px; padding:4px 14px; margin-left:8px;}
    .ilv-txt { color:#9ed1f7; font-weight:bold; margin-right:8px; }
    .skill-log { color:#ffea64; font-weight:bold; }
    .dmg-log { color:#fba; }
    .dead-log { color:#fa4247; font-weight:bold; }
    .unique-monster { color:#ff5555; font-weight:bold; }
     .set-bonus { color: #ffe161; font-weight: bold;}

  /* --- ì—¬ê¸°ë¶€í„° ë§ë¶™ì—¬ë¼ --- */
 #mainwrap {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}

#centerwrap {
  flex: 1.7;
  min-width: 480px;
  max-width: 900px;
  min-height: 300px;
  max-height: 700px;
  overflow-y: auto;
  background: #23223a;
  border-radius: 30px 0 0 30px;
  margin: 55px 0 55px 0;
  padding: 35px 40px 32px 45px;
  box-shadow: 0 4px 36px #10101965, 0 2px 18px #0008;
  display: flex;
  flex-direction: column;
}

#userinfo {
  margin-bottom: 24px;
  font-size: 18px;
  letter-spacing: 0.3px;
}

.log {
  border: 1.5px solid #2d2e43;
  background: #1c1c2f;
  border-radius: 18px;
  min-height: 110px;
  padding: 18px 22px;
  font-size: 17px;
  color: #f6f7ff;
  box-shadow: 0 1.5px 8px #0002;
  margin-bottom: 0;
  overflow-x: auto;
  word-break: break-all;
  white-space: pre-line;
}

#sidebar {
  flex: 0 0 240px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  background: linear-gradient(140deg, #262655 70%, #353565 100%);
  border-radius: 0 30px 30px 0;
  margin: 55px 0 55px 0;
  padding: 40px 26px 34px 16px;
  min-height: 520px;
  min-width: 200px;
  box-shadow: 0 4px 36px #19193380;
}

.btn-bar, .save-bar {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  margin-bottom: 20px;
}

.btn-bar button, .save-bar button {
  width: 100%;
  margin-bottom: 14px;
  font-size: 18px;
  font-weight: 600;
  border-radius: 14px;
  background: linear-gradient(90deg, #4252be 70%, #6e89ec 100%);
  border: none;
  color: #fff;
  padding: 13px 0;
  letter-spacing: 1.2px;
  cursor: pointer;
  box-shadow: 0 2px 8px #233;
  transition: background 0.18s, transform 0.12s, box-shadow 0.18s;
}
.btn-bar button:disabled, .save-bar button:disabled {
  background: #333a;
  color: #aaa;
  cursor: not-allowed;
}

.btn-bar button:hover:not(:disabled), .save-bar button:hover:not(:disabled) {
  background: linear-gradient(90deg, #5162e0 70%, #9ab5ff 100%);
  transform: translateY(-2px) scale(1.035);
  box-shadow: 0 4px 18px #4456cc44;
}

.save-bar {
  margin-top: 25px;
  font-size: 15px;
  color: #cacde8;
  align-items: flex-start;
}
.save-bar span {
  margin-left: 8px;
  color: #c6c8dd;
}

.stat-box {
  margin: 6px 0 22px 0;
  font-size: 18.5px;
}
.stat-box span {
  display: inline-block;
  margin-right: 22px;
  color: #f8f8fb;
  font-size: 18px;
}
.stat-box b {
  color: #ffe161;
  font-weight: 700;
}
.inv-btn, .enhance-btn {
  font-size: 13px;
  padding: 4px 16px;
  min-width: 42px;
  margin: 0 0 0 5px;
  border-radius: 9px;
}
.inv-btn:hover { background: #697af3; }
.inv-btn:disabled { color: #888; }

.set-bonus {
  color: #ffe161;
  font-weight: bold;
  letter-spacing: 0.8px;
}

/* ì „ì²´ì ìœ¼ë¡œ í°íŠ¸ ì¡°ê¸ˆ ë¶€ë“œëŸ½ê²Œ */
body, input, button {
  font-family: 'Malgun Gothic', 'Noto Sans KR', 'Pretendard', sans-serif;
  letter-spacing: 0.08em;
}
#loadslotbox {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 96vh;
  width: 100vw;
  position: absolute;
  top: 0; left: 0;
  background: none;
  z-index: 10;
}
.save-slot-select {
  background: #23223a;
  border-radius: 30px;
  box-shadow: 0 6px 36px #18183360, 0 2px 12px #0008;
  padding: 48px 64px 38px 64px;
  margin-top: 40px;
  font-size: 24px;
  color: #fff;
  min-width: 350px;
}
.save-slot-btn {
  font-size: 23px !important;
  padding: 22px 44px !important;
  border-radius: 13px !important;
  background: #384085 !important;
  color: #fff !important;
  font-weight: 700 !important;
  margin-right: 15px !important;
  margin-bottom: 16px !important;
  box-shadow: 0 2px 14px #2334;
  border: none !important;
  cursor: pointer;
  transition: background 0.14s, transform 0.12s;
}
.save-slot-btn:hover {
  background: #5662d1 !important;
  transform: translateY(-2px) scale(1.025);
}
.save-del-btn {
  background: #ba4545 !important;
  color: #fff !important;
  border-radius: 9px !important;
  font-size: 16px !important;
  padding: 8px 20px !important;
  margin-bottom: 16px !important;
  margin-left: 0px !important;
  border: none !important;
  cursor: pointer;
  transition: background 0.14s;
}
.save-del-btn:hover {
  background: #e65a5a !important;
#equipstatbox {
  margin-bottom: 18px;
  margin-top: -5px;
  display: flex;
  align-items: center;
  padding: 0;
}
.equipstat-flex {
  display: flex;
  flex-direction: column;  /* ì„¸ë¡œ ì •ë ¬ */
  align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ */
  width: 100%;
  background: #232346;
  border-radius: 10px;
  padding: 7px 18px 7px 18px;
  font-size: 17px;
  color: #ffe161;
  gap: 1px;
}
.equipstat-flex span {
  color: #e3e3e3;
  font-size: 16px;
  letter-spacing: 0.4px;
}
.equipstat-flex b {
  color: #ffe161;
  font-weight: 700;
}
.stat-head {
  font-size: 17px;
  color: #ffe161;
  font-family: 'Malgun Gothic', 'Noto Sans KR', 'Pretendard', sans-serif;
  margin-bottom: 6px;
  letter-spacing: 0.07em;
  font-weight: 600;
}
</style>
</head>
<body>
  <div id="loadslotbox"></div>
  <div id="mainwrap" style="display:none">
    <div id="centerwrap">
      <div id="userinfo" style="display:none"></div>
      <div id="equipstatbox" style="margin-bottom:18px; display:none"></div>
      <div class="log" id="logbox"></div>
    </div>
    <div id="sidebar">
      <div class="btn-bar" id="menubar" style="display:none">
        <button onclick="action('hunt')">ì‚¬ëƒ¥</button>
        <button onclick="dungeonEnterUI()">ë˜ì „</button>
        <button onclick="showExploreMain()" id="btn_explore">íƒí—˜</button>
        <button onclick="showChar()">ìºë¦­í„°</button>
        <button onclick="showInv()">ì†Œì§€í’ˆ</button>
        <button onclick="showTown()">ë§ˆì„</button>
      </div>
      <div class="save-bar" id="savebar" style="display:none">
        <button onclick="saveGame()">ğŸ’¾ ì„¸ì´ë¸Œ</button>
        <button onclick="showLoad()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <span style="color:#aaa;">(ìŠ¬ë¡¯ <span id="slotsel"></span>)</span>
      </div>
    </div>
  </div>
  <script>
const itemStatTable = {
  "ì¼ë°˜":     { base:[0, 2],    atk:[1, 3]   },
  "ë ˆì–´":     { base:[2, 4],    atk:[3, 6]   },
  "ìœ ë‹ˆí¬":   { base:[4, 7],    atk:[6, 10]  },
  "ì—í”½":     { base:[7, 11],   atk:[10, 15] },
  "ë ˆì „ë”ë¦¬": { base:[12, 18],  atk:[16, 22] },
  "ìœ ì¼":     { base:[18, 27],  atk:[25, 35] }
};
const armorSkillEffectScale = {
  "ì¼ë°˜":     1,
  "ë ˆì–´":     1,
  "ìœ ë‹ˆí¬":   1.2,
  "ì—í”½":     1.5,
  "ë ˆì „ë”ë¦¬": 2,
  "ìœ ì¼":     3
};
const combineRates = { "ë ˆì–´": 0.33, "ìœ ë‹ˆí¬": 0.20, "ì—í”½": 0.10 };
function combineCost(rarity, level) {
  let base = 1000 + level * 30;
  if (rarity === "ìœ ë‹ˆí¬") base += 2000;
  if (rarity === "ì—í”½") base += 5000;
  return base;
}
const armorSkillPool = [
  { name: "ìƒëª…íšŒë³µ",     type: "regen",      base: [1, 2]  },  // í„´ë§ˆë‹¤ %íšŒë³µ
  { name: "í”¼í•´í¡í˜ˆ",     type: "leech",      base: [1, 2]  },  // í”¼í•´ì˜ % í¡ìˆ˜
  { name: "ë°›ëŠ”í”¼í•´ê°ì†Œ", type: "dmgreduce",  base: [2, 4]  },  // %ê°ì†Œ
  { name: "ì²«í”¼ê²©ë¬´ì‹œ",   type: "ignorehit",  base: [1, 1]  },  // níšŒ
  { name: "ì‚¬ë§ë°©ì§€",     type: "deathproof", base: [1, 1]  },  // níšŒ
  { name: "ê³µê²©ë°˜ì‚¬",     type: "reflect",    base: [2, 3]  },  // %ë°˜ì‚¬
  { name: "íšŒí”¼ì¦ê°€",     type: "evadeup",    base: [3, 4]  },  // %ìƒìŠ¹
  { name: "ì‹¤ë“œë¶€ì—¬",     type: "shield",     base: [20, 24]}   // ì‹¤ë“œëŸ‰
];
const armorSkillLogEffects = {
  "regen":        { icon:"ğŸ’š",  color:"#5eff86",  msg: v=>`HP +${v}% íšŒë³µ` },
  "leech":        { icon:"ğŸ©¸",  color:"#c9488a",  msg: v=>`í”¼í•´ì˜ ${v}% í¡í˜ˆ` },
  "dmgreduce":    { icon:"ğŸ›¡ï¸", color:"#a1f2ff",  msg: v=>`ë°›ëŠ” í”¼í•´ -${v}%` },
  "ignorehit":    { icon:"ğŸ§±",  color:"#c8d7e2",  msg: v=>`ì²« í”¼ê²© ë¬´ì‹œ` },
  "deathproof":   { icon:"âš°ï¸",  color:"#f0f055",  msg: v=>`ì‚¬ë§ë°©ì§€` },
  "reflect":      { icon:"ğŸª",  color:"#8ef6f2",  msg: v=>`ê³µê²©ë°˜ì‚¬ +${v}%` },
  "evadeup":      { icon:"ğŸƒâ€â™‚ï¸",color:"#8af8a7",  msg: v=>`íšŒí”¼ +${v.toFixed(1)}%` },
  "shield":       { icon:"ğŸ›¡ï¸", color:"#e3ffd8",  msg: v=>`ì‹¤ë“œ +${v}` },
};

const statNames = ["STR", "DEX", "INT", "VIT", "LUK"];
const equipSlots = ["ë¨¸ë¦¬", "ìƒì˜", "í•˜ì˜", "ì†", "ì‹ ë°œ", "ë¬´ê¸°", "ë°©íŒ¨"];
const prefixes = ["ë¶ˆíƒ€ëŠ”", "ì‹ ì†í•œ", "ê³ ëŒ€ì˜", "ë¹›ë‚˜ëŠ”", "ê°•ì¸í•œ", "ì¬ë¹ ë¥¸", "í˜„ìì˜", "ì•”í‘ì˜", "ë‹¨ë‹¨í•œ", "ìš©ë§¹í•œ"];
const suffixes = ["ê´‘ê¸°", "ì§€í˜œ", "ì†ë„", "í–‰ìš´", "í˜", "ìˆ˜í˜¸", "íŒŒë©¸", "ë§ˆë²•", "ë¶ˆë©¸", "ìš©ê¸°"];
const rarityOrder = ["ì¼ë°˜","ë ˆì–´","ìœ ë‹ˆí¬","ì—í”½","ë ˆì „ë”ë¦¬","ìœ ì¼","ì§€ì˜¥"];
const rarityColors = { "ì¼ë°˜":"equip-normal", "ë ˆì–´":"equip-rare", "ìœ ë‹ˆí¬":"equip-unique", "ì—í”½":"equip-epic", "ë ˆì „ë”ë¦¬":"equip-legend", "ìœ ì¼":"equip-myth","ì§€ì˜¥":"equip-inferno" };
const rarityRate   = [60, 20, 5, 1, 0.01, 0,0];
const dungeonRate = [45,25,10,6,1,0.1,0];
const inventoryLimit = 40;
const skillTriggerRate = { "ì¼ë°˜": 0.02, "ë ˆì–´": 0.04, "ìœ ë‹ˆí¬": 0.07, "ì—í”½": 0.10, "ë ˆì „ë”ë¦¬": 0.15, "ìœ ì¼": 0.33 };
const skillGiveRate = { "ì¼ë°˜": 0.02, "ë ˆì–´": 0.06, "ìœ ë‹ˆí¬": 0.10, "ì—í”½": 0.18, "ë ˆì „ë”ë¦¬": 0.25, "ìœ ì¼": 1.0 };
const armorSkillTriggerRate = {"ì¼ë°˜": 0.03, "ë ˆì–´": 0.05, "ìœ ë‹ˆí¬": 0.07, "ì—í”½": 0.10, "ë ˆì „ë”ë¦¬": 0.13, "ìœ ì¼": 0.17};
const slotTypePool = {
  "ë¬´ê¸°": [
    {name:"ê²€",type:"ê·¼ì ‘"}, {name:"ë„ë¼",type:"ê·¼ì ‘"}, {name:"ì°½",type:"ê·¼ì ‘"}, {name:"ë ˆì´í”¼ì–´",type:"ê·¼ì ‘"},
    {name:"ëŒ€ê²€",type:"ê·¼ì ‘"}, {name:"ì–‘ì†ë„ë¼",type:"ê·¼ì ‘"},
    {name:"í™œ",type:"ì›ê±°ë¦¬"}, {name:"ì„ê¶",type:"ì›ê±°ë¦¬"}, {name:"ì´",type:"ì›ê±°ë¦¬"},
    {name:"ì›ë“œ",type:"ë§ˆë²•"}, {name:"ìŠ¤íƒœí”„",type:"ë§ˆë²•"}, {name:"ë“€ì–¼ê±´",type:"ë§ˆë²•"}
  ],
  "ë°©íŒ¨": [{name:"ë°©íŒ¨",type:"ë°©ì–´"}],
  "ë¨¸ë¦¬": [{name:"íˆ¬êµ¬"},{name:"ëª¨ì"},{name:"ë‘ê±´"}],
  "ìƒì˜": [{name:"ê°‘ì˜·"},{name:"ë¡œë¸Œ"},{name:"ìì¼“"}],
  "í•˜ì˜": [{name:"ë°”ì§€"},{name:"ë ˆê¹…ìŠ¤"}],
  "ì‹ ë°œ": [{name:"ë¶€ì¸ "},{name:"ì‹ ë°œ"},{name:"ì¥í™”"}],
  "ì†": [{name:"ì¥ê°‘"},{name:"ë°˜ì§€"}]
};
const skillPool = {
  "ê·¼ì ‘": ["íšŒì „ë² ê¸°", "ì§€ì§„ê°•íƒ€", "ê´‘ì—­ì°¸ê²©", "ì°¸ê²©", "ëŒì§„ë² ê¸°"],
  "ì›ê±°ë¦¬": ["ì—°ì†ì‚¬ê²©", "ê´€í†µí™”ì‚´", "ì €ê²©", "í­ë°œí™”ì‚´", "ì§‘ì¤‘ì‚¬ê²©"],
  "ë§ˆë²•": ["íŒŒì´ì–´ë³¼", "ì•„ì´ìŠ¤ìŠ¤í†°", "ì²´ì¸ë¼ì´íŠ¸ë‹", "ì•”í‘êµ¬", "ì—ë„ˆì§€ë¸”ë˜ìŠ¤íŠ¸"]
};
const monsterPrefixes = ["ë¶ˆíƒ€ëŠ”", "ì‚¬ë‚˜ìš´", "ê±°ëŒ€í•œ", "ë‚ ì¹´ë¡œìš´", "ì•”í‘ì˜", "ë¹™ê²°ì˜", "ê´‘ê¸°ì˜", "ë²ˆê°œì˜", "ë…ê¸°ì˜", "ì£½ìŒì˜"];
const monsterNames = [
  "ê·¸ë¦¼ì ë©§ë¼ì§€", "ë¹™ê²° ìŠ¬ë¼ì„", "ë¶ˆì‚¬ë¥¸ í•´ê³¨ê¸°ì‚¬", "ì§€ì˜¥ë°•ì¥", "ëŒì—°ë³€ì´ ëŠ‘ëŒ€",
  "ì•”í‘ì˜ ê³ ë¸”ë¦°", "ê´‘ê¸°ì˜ ì˜¤ìš°ê±°", "ì„œë¦¬ê³¨ë ˜", "ë¶ˆê½ƒ ì™€ì´ë²ˆ", "ì£½ìŒì˜ ë¦¬ì¹˜",
  "í˜¼ëˆì˜ ë¯¸ë…¸íƒ€ìš°ë¥´ìŠ¤", "ë§¹ë… ìŠ¤ì½œí”¼ì˜¨", "ë¬´ì‡  ê³°", "í‰í¬í•œ ëŠ‘ëŒ€", "ë…ì‚¬",
  "ì–´ë‘ ì˜ ì•”ì‚´ì", "ê´‘í¬í•œ ê³°", "ê³ ëŒ€ì˜ ê³¨ë ˜", "ë‚ ë µí•œ íŒ¬ì„œ", "ì €ì£¼ë°›ì€ í•´ê³¨ì „ì‚¬"
];
const uniqueMonsters = [
  "ê´‘íœ˜ë£¡ ë²¨ë¦¬ì˜¤ë¡œìŠ¤", "í‘ì„¬ë£¡ ì•„ë²¨ë¦¬ì˜¤ìŠ¤", "ìˆ˜ì•”ë£¡ íƒ€ë‚˜ë¡œí† ìŠ¤", "ì•”í† ë£¡ ìš°ë¡œë³´ë¡œìŠ¤"
];
const uniqueMonsterPrefixes = {
  "ê´‘íœ˜ë£¡ ë²¨ë¦¬ì˜¤ë¡œìŠ¤": "ê´‘íœ˜",
  "í‘ì„¬ë£¡ ì•„ë²¨ë¦¬ì˜¤ìŠ¤": "í‘ì„¬",
  "ìˆ˜ì•”ë£¡ íƒ€ë‚˜ë¡œí† ìŠ¤": "ìˆ˜ì•”",
  "ì•”í† ë£¡ ìš°ë¡œë³´ë¡œìŠ¤": "í† ì•”"
};
// ìœ ì¼ ì„¸íŠ¸ íš¨ê³¼
const uniqueSetBonus = {
  "ê´‘íœ˜": { name: "ê´‘íœ˜ ì„¸íŠ¸", desc: "1í„´ 2íšŒ ê³µê²©" },
  "í‘ì„¬": { name: "í‘ì„¬ ì„¸íŠ¸", desc: "ê³µê²© ì‹œ 30% í™•ë¥ ë¡œ 1í„´ ìŠ¤í„´" },
  "ìˆ˜ì•”": { name: "ìˆ˜ì•” ì„¸íŠ¸", desc: "í”¼ê²© ì‹œ 40% í™•ë¥ ë¡œ 50% ë°˜ì‚¬" },
  "í† ì•”": { name: "í† ì•” ì„¸íŠ¸", desc: "ì „íˆ¬ ì¤‘ 1íšŒ ì‚¬ë§ ì‹œ 50% ë¶€í™œ" }
};
let user = null; let saveSlot = 1;
function rint(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
// ëª¬ìŠ¤í„° ìƒì„±
function makeMonster(level, isDungeon = false) {
if (isDungeon && Math.random() < 0.01) {
  // ìœ ì¼(ë³´ìŠ¤) ëª¬ìŠ¤í„° - **í•˜í–¥**
  let name = uniqueMonsters[rint(0, uniqueMonsters.length-1)];
  let hp = Math.floor((60 + level*8 + rint(30,80)) * 0.83); // ì•½ 17% í•˜í–¥
  let atk = Math.floor((12 + level*3 + rint(6,15)) * 0.85); // ì•½ 15% í•˜í–¥
  let def = Math.floor((level/4 + rint(5,15)) * 0.9);       // ì•½ 10% í•˜í–¥
  return { name, hp, atk, def, unique: true };
}
  let prefix = monsterPrefixes[rint(0, monsterPrefixes.length - 1)];
  let nameBase = monsterNames[rint(0, monsterNames.length - 1)];
  let name = prefix + " " + nameBase;
  let hp, atk, def;
  if (isDungeon) {
    // ë˜ì „ ëª¬ìŠ¤í„° (ê¸°ì¡´ì²˜ëŸ¼ ê°•í™”)
    hp = Math.floor(20 + level * 4 + rint(0, 16)) + rint(12, 40) + Math.floor(level * 2.5);
    atk = Math.floor(5 + level * 1.3 + rint(1, 4));
    def = Math.floor(level/5 + rint(0, 2));
  } else {
    // ì¼ë°˜(ì‚¬ëƒ¥) ëª¬ìŠ¤í„° (ë” ì•½í•˜ê²Œ)
    hp = Math.floor(8 + level * 1.3 + rint(0, 6));
    atk = Math.floor(1.5 + level * 0.4 + rint(0, 1.5));
    def = Math.floor(level/8 + rint(0, 1));
  }
  return { name, hp, atk, def, unique: false };
}
// ì„¸ì´ë¸Œ/ë¶ˆëŸ¬ì˜¤ê¸°/ìŠ¬ë¡¯ì‚­ì œ
window.onload = function() { renderSaveSlotSelect(); };
function renderSaveSlotSelect() {
  let html = `<div class="save-slot-select"><b>ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `ìŠ¬ë¡¯${i} (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `ìŠ¬ë¡¯${i} (ìƒˆ ì‹œì‘)`;
    html += `<div style="margin-bottom:8px;display:flex;align-items:center;">
      <button class="save-slot-btn" onclick="startGame(${i})">${btnText}</button>
      <button class="save-del-btn" onclick="deleteSaveSlot(${i})">ì‚­ì œ</button>
    </div>`;
  }
  html += `</div>`;
  document.getElementById("loadslotbox").innerHTML = html;
}
function deleteSaveSlot(slot) {
  if(confirm(`ì •ë§ë¡œ ìŠ¬ë¡¯${slot}ì˜ ì €ì¥ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)){
    localStorage.removeItem("elgasia_save_"+slot);
    renderSaveSlotSelect();
  }
}
function saveGame() {
  if (!user) return;
  localStorage.setItem("elgasia_save_"+saveSlot, JSON.stringify(user));
  log(`<span style='color:#aaf'>ìŠ¬ë¡¯ ${saveSlot}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>`);
}
function loadGame(slot) {
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data); saveSlot = slot;
    if(!user.storage) user.storage=[];
    showUI(); updateUser();
    log(`<span style='color:#aff'>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìŠ¬ë¡¯ ${slot}</span>`);
  }
}
function showLoad() {
  let html = `<b>ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ ì„ íƒ</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `ìŠ¬ë¡¯${i} ë¶ˆëŸ¬ì˜¤ê¸° (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `ìŠ¬ë¡¯${i} (ë¹„ì–´ìˆìŒ)`;
    html += `<button class="save-slot-btn" onclick="loadGame(${i});hideLoad();">${btnText}</button>
    <button class="save-del-btn" onclick="deleteSaveSlot(${i})">ì‚­ì œ</button><br>`;
  }
  html += `<br><button class="inv-btn" onclick="hideLoad()">ë‹«ê¸°</button>`;
  document.getElementById("logbox").innerHTML = html;
}
function hideLoad(){ log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°'); }
function startGame(slot) {
  saveSlot = slot;
  let data = localStorage.getItem("elgasia_save_"+slot);
  document.getElementById("loadslotbox").style.display = "none";
  document.getElementById("mainwrap").style.display = "";
  if (data) {
    user = JSON.parse(data); if(!user.storage) user.storage=[];
    document.getElementById("loadslotbox").style.display = "none";
    document.getElementById("mainwrap").style.display = "";
    showUI(); updateUser();
    log(`<span style='color:#aff'>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìŠ¬ë¡¯ ${slot}</span>`);
  } else {
    user = {
      name: "ìš©ì‚¬", level: 1, exp: 0, rebirth: 0, gold: 100,
      stats: [1,1,1,1,1], statmax: 9999, hp: 30, maxhp: 30,
      equip: {}, inv: [], town: {restcount:0,skillstone:1}, stones: 0, storage: []
    };
    document.getElementById("mainwrap").style.display = "";
    showUI(); updateUser();
    log(`<b>í™˜ì˜í•©ë‹ˆë‹¤! ìºë¦­í„° ì´ë¦„ì„ ë¨¼ì € ì •í•´ì£¼ì„¸ìš”.</b> <br><div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="ìºë¦­í„° ì´ë¦„"/><button class="inv-btn" onclick="setCharName()">í™•ì¸</button></div>`);
  }
}
function showUI() {
  document.getElementById("loadslotbox").style.display = "none";
  document.getElementById("userinfo").style.display = "";
  document.getElementById("menubar").style.display = "";
  document.getElementById("savebar").style.display = "";
  document.getElementById("slotsel").innerText = saveSlot;
}
function setCharName() {
  let n = document.getElementById("newname").value.trim();
  if (!n) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  user.name = n;
  updateUser();
  log(`ì´ë¦„ì´ <b>${n}</b>ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  saveGame();
}
function promptNameChange() {
  let n = prompt("ìƒˆ ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", user.name || "");
  if(!n) return;
  user.name = n;
  updateUser(); saveGame();
}
function expNeed(lv){ return Math.floor(Math.pow(lv,1.5)*12)+lv*8; }
function log(msg){ document.getElementById("logbox").innerHTML = msg; }
function updateUser() {
  if(!user.storage) user.storage=[];
  // ê¸°ë³¸ ì •ë³´
  document.getElementById("userinfo").innerHTML = `<div class="stat-box">
    <span>ì´ë¦„ <b>${user.name}</b> <button class="inv-btn" onclick="promptNameChange()">ë³€ê²½</button></span>
    <span>ë ˆë²¨ <b>${user.level}</b></span>
    <span>ê²½í—˜ì¹˜ <b>${user.exp}/${expNeed(user.level)}</b></span>
    <span>ê³¨ë“œ <b>${user.gold}</b></span>
    <span>HP <b>${user.hp}/${user.maxhp}</b></span>
    <span>ê°•í™”ì„ <b>${user.stones||0}</b></span>
    <span>ì°½ê³  <b>${user.storage.length}/100</b></span>
  </div>`;
  document.getElementById("userinfo").style.display = "";

  // ì¥ë¹„ í•©ì‚° ìŠ¤íƒ¯ ê³„ì‚° ë° í‘œì‹œ
  let baseStats = user.stats.slice();
  let equipStats = user.stats.slice();
  let addATK = 0, addRATK = 0, addMATK = 0, addDEF = 0;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if(eq && eq.stat){
      for(let i=0; i<5; i++){
        equipStats[i] += eq.stat[i]||0;
      }
      addATK += eq.stat[5]||0;
      addRATK += eq.stat[6]||0;
      addMATK += eq.stat[7]||0;
      addDEF += eq.stat[3]||0;
    }
  }
  let totalATK = addATK + equipStats[0];
  let totalRATK = addRATK + equipStats[1];
  let totalMATK = addMATK + equipStats[2];
  let totalDEF = equipStats[3];
  let statLabel = ["STR(ê·¼ë ¥)","DEX(ë¯¼ì²©)","INT(ì§€ëŠ¥)","VIT(ì²´ë ¥)","LUK(ìš´)"];
  let equipStr = equipStats.map((v,i)=>`${statLabel[i]}: <b>${v}</b>`).join(" / ");
  let atkStr = `ATK(ê·¼ì ‘): <b>${totalATK}</b> / RATK(ì›ê±°ë¦¬): <b>${totalRATK}</b> / MATK(ë§ˆë²•): <b>${totalMATK}</b> / DEF: <b>${totalDEF}</b>`;

document.getElementById("equipstatbox").innerHTML =
  `<div class="equipstat-flex">
     <span>${equipStr}</span>
     <br>
     <span>${atkStr}</span>
   </div>`;
document.getElementById("equipstatbox").style.display = "";
}
function rarityBonus(r){
  if(r=="ì¼ë°˜")return 0; if(r=="ë ˆì–´")return 1; if(r=="ìœ ë‹ˆí¬")return 2;
  if(r=="ì—í”½")return 3; if(r=="ë ˆì „ë”ë¦¬")return 4; if(r=="ìœ ì¼")return 5;
  return 0;
}
// ---- ì•„ì´í…œ ìƒì„± (ìŠ¤í‚¬ í™•ë¥  ë° ìœ ì¼ ì„¸íŠ¸/ìŠ¤í‚¬)
function makeItem(allowMyth, isShop, uniqueMonsterName = null, rarityOverride = null, allowInferno = false) {
  let rate = allowMyth ? dungeonRate : rarityRate;
  let localRarityOrder = isShop ? ["ì¼ë°˜","ë ˆì–´","ìœ ë‹ˆí¬"] : rarityOrder;
  let localRate = isShop ? [70,25,5] : rate;
  let rarity = "ì¼ë°˜";
  let r = Math.random() * 100, acc = 0;
  for (let i=0;i<localRate.length;i++) { acc += localRate[i]; if (r < acc) { rarity = localRarityOrder[i]; break; } }
  if(!uniqueMonsterName && rarity === "ìœ ì¼") rarity = "ë ˆì „ë”ë¦¬";
  if(uniqueMonsterName) rarity = "ìœ ì¼";
  if (rarityOverride) rarity = rarityOverride;

  let slot = equipSlots[rint(0, equipSlots.length-1)];
  let pool = slotTypePool[slot];
  let baseObj = pool[rint(0, pool.length-1)];
  let itemType = baseObj.name;
  let itemAttackType = baseObj.type || null;

  // â˜…â˜…â˜…â˜…â˜… ì§€ì˜¥ ë“±ê¸‰ (íŒŒë©¸ì˜) ë¶„ê¸° â˜…â˜…â˜…â˜…â˜…
  if(rarity === "ì§€ì˜¥") {
    let isWeapon = (slot === "ë¬´ê¸°");
    let isArmor = ["ë¨¸ë¦¬","ìƒì˜","í•˜ì˜","ì†","ì‹ ë°œ"].includes(slot);
    let name = `íŒŒë©¸ì˜ ${itemType}`;
    let sconf = itemStatTable["ìœ ì¼"];
    // ìŠ¤íƒ¯: ìœ ì¼ì˜ 87~92%ë¡œ
    let stat = [];
    for(let i=0;i<5;i++) stat.push(rint(Math.floor(sconf.base[0]*0.87), Math.floor(sconf.base[1]*0.92)));
    let atk = itemAttackType === "ê·¼ì ‘" ? rint(Math.floor(sconf.atk[0]*0.87), Math.floor(sconf.atk[1]*0.92)) : 0;
    let ratk= itemAttackType === "ì›ê±°ë¦¬"? rint(Math.floor(sconf.atk[0]*0.87), Math.floor(sconf.atk[1]*0.92)) : 0;
    let matk= itemAttackType === "ë§ˆë²•"  ? rint(Math.floor(sconf.atk[0]*0.87), Math.floor(sconf.atk[1]*0.92)) : 0;
    stat.push(atk); stat.push(ratk); stat.push(matk);

    let skill = null, special = null, armorSkill = null;
    if (isWeapon) {
      // ë¬´ê¸°ìŠ¤í‚¬ 1ê°œ
      if (itemAttackType && skillPool[itemAttackType])
        skill = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
      // íŠ¹ìˆ˜íš¨ê³¼ 3ì¢… ê³ ì •
      special = [
        { type: "strongAtkUp", val: 25 },
        { type: "doubleHit",   val: 15 },
        { type: "ignoreDef",   val: 25 }
      ];
    } else if (isArmor) {
      // ë°©ì–´êµ¬ ìŠ¤í‚¬ 1ê°œ (ìœ ì¼ë³´ë‹¤ ì•½ê°„ ì•½í•˜ê²Œ)
      let skillObj = armorSkillPool[rint(0, armorSkillPool.length-1)];
      let scale = 2.1; // ìœ ì¼(3)ì— ë¹„í•´ ì†Œí­ í•˜í–¥
      let val = rint(skillObj.base[0]*scale, skillObj.base[1]*scale);
      armorSkill = { name: skillObj.name, type: skillObj.type, value: val };
    }
    return {
      name, rarity: "ì§€ì˜¥", slot, stat, type: itemType,
      attackType: itemAttackType, skill, enh: 0, ilv: null, unique: false, special, armorSkill
    };
  }
  // â˜…â˜…â˜…â˜…â˜… ìœ ì¼ ì•„ì´í…œ (ìœ ì¼ ëª¬ìŠ¤í„° ë“œë) â˜…â˜…â˜…â˜…â˜…
  if(rarity === "ìœ ì¼" && uniqueMonsterName) {
    let uniqPrefix = uniqueMonsterPrefixes[uniqueMonsterName] || "ìœ ì¼";
    let baseName = baseObj.name;
    let name = `${uniqPrefix}ì˜ ${baseName}`;
    let skill = "";
    if(itemAttackType && skillPool[itemAttackType])
      skill = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
    let stat = [];
    let sconf = itemStatTable["ìœ ì¼"];
    for(let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
    let atk = itemAttackType === "ê·¼ì ‘" ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let ratk= itemAttackType === "ì›ê±°ë¦¬"? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let matk= itemAttackType === "ë§ˆë²•"  ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    stat.push(atk); stat.push(ratk); stat.push(matk);
    return {
      name, rarity: "ìœ ì¼", slot, stat, type: baseName, attackType: itemAttackType,
      skill, enh: 0, ilv: null, unique: true, uniqPrefix
    };
  }

  // â˜…â˜…â˜…â˜…â˜… ì¼ë°˜~ë ˆì „ë”ë¦¬ ì•„ì´í…œ â˜…â˜…â˜…â˜…â˜…
  let prefix = prefixes[rint(0,prefixes.length-1)];
  let suffix = suffixes[rint(0,suffixes.length-1)];
  let name = `${prefix} ${suffix}ì˜ ${itemType}`;
  let skill = null, skillBase = null, skillBonus=1, trigger = skillTriggerRate[rarity] || 0.05;
  if (itemAttackType && skillPool[itemAttackType]) {
    let chance = skillGiveRate[rarity] || 0.1;
    if(Math.random() < chance) {
      skillBase = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
      skill = prefix ? `${prefix} ${skillBase}` : skillBase;
      if(prefix && prefix.includes("ë¶ˆíƒ€ëŠ”")) skillBonus = 1.2;
    }
  }
  let stat = [];
  let sconf = itemStatTable[rarity];
  for (let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
  let atk=0, ratk=0, matk=0;
  if(itemAttackType=="ê·¼ì ‘") atk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="ì›ê±°ë¦¬") ratk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="ë§ˆë²•") matk = rint(sconf.atk[0],sconf.atk[1]);
  stat.push(Math.floor(atk * skillBonus));
  stat.push(Math.floor(ratk * skillBonus));
  stat.push(Math.floor(matk * skillBonus));

  // ğŸŸ¢ ë°©ì–´êµ¬ ìŠ¤í‚¬ ë¶€ì—¬ (ë°©ì–´êµ¬ë§Œ, ë¬´ê¸°/ë°©íŒ¨/ìœ ì¼ ì œì™¸)
  let armorSkill = null;
  if (["ë¨¸ë¦¬","ìƒì˜","í•˜ì˜","ì†","ì‹ ë°œ"].includes(slot) && rarity !== "ìœ ì¼" && Math.random()<0.40) {
    let skillObj = armorSkillPool[rint(0, armorSkillPool.length-1)];
    let scale = armorSkillEffectScale[rarity] || 1;
    let val = rint(skillObj.base[0]*scale, skillObj.base[1]*scale);
    armorSkill = { name: skillObj.name, type: skillObj.type, value: val };
  }

  return {
    name: name, rarity: rarity, slot: slot, stat: stat, type: itemType,
    attackType: itemAttackType, skill: skill, skillBase: skillBase, skillBonus: skillBonus,
    skillTrigger: trigger, enh: 0, ilv: null, unique: false, armorSkill
  };
}
function makeUniqueItem(monsterName, slot){
  const prefix = uniqueMonsterPrefixes[monsterName] || "ì „ì„¤";
  let baseName = slotTypePool[slot][0].name;
  let name = `${prefix}ì˜ ${baseName}`;
  let skill = null;
  switch(prefix){
    case "ê´‘íœ˜": skill = "ë¹›ì˜ í­ë°œ"; break;
    case "í‘ì„¬": skill = "ì•”í‘ ì—°ì‡„"; break;
    case "ìˆ˜ì•”": skill = "ë¬¼ì˜ íŒŒë™"; break;
    case "í† ì•”": skill = "ëŒ€ì§€ ë¶„ì‡„"; break;
    default: skill = "ì „ì„¤ì˜ í˜";
  }
  let stat = [10,5,5,7,3];
  let atk=15, ratk=0, matk=0;
  if(slot === "ë¬´ê¸°") atk = 25;
  return {
    name, rarity: "ìœ ì¼", slot, stat, type: baseName,
    attackType: slot === "ë¬´ê¸°" ? "ê·¼ì ‘" : null, skill, enh: 0, ilv: null, unique: true, uniqPrefix: prefix
  };
}
function unequip(slot) {
  if (!user.equip[slot]) return;
  if (user.inv.length >= inventoryLimit) {
    log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!"); return;
  }
  let item = user.equip[slot];
  user.inv.push(item);        // ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
  user.equip[slot] = undefined; // ì¥ì°© í•´ì œ
  showChar(); // ìºë¦­í„°ì°½ ìƒˆë¡œê³ ì¹¨
  updateUser();
}
function itemDisplay(item){
  let txt = `<div style="display:flex;align-items:center;">
      <span class="${rarityColors[item.rarity]}" style="font-size:16px;margin-right:7px;min-width:68px;text-align:center;">[${item.rarity}]</span>
      <span style="font-weight:700;font-size:16px;">${item.name}</span>
    </div>`;

  txt += `<div style="margin-left:10px;margin-top:1px;font-size:14px;">`;
  txt += `<span class="stat-label">STR:${item.stat[0]} DEX:${item.stat[1]} INT:${item.stat[2]} VIT:${item.stat[3]} LUK:${item.stat[4]}</span>`;
  if (item.attackType === "ê·¼ì ‘")   txt += ` <span class="equip-bonus">ATK:${item.stat[5]}</span>`;
  if (item.attackType === "ì›ê±°ë¦¬") txt += ` <span class="equip-bonus">RATK:${item.stat[6]}</span>`;
  if (item.attackType === "ë§ˆë²•")   txt += ` <span class="equip-bonus">MATK:${item.stat[7]}</span>`;
  if (item.skill)      txt += ` <span class="equip-bonus">ìŠ¤í‚¬:${item.skill}</span>`;
  if (item.armorSkill) txt += ` <span class="equip-bonus">ë°©ì–´êµ¬ìŠ¤í‚¬:${item.armorSkill.name}(+${item.armorSkill.value})</span>`;
  // â˜…â˜…â˜… ì§€ì˜¥ ë¬´ê¸° íŠ¹ìˆ˜íš¨ê³¼ í‘œì‹œ
  if (item.special)    txt += ` <span class="equip-bonus">íŠ¹ìˆ˜íš¨ê³¼: ${item.special.map(s=>({
    "strongAtkUp":"ê°•ê³µê²©í™•ë¥ +25%",
    "doubleHit":"ì¶”ê°€ê³µê²©+15%",
    "ignoreDef":"ë°©ì–´ë¬´ì‹œ+25%"
  }[s.type])).join(", ")}</span>`;
  if (item.enh)        txt += ` <span class="enh-lv">+${item.enh}</span>`;
  txt += `</div>`;
  return txt;
}

// ì¸ë²¤í† ë¦¬, ì°©ìš©/íŒë§¤/ì¼ê´„íŒë§¤
function showInv() {
  let invhtml = "";
  user.inv.forEach((item, i) => {
invhtml += `<div class="equipitem">
  <span>${itemDisplay(item)}</span>
  <div class="item-btns">
    <button class="inv-btn" onclick="equipItem(${i})">ì°©ìš©</button>
    <button class="inv-btn" onclick="sellInv(${i})">íŒë§¤</button>
  </div>
</div>`;
  });
  if (!invhtml) invhtml = "<div style='color:#888'>ì†Œì§€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>";
log(`<b>[ì†Œì§€í’ˆ]</b> (${user.inv.length}/${inventoryLimit})<br>${invhtml}<br>
  <button class="inv-btn" onclick="showCombineUI()">ì•„ì´í…œ í•©ì„±</button>
  <button class="inv-btn" onclick="sellAllInv()">ì „ì²´ íŒë§¤ (ì°©ìš© ì œì™¸)</button>
  <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`);
}
function showCombineUI() {
  let html = `<b>[ì•„ì´í…œ í•©ì„±]</b><br>
  <span style="color:#ffe161">ë™ì¼ ë“±ê¸‰ ì•„ì´í…œ 2ê°œë¥¼ ì¡°í•©í•´ ìƒìœ„ ë“±ê¸‰ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
  (ìœ ì¼ ë“±ê¸‰ì€ ì¡°í•© ë¶ˆê°€, ì‹¤íŒ¨ ì‹œ ì¬ë£Œ ì†Œë©¸!)</span><br><br>`;

  let valid = ["ë ˆì–´", "ìœ ë‹ˆí¬", "ì—í”½"];
  let found = false;

  valid.forEach(rarity => {
    // ì¸ë²¤í† ë¦¬ ì‹¤ì œ ì¸ë±ìŠ¤ì™€ í•¨ê»˜ í›„ë³´ ì¶”ì¶œ
    let candidates = user.inv
      .map((it, idx) => ({ ...it, _invIdx: idx }))
      .filter(it => it.rarity === rarity && !it.unique);
    if (candidates.length >= 2) {
      found = true;
      html += `<b>${rarity} (${candidates.length}ê°œ)</b><br>`;
      for (let i = 0; i < candidates.length; i++) {
        for (let j = i + 1; j < candidates.length; j++) {
          let cost = combineCost(rarity, user.level);
          html += `
            <div class="equipitem combine2row">
              <div class="combine-itembox">${itemDisplay(candidates[i])}</div>
              <div style="font-size:16px;font-weight:bold;text-align:center;margin:4px 0 4px 0;">+</div>
              <div class="combine-itembox">${itemDisplay(candidates[j])}</div>
              <div class="combine-btnbox">
                <button class="inv-btn"
                  onclick="combineItem('${rarity}',${candidates[i]._invIdx},${candidates[j]._invIdx})">
                  í•©ì„± (${cost}G, ${Math.round(combineRates[rarity] * 100)}%)
                </button>
              </div>
            </div>
          `;
        }
      }
    }
  });

  if (!found) {
    html += `<div style='color:#888'>í•©ì„± ê°€ëŠ¥í•œ ì•„ì´í…œ(ë™ì¼ ë“±ê¸‰ 2ê°œ)ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  html += `<br><button class="inv-btn" onclick="showInv()">ëŒì•„ê°€ê¸°</button>`;
  log(html);
}

function combineItem(rarity, idx1, idx2) {
  if (idx1 === idx2) { log('í•©ì„± ì˜¤ë¥˜: ê°™ì€ ì•„ì´í…œì…ë‹ˆë‹¤.'); return; }
  let item1 = user.inv[idx1];
  let item2 = user.inv[idx2];
  if (!item1 || !item2 || item1.rarity !== rarity || item2.rarity !== rarity || item1.unique || item2.unique) {
    log('ê°™ì€ ë“±ê¸‰ì˜ ì¼ë°˜ ì•„ì´í…œ 2ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return;
  }
  // â˜…â˜… ë¶€ìœ„ ì²´í¬ ì‚­ì œ! â˜…â˜…
  let cost = combineCost(rarity, user.level);
  if (user.gold < cost) { log('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; }
  user.gold -= cost;
  let [idxA, idxB] = idx1 > idx2 ? [idx1, idx2] : [idx2, idx1]; // ë†’ì€ ì¸ë±ìŠ¤ ë¨¼ì €
  user.inv.splice(idxA, 1);
  user.inv.splice(idxB, 1);
  if (Math.random() < combineRates[rarity]) {
    let nextRarity = rarity === "ë ˆì–´" ? "ìœ ë‹ˆí¬" : rarity === "ìœ ë‹ˆí¬" ? "ì—í”½" : "ë ˆì „ë”ë¦¬";
    let newItem = makeItem(false, false, null, nextRarity);
    // ê²°ê³¼ë¬¼ ë¶€ìœ„ëŠ” ì²« ë²ˆì§¸ ì•„ì´í…œì„ ë”°ë¼ê°
    newItem.slot = item1.slot;
    addInv(newItem);
    log(`<b>í•©ì„± ì„±ê³µ!</b> [${rarity} 2ê°œ] â†’ [${nextRarity} 1ê°œ]<br>${itemDisplay(newItem)}<br>
      <button class="inv-btn" onclick="showCombineUI()">ë‹¤ì‹œ í•©ì„±</button>
      <button class="inv-btn" onclick="showInv()">ì†Œì§€í’ˆ</button>`);
  } else {
    log(`<span class="dead-log">í•©ì„± ì‹¤íŒ¨! ì¬ë£Œ ì•„ì´í…œ 2ê°œ ëª¨ë‘ ì†Œë©¸...</span><br>
      <button class="inv-btn" onclick="showCombineUI()">ë‹¤ì‹œ í•©ì„±</button>
      <button class="inv-btn" onclick="showInv()">ì†Œì§€í’ˆ</button>`);
  }
  updateUser();
}

function sellAllInv(){
  if(user.inv.length === 0){
    log("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤."); return;
  }
  let totalGold = 0;
  let soldNames = [];
  let filteredInv = user.inv.filter(item=>{
    for(let slot of equipSlots){
      if(user.equip[slot] && user.equip[slot].name === item.name) return false;
    }
    return true;
  });
  if(filteredInv.length === 0){
    log("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. (ì°©ìš© ì¤‘ ì•„ì´í…œ ì œì™¸)"); return;
  }
filteredInv.forEach(item=>{
  let idx = user.inv.indexOf(item);
  if(idx >= 0) user.inv.splice(idx,1);
  // ì•„ë˜ ê³µì‹ìœ¼ë¡œ êµì²´ (ê°œë³„ íŒë§¤ì™€ ë™ì¼í•˜ê²Œ)
  let sellValue = (10 + user.level * 2) + (rarityBonus(item.rarity) * (40 + user.level * 3));
  totalGold += sellValue;
  soldNames.push(item.name);
});
  user.gold += totalGold;
  log(`ì°©ìš© ì¤‘ì´ ì•„ë‹Œ ëª¨ë“  ì•„ì´í…œ íŒë§¤ ì™„ë£Œ! ì´ ${totalGold}ê³¨ë“œë¥¼ ì–»ì—ˆë‹¤.<br>íŒë§¤í•œ ì•„ì´í…œ: ${soldNames.join(", ")}<br><button class="inv-btn" onclick="showInv()">ì†Œì§€í’ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function equipItem(idx){
  let item = user.inv[idx];
  if(!item || !item.slot || equipSlots.indexOf(item.slot) === -1) return;
  // ë¶€ìœ„ í™•ì¸: ê°™ì€ ë¶€ìœ„ì—ë§Œ ì¥ì°© ê°€ëŠ¥!
  // ì´ë¯¸ ì¥ì°© ì¤‘ì¸ ë‹¤ë¥¸ ë¶€ìœ„ì— ì°©ìš© ì‹œë„ ë°©ì§€
  // (slotì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ í—ˆìš©)
  if(user.equip[item.slot]) addInv(user.equip[item.slot]);
  user.equip[item.slot]=item;
  user.inv.splice(idx,1);
  showInv(); updateUser();
}
function sellInv(idx){
  let item = user.inv[idx];
  let sellValue = (10 + user.level * 2) + (rarityBonus(item.rarity) * (40 + user.level * 3));
  user.gold += sellValue;
  user.inv.splice(idx,1);
  log(`${itemDisplay(item)}<br><span style="color:#ffe55e">${sellValue}Gì— íŒë§¤ë˜ì—ˆìŠµë‹ˆë‹¤!</span><br><button class="inv-btn" onclick="showInv()">ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function addInv(item){
  if(user.inv.length>=inventoryLimit){log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!"); return false;}
  user.inv.push(item); return true;
}
// ì°½ê³ 
function showStorage() {
  let html = `<b>[ì°½ê³ ]</b> (${user.storage.length}/100)<br>`;
  if(!user.storage.length) html += `<div style='color:#888'>ì°½ê³ ì— ì €ì¥ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  user.storage.forEach((item, i) => {
    html += `<div class="equipitem">${itemDisplay(item)}
      <div class="item-btns">
        <button class="inv-btn" onclick="moveToInventory(${i})">ì†Œì§€í’ˆìœ¼ë¡œ</button>
      </div></div>`;
  });
  html += `<hr><b>[ì†Œì§€í’ˆì—ì„œ ì°½ê³ ë¡œ ì´ë™]</b><br>`;
  if(!user.inv.length) html += `<div style='color:#888'>ì†Œì§€í’ˆì— ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  user.inv.forEach((item,i)=>{
    html += `<div class="equipitem">${itemDisplay(item)}
      <button class="inv-btn" onclick="moveToStorage(${i})">ì°½ê³ ë¡œ ì´ë™</button>
      </div>`;
  });
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  log(html);
}
function moveToStorage(idx) {
  if(user.storage.length >= 100) {
    log("ì°½ê³ ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!"); return;
  }
  let item = user.inv[idx];
  user.storage.push(item);
  user.inv.splice(idx,1);
  showStorage();
  updateUser();
}
function moveToInventory(idx) {
  if(user.inv.length >= inventoryLimit) {
    log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!"); return;
  }
  let item = user.storage[idx];
  user.inv.push(item);
  user.storage.splice(idx,1);
  showStorage();
  updateUser();
}
// ìºë¦­í„°ì°½(ê¸°ë³¸/ì¥ë¹„í•©ì‚° ìŠ¤íƒ¯)
function showChar() {
  let baseStats = user.stats.slice();
  let equipStats = user.stats.slice();
  let addATK = 0, addRATK = 0, addMATK = 0, addDEF = 0;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if(eq && eq.stat){
      for(let i=0; i<5; i++){
        equipStats[i] += eq.stat[i]||0;
      }
      addATK += eq.stat[5]||0;
      addRATK += eq.stat[6]||0;
      addMATK += eq.stat[7]||0;
      addDEF += eq.stat[3]||0;
    }
  }
  let totalATK = addATK + equipStats[0];
  let totalRATK = addRATK + equipStats[1];
  let totalMATK = addMATK + equipStats[2];
  let totalDEF = equipStats[3];
  let statLabel = ["STR(ê·¼ë ¥)","DEX(ë¯¼ì²©)","INT(ì§€ëŠ¥)","VIT(ì²´ë ¥)","LUK(ìš´)"];
  let baseStr = baseStats.map((v,i)=>`${statLabel[i]}: ${v}`).join(" / ");
  let equipStr = equipStats.map((v,i)=>`${statLabel[i]}: ${v}`).join(" / ");

let html = `<b>[ìºë¦­í„°]</b><br>
<div class="stat-head"> Lv.${user.level} / í™˜ìƒ: ${user.rebirth||0}íšŒ / ê²½í—˜ì¹˜: ${user.exp} / HP: ${user.hp}/${user.maxhp} / ê³¨ë“œ: ${user.gold} / ê°•í™”ì„: ${user.stones||0}</div>
<b>ê¸°ë³¸ ìŠ¤íƒ¯</b><br>${baseStr}<br>
<b>ì¥ë¹„í•©ì‚° ìŠ¤íƒ¯</b><br>${equipStr}<br>
<b>ê³µê²©/ë°©ì–´ë ¥</b><br>ATK: ${totalATK} / RATK: ${totalRATK} / MATK: ${totalMATK} / DEF: ${totalDEF}<br><br>
<b>ì¥ì°© ì¥ë¹„</b><br>`;

  // ì¥ì°© ì¥ë¹„ë„ ì¸ë²¤í† ë¦¬ì²˜ëŸ¼ ë™ì¼í•˜ê²Œ ì¶œë ¥
  for(let slot of equipSlots) {
    let eq = user.equip[slot];
    html += `<div class="equipitem">`;
    if (eq) {
      html += `
        <span>${itemDisplay(eq)}</span>
        <div class="item-btns">
          <button class="inv-btn" onclick="unequip('${slot}')">í•´ì œ</button>
        </div>
      `;
    } else {
      html += `<span style="color:#888">[${slot}] ë¹„ì–´ìˆìŒ</span>`;
    }
    html += `</div>`;
  }

  let setBonusKey = checkUniqueSetBonus();
  let setBonusMsg = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} ì„¸íŠ¸ íš¨ê³¼: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
  html += setBonusMsg;
  html += `<br><button class="inv-btn" onclick="showInv()">ì†Œì§€í’ˆ</button>
  <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`;
  log(html);
}

function showGacha() {
  let html = `<b>[ê°€ì±  ìƒì ]</b><br>
  <span style="color:#ffe161">ê³¨ë“œë¡œ ë¬´ì‘ìœ„ ë³´ìƒì„ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</span><br>
  <button class="inv-btn" onclick="gachaRoll(1)">1íšŒ ë½‘ê¸° (2,000G)</button>
  <button class="inv-btn" onclick="gachaRoll(10)">10íšŒ ë½‘ê¸° (18,000G, 10% í• ì¸)</button>
  <br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  log(html);
}

// ë§ˆì„/ìƒì /ê°•í™”
function showTown(){
  log(`<b>[ë§ˆì„]</b><br>
    <button class="inv-btn" onclick="innRest()">ì—¬ê´€(íœ´ì‹)</button>
    <button class="inv-btn" onclick="showShop()">ì¥ë¹„ìƒì </button>
    <button class="inv-btn" onclick="showEnhance()">ê°•í™”ì†Œ</button>
    <button class="inv-btn" onclick="showGacha()">ê°€ì± ìƒì </button>
    <button class="inv-btn" onclick="showStorage()">ì°½ê³ </button>
    <button class="inv-btn" onclick="rebirth()">í™˜ìƒ</button>
    <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`);
}
function innRest(){
  let cost=20+user.level*5;
  if(user.gold<cost){log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");return;}
  user.gold-=cost; user.hp=user.maxhp;
  log(`ì—¬ê´€ì—ì„œ íœ´ì‹ í›„ HP ì „ë¶€ íšŒë³µ! (${cost}ê³¨ë“œ ì†Œëª¨)<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function showShop() {
  let items = [];
  for(let i=0;i<5;i++) items.push(makeItem(false, true)); // isShop = true
  let html = `<div class="shop-title">[ì¥ë¹„ ìƒì ] (ìƒˆë¡œê³ ì¹¨ì‹œ ìƒí’ˆ ë³€ê²½, ì—í”½ ë“±ê¸‰ ì´ìƒì€ ë¯¸ì¶œí˜„)</div>`;
  items.forEach((item, idx) => {
    html += `<div class="equipitem">${itemDisplay(item)}
      <div class="item-btns">
        <button class="inv-btn" onclick="buyShopItem(${idx})">êµ¬ë§¤ (${50+user.level*8}G)</button>
      </div></div>`;
  });
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  log(html); window.shopItems = items;
}
function buyShopItem(idx) {
  let item = window.shopItems[idx];
  let cost = 50 + user.level*8;
  if(user.gold<cost){log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");return;}
  if(user.inv.length>=inventoryLimit){log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!");return;}
  user.gold -= cost;
  user.inv.push(item);
  log(`êµ¬ë§¤ ì™„ë£Œ!<br>${itemDisplay(item)}<br><button class="inv-btn" onclick="showShop()">ìƒì ìœ¼ë¡œ</button>`);
  updateUser();
}
function showEnhance() {
  let html = `<div class="shop-title">[ì¥ë¹„ ê°•í™”]</div>`;
  let equips = Object.values(user.equip).filter(e => e);
  if (!equips.length) {
    html += `<div style="color:#888">ê°•í™”í•  ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    equips.forEach((eq, idx) => {
      html += `<div class="equipitem">${itemDisplay(eq)}
        <div class="item-btns">
          <button class="enhance-btn" onclick="enhanceItem('${eq.slot}')">ê°•í™”</button>
        </div></div>`;
    });
  }
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  log(html);
}
function gachaRoll(count) {
  let cost = (count === 10) ? 18000 : 2000;
  if(user.gold < cost) {
    log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return;
  }
  user.gold -= cost;
  let results = [];
  for(let i=0; i<count; i++) {
    let r = Math.random() * 100;
    let item;
    if(r < 0.001) { // ìœ ì¼(ì‹ í™”)
      item = makeItem(true, false, null, "ìœ ì¼");
      results.push(`ğŸŸ£ ${itemDisplay(item)}`); addInv(item);
    } else if(r < 0.201) { // ë ˆì „ë”ë¦¬
      item = makeItem(false, false, null, "ë ˆì „ë”ë¦¬");
      results.push(`ğŸŸ¡ ${itemDisplay(item)}`); addInv(item);
    } else if(r < 2.201) { // ì—í”½
      item = makeItem(false, false, null, "ì—í”½");
      results.push(`ğŸŸ  ${itemDisplay(item)}`); addInv(item);
    } else if(r < 9.201) { // ìœ ë‹ˆí¬
      item = makeItem(false, false, null, "ìœ ë‹ˆí¬");
      results.push(`ğŸ”µ ${itemDisplay(item)}`); addInv(item);
    } else if(r < 34.201) { // ê°•í™”ì„
      let stone = rint(1, 10);
      user.stones = (user.stones||0) + stone;
      results.push(`<span style="color:#77e">ğŸ’ ê°•í™”ì„ ${stone}ê°œ íšë“!</span>`);
    } else if(r < 49.201) { // ê³¨ë“œ í™˜ê¸‰
      let gold = rint(150, 300);
      user.gold += gold;
      results.push(`<span style="color:#ffe161">ğŸ’° ë³´ë„ˆìŠ¤ ê³¨ë“œ ${gold} íšë“!</span>`);
    } else { // ë‚˜ë¨¸ì§€: ì¼ë°˜~ìœ ë‹ˆí¬
      item = makeItem(false, false);
      results.push(`âšªï¸ ${itemDisplay(item)}`); addInv(item);
    }
  }
  log(`<b>[ê°€ì±  ê²°ê³¼]</b><br>${results.join("<br>")}<br>
    <button class="inv-btn" onclick="showGacha()">ê°€ì±  ìƒì ìœ¼ë¡œ</button>
    <button class="inv-btn" onclick="showTown()">ë§ˆì„ë¡œ</button>`);
  updateUser();
}
function enhanceItem(slot){
  let eq = user.equip[slot];
  if(!eq) return;
  let lv = eq.enh || 0;
  if(lv>=20){ log("ìµœëŒ€ ê°•í™” ë‹¨ê³„ì…ë‹ˆë‹¤."); return; }
  let needStone = lv < 5 ? [1,2,4,8,20][lv] : lv < 10 ? 20*Math.pow(2, lv-4) : lv < 15 ? 60*Math.pow(3, lv-9) : 120*Math.pow(4, lv-14);
  let needGold = 100 + lv * 50;
  if(user.stones < needStone){ log(`ê°•í™”ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${needStone}, ë³´ìœ : ${user.stones})`); return; }
  if(user.gold < needGold){ log(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${needGold}, ë³´ìœ : ${user.gold})`); return; }
  let prob = lv < 4 ? 1 : lv < 10 ? 0.5-(lv-4)*0.08 : lv < 15 ? 0.12-(lv-10)*0.025 : 0.04-(lv-15)*0.007;
  if(prob < 0.01) prob = 0.01;
  let succ = Math.random() < prob;

  // ë°˜ë“œì‹œ ë¨¼ì € ì°¨ê°!
  user.stones -= needStone;
  user.gold -= needGold;

  if(succ){
    eq.enh = lv + 1;
    if(eq.slot === "ë¬´ê¸°") {
      let atkIndex = 5;
      if(eq.attackType === "ì›ê±°ë¦¬") atkIndex = 6;
      else if(eq.attackType === "ë§ˆë²•") atkIndex = 7;
      eq.stat[atkIndex] = (eq.stat[atkIndex] || 0) + rint(1,3);
      log(`<span class="succ-msg">[+${eq.enh} ê°•í™” ì„±ê³µ! ì£¼ìš” ê³µê²©ë ¥ì´ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!]</span><br>
        <span style="color:#ffe161">ê³¨ë“œ ${needGold} / ê°•í™”ì„ ${needStone} ì†Œëª¨</span>`);
    } else {
      let statIdx = rint(0,4);
      eq.stat[statIdx] = (eq.stat[statIdx]||0) + rint(1,3);
      log(`<span class="succ-msg">[+${eq.enh} ê°•í™” ì„±ê³µ! ìŠ¤íƒ¯ì´ ëœë¤ìœ¼ë¡œ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!]</span><br>
        <span style="color:#ffe161">ê³¨ë“œ ${needGold} / ê°•í™”ì„ ${needStone} ì†Œëª¨</span>`);
    }
  } else {
    log(`<span class="fail-msg">[ê°•í™” ì‹¤íŒ¨]</span><br>
      <span style="color:#ffe161">ê³¨ë“œ ${needGold} / ê°•í™”ì„ ${needStone} ì†Œëª¨</span>`);
  }
  updateUser();
  showEnhance();
}// ì„¸íŠ¸ë³´ë„ˆìŠ¤ ì²´í¬(ìœ ì¼ ì „ìš©)
function checkUniqueSetBonus() {
  const armorSlots = ["ë¨¸ë¦¬", "ìƒì˜", "í•˜ì˜", "ì†", "ì‹ ë°œ"];
  let found = { ê´‘íœ˜:0, í‘ì„¬:0, ìˆ˜ì•”:0, í† ì•”:0 };
  for(let slot of armorSlots){
    let eq = user.equip[slot];
    if(eq && eq.rarity === "ìœ ì¼") {
      let pre = eq.uniqPrefix || (eq.name.split("ì˜")[0]);
      if(found[pre] !== undefined) found[pre]++;
    }
  }
  for(let key in found) if(found[key] >= 4) return key; // 4ì…‹ ë³´ìœ ì‹œ ë°˜í™˜
  return null;
}
function triggerArmorSkills(timing, opts) {
  // opts: {attackDmg, skillAttack, battleLog, userhp, monhp, shieldObj, gotHit, turn, monsterDmg}
  let anyTriggered = false;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if (eq && eq.armorSkill) {
      let rarity = eq.rarity || "ì¼ë°˜";
      let trigRate = armorSkillTriggerRate[rarity] || 0.02;
      if (Math.random() < trigRate) {
        let v = eq.armorSkill.value;
        let type = eq.armorSkill.type;
        let eff = armorSkillLogEffects[type];
        switch (type) {
          case "regen":
            if (timing === "turn") {
              let heal = Math.max(1, Math.floor(user.maxhp * (v / 100)));
              opts.userhp.val = Math.min(user.maxhp, opts.userhp.val + heal);
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(heal)}</span>`);
              anyTriggered = true;
            }
            break;
          case "leech":
            if (timing === "attack" && opts.attackDmg > 0) {
              let leech = Math.max(1, Math.floor(opts.attackDmg * (v / 100)));
              opts.userhp.val = Math.min(user.maxhp, opts.userhp.val + leech);
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(leech)}</span>`);
              anyTriggered = true;
            }
            break;
          case "skillheal":
            if (timing === "attack" && opts.skillAttack && opts.attackDmg > 0) {
              let sheal = Math.max(1, Math.floor(opts.attackDmg * (v / 100)));
              opts.userhp.val = Math.min(user.maxhp, opts.userhp.val + sheal);
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(sheal)}</span>`);
              anyTriggered = true;
            }
            break;
          case "dmgreduce":
            if (timing === "defend") {
              opts.shieldObj.reducePct += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "reflect":
            if (timing === "defend") {
              opts.shieldObj.reflectPct += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "evadeup":
            if (timing === "defend") {
              opts.shieldObj.evadeAdd += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "shield":
            if (timing === "defend" || timing === "turn") {
              opts.shieldObj.shield += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "ignorehit":
            if (timing === "gotHit" && opts.gotHit) {
              if (!eq._usedIgnore) {
                eq._usedIgnore = true;
                opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg()}</span>`);
                opts.monsterDmg.val = 0;
                anyTriggered = true;
              }
            }
            break;
          case "deathproof":
            if (timing === "death" && opts.userhp.val <= 0) {
              if (!eq._usedDeathProof) {
                eq._usedDeathProof = true;
                opts.userhp.val = Math.floor(user.maxhp * 0.3);
                opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg()}</span>`);
                anyTriggered = true;
              }
            }
            break;
          case "skillred":
            if (timing === "defend" && opts.isSkillHit) {
              opts.shieldObj.skillRed += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
        }
      }
    }
  }
  return anyTriggered;
}

// --- ì „íˆ¬ ë©”ì¸ í•¨ìˆ˜ (ìˆ˜ì • ì™„ì„±ë³¸) ---
function battle(type, diffKey) {
  let isDungeon = (type === "dungeon");
  let monster = makeMonster(user.level, isDungeon);
  let monhp = monster.hp + (isDungeon ? rint(5,18) : 0);
  let userhp = { val: user.hp };
  let dropMsg = "";
  let battleLog = [];
  // [ìˆ˜ì •] --- ì¥ë¹„+ìŠ¤íƒ¯ í•©ì‚° ê³µì‹ (ìŠ¤íƒ¯ì°½ê³¼ ë™ì¼í•˜ê²Œ)
  let baseStats = user.stats.slice();
  let equipStats = user.stats.slice();
  let addATK = 0, addRATK = 0, addMATK = 0, addDEF = 0;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if(eq && eq.stat){
      for(let i=0; i<5; i++){
        equipStats[i] += eq.stat[i]||0;
      }
      addATK += eq.stat[5]||0;
      addRATK += eq.stat[6]||0;
      addMATK += eq.stat[7]||0;
      addDEF += eq.stat[3]||0;
    }
  }
  let totalATK   = addATK + equipStats[0];
  let totalRATK  = addRATK + equipStats[1];
  let totalMATK  = addMATK + equipStats[2];
  let totalDEF   = equipStats[3];

  let weapon = user.equip["ë¬´ê¸°"];
  let myATK = totalATK;
  if (weapon) {
    if (weapon.attackType == "ì›ê±°ë¦¬") myATK = totalRATK;
    else if (weapon.attackType == "ë§ˆë²•") myATK = totalMATK;
  }
  let myDEF = totalDEF;

  let setBonusKey = checkUniqueSetBonus();
  let hasGwanghui = setBonusKey === "ê´‘íœ˜";
  let rebirthUsed = false;
  let maxTurn = 10;
  let shieldObj = { reducePct:0, reflectPct:0, evadeAdd:0, shield:0, skillRed:0 };
  let skillTurn = [], finalSkillMsg = "";

  let turn;
  for(turn=1; turn<=maxTurn && userhp.val>0 && monhp>0; turn++) {
    // í„´ ì‹œì‘ íš¨ê³¼
    triggerArmorSkills('turn', {battleLog, userhp, monhp, shieldObj});
    let intChance = Math.min(user.stats[2]/9999 * 0.7, 0.7);
    if(Math.random() < intChance) {
      let heal = Math.floor(user.maxhp * 0.2);
      userhp.val = Math.min(user.maxhp, userhp.val + heal);
      battleLog.push(`<b>[${turn}í„´]</b> <span class="skill-log">âœ¨ [ë§ˆë ¥ íš¨ê³¼] HP ${heal} íšŒë³µ!</span> (ë‚´ HP:${userhp.val})`);
    }

    // ìŠ¤í„´ ì²˜ë¦¬
    if(user.stunned && user.stunned > 0) {
      battleLog.push(`<b>[${turn}í„´]</b> <span class="set-bonus">â³ [í‘ì„¬ ì„¸íŠ¸] ì ì´ ìŠ¤í„´ ìƒíƒœë¡œ í–‰ë™ë¶ˆê°€!</span>`);
      user.stunned--;
    }

    // ê³µê²© íšŸìˆ˜
    let attacksThisTurn = 1;
    if(hasGwanghui) attacksThisTurn += 1;
    let dexChance = Math.min(user.stats[1]/9999 * 0.7, 0.7);
    let dexExtra = (Math.random() < dexChance) ? 1 : 0;
    if(dexExtra) attacksThisTurn += 1;

    // [ê³µê²© ë£¨í”„]
    for(let atkNum=0; atkNum<attacksThisTurn; atkNum++) {
      let effects = [];
      let dmg = rint(myATK-2, myATK+3);
      // ëª¬ìŠ¤í„° ë°©ì–´ë ¥ ì ìš©
      dmg = Math.floor(dmg * 100 / (100 + monster.def));
      if (dmg < 1) dmg = 1;
      let isStrong = (Math.random() < Math.min(user.stats[0]/9999 * 0.7, 0.7));
      if(isStrong) {
        dmg = dmg * 2;
        effects.push(`<span class="skill-log">ğŸ’¥ [í˜: ê°•ê³µê²©]</span>`);
      }

      // ë¬´ê¸°ìŠ¤í‚¬
      let isSkill = weapon && weapon.skill && Math.random() < (weapon.skillTrigger||0);
      if(isSkill) {
        dmg = Math.floor(dmg*1.8) + rint(1,5);
        skillTurn.push(turn);
        finalSkillMsg = `[ìŠ¤í‚¬ ë°œë™] ${weapon.skill}ë¡œ ê°•ë ¥í•œ ì¼ê²©!`;
        effects.push(`<span class="skill-log">ğŸ”¥ [ë¬´ê¸°ìŠ¤í‚¬: ${weapon.skill}]</span>`);
      }

      // ë°©ì–´êµ¬ ìŠ¤í‚¬(í¡í˜ˆ ë“±)
      triggerArmorSkills('attack', {
        attackDmg: dmg, skillAttack: isSkill, battleLog, userhp, monhp, shieldObj
      });

      // í‘ì„¬(ìŠ¤í„´)
      if(setBonusKey==="í‘ì„¬" && Math.random()<0.3){
        user.stunned = 1;
        effects.push(`<span class="set-bonus">â³ [í‘ì„¬ ì„¸íŠ¸: ìŠ¤í„´!]</span>`);
      }

      let monsterNameDisplay = monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name;
      let finalDmg = Math.floor(dmg * 100 / (100 + (monster.def||0)));
      if (finalDmg < 1) finalDmg = 1;
      monhp -= finalDmg;
      if(monhp < 0) monhp = 0;
      battleLog.push(`<b>[${turn}í„´ ê³µê²©${atkNum+1}]</b> ${effects.join(" ")}<span style="font-weight:bold;">${user.name}ì˜ ê³µê²©!</span> <span class="dmg-log">${monsterNameDisplay}ì—ê²Œ ${finalDmg}ì˜ í”¼í•´</span> (ëª¬ìŠ¤í„° HP:${Math.max(monhp,0)})`);
      if(monhp <= 0) break;
    }
    if(monhp <= 0) break;
    if(user.stunned && user.stunned > 0) { user.stunned--; continue; }

    // ëª¬ìŠ¤í„° ê³µê²©
    let monsterRawDmg = monster.atk + rint(-2, 3);
    if (monsterRawDmg < 1) monsterRawDmg = 1;
    let monsterDmgVal = Math.floor(monsterRawDmg * 100 / (100 + myDEF));
    if (monsterDmgVal < 1) monsterDmgVal = 1;
    let monsterDmg = { val: monsterDmgVal };
    triggerArmorSkills('defend', {
      battleLog, userhp, monhp, shieldObj, isSkillHit: false
    });

    if (shieldObj.shield > 0) {
      let absorb = Math.min(shieldObj.shield, monsterDmg.val);
      shieldObj.shield -= absorb;
      monsterDmg.val -= absorb;
      battleLog.push(`<span style="color:#e3ffd8;font-weight:bold;">ğŸ›¡ï¸ [ì‹¤ë“œ] í”¼í•´ ${absorb} í¡ìˆ˜ (ì”ì—¬ ${shieldObj.shield})</span>`);
    }
    if (shieldObj.reflectPct > 0) {
      let reflect = Math.floor(monsterDmg.val * (shieldObj.reflectPct / 100));
      monhp -= reflect;
      battleLog.push(`<span style="color:#8ef6f2">ğŸª [ë°˜ì‚¬] ${reflect} ë°˜ì‚¬</span>`);
    }
    if (shieldObj.reducePct > 0) {
      monsterDmg.val = Math.max(1, Math.floor(monsterDmg.val * (1-shieldObj.reducePct/100)));
    }
    if (shieldObj.skillRed > 0) {
      monsterDmg.val = Math.max(1, Math.floor(monsterDmg.val * (1-shieldObj.skillRed/100)));
    }
    let evadeChance = Math.min(user.stats[4]/9999 * 0.7, 0.7) + (shieldObj.evadeAdd/100);
    if(Math.random() < evadeChance) {
      battleLog.push(`<span class="dmg-log">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}ì˜ ê³µê²©! â†’ <b>ğŸŒ€ [íšŒí”¼!]</b> (ë‚´ HP:${Math.max(userhp.val,0)})</span>`);
      continue;
    }
    let gotHit = true;
    triggerArmorSkills('gotHit', {battleLog, userhp, monhp, shieldObj, gotHit, monsterDmg});
    if(monsterDmg.val <= 0) continue;

    userhp.val -= monsterDmg.val;
    battleLog.push(`${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}ì˜ ê³µê²©! <span class="dmg-log">${user.name}ì—ê²Œ ${monsterDmg.val} í”¼í•´</span> (ë‚´ HP:${Math.max(userhp.val,0)})`);

    triggerArmorSkills('death', {battleLog, userhp, monhp, shieldObj});

    if(userhp.val<=0 && setBonusKey==="í† ì•”" && !rebirthUsed){
      rebirthUsed = true; userhp.val = Math.floor(user.maxhp*0.5);
      battleLog.push(`<span class="set-bonus">ğŸª¨ [í† ì•” ì„¸íŠ¸: 1íšŒ ë¶€í™œ! HP ${userhp.val}ë¡œ ë¶€í™œ]</span>`);
    }
    if(userhp.val <= 0) { userhp.val = 0; break; }
    shieldObj = { reducePct:0, reflectPct:0, evadeAdd:0, shield:shieldObj.shield, skillRed:0 };
  }
  turn--;

  // í”Œë˜ê·¸ ì´ˆê¸°í™”
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if(eq) {
      delete eq._usedIgnore;
      delete eq._usedDeathProof;
    }
  }

  // ë³´ìƒ ë° ê²°ê³¼ ì²˜ë¦¬ (ì´ ë¶€ë¶„ ë™ì¼)
  let win = (monhp<=0 && turn<=maxTurn);
  if(turn>maxTurn) win = false;
  let baseExp = isDungeon ? Math.floor(user.level*4)+rint(16,32) : Math.floor(user.level*1.7)+rint(6,16);
  let baseGold = isDungeon ? rint(32,80)+Math.floor(user.level*4.2) : rint(10,20)+Math.floor(user.level*1.4);
  let hpLoss = user.hp-userhp.val;
  let rewardMsg = "";
  if(win){
    let gain = baseExp; let gold = baseGold; let dropMsg = "", stoneMsg="";
    // íƒí—˜ì—ì„œë§Œ ë“±ê¸‰ ì œí•œ ë³´ìƒ ì ìš©
    if(type === "explore") {
      if(Math.random() < 0.5) {
        let item = getExploreItem(diffKey);
        if(addInv(item)) dropMsg = `<br>ì•„ì´í…œ íšë“! ${itemDisplay(item)}`;
      }
    } else {
      if (Math.random() < (isDungeon?0.5:0.25)) {
        let item = makeItem(isDungeon, false, monster.unique ? monster.name : null);
        if (addInv(item)) dropMsg = `<br>ì•„ì´í…œ íšë“! ${itemDisplay(item)}`;
      }
    }
    if (Math.random() < (isDungeon ? 0.15 : 0.10)) {
      let stonesDrop = rint(1, 10);
      user.stones = (user.stones || 0) + stonesDrop;
      stoneMsg = `<br><span style="color:#77e;">ê°•í™”ì„ ${stonesDrop}ê°œë¥¼ íšë“í–ˆë‹¤!</span>`;
    }
    user.exp += gain; user.gold += gold;
    user.hp = Math.max(1,userhp.val);
    let setBonusDesc = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} ì„¸íŠ¸ íš¨ê³¼: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
    rewardMsg = `<br><b>ìŠ¹ë¦¬!</b> ê²½í—˜ì¹˜ +${gain}, ê³¨ë“œ +${gold}, HP -${hpLoss}${finalSkillMsg?`<br><span class="skill-log">${finalSkillMsg}</span>`:""}${setBonusDesc}${dropMsg}${stoneMsg}`;
    levelupCheck();
  } else {
    user.hp = userhp.val; if(userhp.val<=0) user.hp=1;
    rewardMsg = `<br><span class="dead-log">íŒ¨ë°°! 10í„´ ì´ˆê³¼ í˜¹ì€ ëª¬ìŠ¤í„°ì—ê²Œ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤. HP ${userhp.val<=0?'1ë¡œ ë³µêµ¬':`(${userhp.val})`}.</span>`;
    if(isDungeon && userhp.val<=0){
      let lost = [];
      if(Math.random()<0.2){
        let candidates = equipSlots.filter(s=>user.equip[s]);
        if(candidates.length){
          let lostSlot = candidates[rint(0,candidates.length-1)];
          let lostItem = user.equip[lostSlot];
          user.equip[lostSlot] = undefined; lost.push(lostItem.name);
        }
      }
      if(lost.length) rewardMsg += `<br><span class="dead-log">[ì¥ë¹„ ì†ì‹¤] ${lost.join(", ")}</span>`;
    }
  if (exploring) exploring.done = true;
  }
  log(`[${isDungeon?'ë˜ì „':'ì‚¬ëƒ¥'}] <span class="monname">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}</span>ê³¼ì˜ í„´ì œ ì „íˆ¬ (ìµœëŒ€ 10í„´)<br>` + battleLog.join("<br>") + rewardMsg);
  updateUser();
}
function action(type){
  // HPê°€ 1ì¼ ë•ŒëŠ” ì‚¬ëƒ¥, ë˜ì „ ëª¨ë‘ ì…ì¥/ì‹¤í–‰ ë¶ˆê°€
  if(user.hp <= 1){
    log("<span class='dead-log'>HPê°€ 1ì¼ ë•ŒëŠ” ì „íˆ¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ì—¬ê´€ì—ì„œ íšŒë³µí•˜ì„¸ìš”.</span>");
    return;
  }
  battle(type);
}
function dungeonEnterUI() {
  log(`<b>[ë˜ì „ ì…ì¥]</b><br>
  <span style="color:#ffd700;">ë˜ì „ì—ì„œ ì£½ìœ¼ë©´ í™•ë¥ ì ìœ¼ë¡œ ì¥ë¹„ë¥¼ ìƒì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span><br><br>
  <button class="inv-btn" onclick="dungeonAction()">ì…ì¥í•˜ê¸°</button>
  <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ì·¨ì†Œ</button>`);
}
function dungeonAction(){ battle("dungeon"); }
// ë ˆë²¨ì—… ë° ìŠ¤íƒ¯
function levelupCheck(){
  while(user.exp>=expNeed(user.level) && user.level<999){
    user.exp -= expNeed(user.level);
    user.level++;
    statRandAdd(user.stats);
    user.maxhp += 5+rint(0,5);
    user.hp = user.maxhp;
    log(`[LEVEL UP!] Lv.${user.level}ë¡œ ì˜¬ëìŠµë‹ˆë‹¤!`);
  }
}
function statRandAdd(stats){
  let idx = rint(0,stats.length-1);
  stats[idx]++;
}
let exploring = null;
let exploringStageSource = "hunt"; // battle íƒ€ì… ì €ì¥ìš©
const exploreMaps = [
  "ì´ˆì›", "ìˆ²", "ë™êµ´", "íí—ˆ", "ì‚¬ë§‰", "ë¹™ì„¤", "í™”ì‚°", "ëŠªì§€", "ìœ ì ", "ì‚°ë§¥",
  "ì˜¤ì•„ì‹œìŠ¤", "ë¶„í™”êµ¬", "í‘ìš”ì•” í˜‘ê³¡", "ë¹™í•˜ ëŒ€ì§€", "í™©í˜¼ ê³ ì›"
];
function showExploreMain() {
  if(user.level < 150){
    log("<span class='dead-log'>Lv.150ë¶€í„° íƒí—˜ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!</span>");
    return;
  }
  let html = `<b>[íƒí—˜]</b><br>
    <span style='color:#ffe161'>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ë©´ ëœë¤ ì§€ì—­ì—ì„œ íƒí—˜ì´ ì‹œì‘ë©ë‹ˆë‹¤.</span><br>`;
  difficulties.forEach(diff => {
    html += `<button class="inv-btn" onclick="beginExploreRandomMap('${diff.key}')">${diff.label}</button>
             - <span style='color:#ccc'>${diff.desc} (Lv.${diff.minLv}+)</span><br>`;
  });
  html += `<button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`;
  log(html);
}
function beginExploreRandomMap(diffKey) {
  let diff = difficulties.find(d => d.key === diffKey);
  if(user.level < diff.minLv){
    log(`<span class='dead-log'>${diff.label} ë‚œì´ë„ëŠ” Lv.${diff.minLv}ë¶€í„° ì…ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤!</span>`);
    return;
  }
  // ë§µ ë¬´ì‘ìœ„ ë°°ì •
  let mapIdx = rint(0, exploreMaps.length-1);
  let zone = exploreMaps[mapIdx];
  // ì´í•˜ ê¸°ì¡´ íƒí—˜ ì‹œì‘ ë¡œì§ (zone, diff.key)
  beginExplore(zone, diff.key);
}
const diffMap = { 
  "ì‰¬ì›€": 0.85, 
  "ë³´í†µ": 1.2, 
  "ì–´ë ¤ì›€": 1.5, 
  "ë§¤ìš°ì–´ë ¤ì›€": 2.0, 
  "ì§€ì˜¥": 2.7 
};
const difficulties = [
  { key:"ì‰¬ì›€", minLv:150, label:"ì‰¬ì›€(EASY)", desc:"ì‰¬ìš´ë‚œì´ë„ì…ë‹ˆë‹¤.", bonus:0.7 },
  { key:"ë³´í†µ", minLv:180, label:"ë³´í†µ(NORMAL)", desc:"ê¸°ë³¸", bonus:1.3 },
  { key:"ì–´ë ¤ì›€", minLv:260, label:"ì–´ë ¤ì›€(HARD)", desc:"ì–´ë ¤ìš´ ë‚œì´ë„ ì…ë‹ˆë‹¤.", bonus:2.1 },
  { key:"ë§¤ìš°ì–´ë ¤ì›€", minLv:420, label:"ë§¤ìš° ì–´ë ¤ì›€(HELL)", desc:"ë„ì „ì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš”?", bonus:3.3 },
  { key:"ì§€ì˜¥", minLv:680, label:"ì§€ì˜¥(INFERNO)", desc:"ê·¹ì•…", bonus:6.5 }
];
function chooseExploreZone(zone) {
  let html = `<b>[${zone} - ë‚œì´ë„ ì„ íƒ]</b><br>`;
  difficulties.forEach(diff => {
    html += `<button class="inv-btn" onclick="beginExplore('${zone}','${diff.key}')">${diff.label}</button> - <span style='color:#ccc'>${diff.desc} (Lv.${diff.minLv}+)</span><br>`;
  });
  html += `<button class="inv-btn" onclick="showExploreMain()">ë‚œì´ë„ ë‹¤ì‹œ ì„ íƒ</button>`;
  log(html);
}
function beginExplore(zone, diff) {
  if (exploring && !exploring.done) {
    log("<span class='dead-log'>ì´ë¯¸ íƒí—˜ ì¤‘ì…ë‹ˆë‹¤! ì§„í–‰ì„ ëë‚´ì„¸ìš”.</span>");
    return;
  }
  const maxStage = rint(6, 10); // 6~10ìŠ¤í…Œì´ì§€
  exploring = {
    zone, diff, done: false,
    stage: 1, maxStage,
    progress: [],
    rewardSum: { gold: 0, exp: 0, stones: 0, item: 0 }
  };
  showExploreProgress();
}
// íƒí—˜ ì´ë²¤íŠ¸ ì „íˆ¬ ë¦¬ì›Œë“œ ë³´ìƒ - ë‚œì´ë„ë³„ ì ìš©
function getExploreRewardRarity(diff) {
  // ë‚œì´ë„ë³„ ë³´ìƒ ë“±ê¸‰ê³¼ í™•ë¥ 
  // [ë“±ê¸‰, í™•ë¥ ] (ì „ì²´í•© 100%ëŠ” ì•„ë‹ˆì–´ë„ ë¨)
  const table = {
    "ì‰¬ì›€": [
      ["ì§€ì˜¥",   0.002],
      ["ìœ ì¼",   0.01],
      ["ë ˆì „ë”ë¦¬", 0.15],
      ["ì—í”½",   1],
      ["ìœ ë‹ˆí¬", 5],
      ["ë ˆì–´",   30],
      ["ì¼ë°˜",   100]
    ],
    "ë³´í†µ": [
      ["ì§€ì˜¥",   0.005],
      ["ìœ ì¼",   0.03],
      ["ë ˆì „ë”ë¦¬", 0.3],
      ["ì—í”½",   2],
      ["ìœ ë‹ˆí¬", 9],
      ["ë ˆì–´",   40],
      ["ì¼ë°˜",   100]
    ],
    "ì–´ë ¤ì›€": [
      ["ì§€ì˜¥",   0.01],
      ["ìœ ì¼",   0.07],
      ["ë ˆì „ë”ë¦¬", 1],
      ["ì—í”½",   4],
      ["ìœ ë‹ˆí¬", 18],
      ["ë ˆì–´",   50],
      ["ì¼ë°˜",   100]
    ],
    "ë§¤ìš°ì–´ë ¤ì›€": [
      ["ì§€ì˜¥",   0.025],
      ["ìœ ì¼",   0.17],
      ["ë ˆì „ë”ë¦¬", 2.5],
      ["ì—í”½",   7],
      ["ìœ ë‹ˆí¬", 28],
      ["ë ˆì–´",   65],
      ["ì¼ë°˜",   100]
    ],
    "ì§€ì˜¥": [
      ["ì§€ì˜¥",   0.05],
      ["ìœ ì¼",   0.25],
      ["ë ˆì „ë”ë¦¬", 5],
      ["ì—í”½",   10],
      ["ìœ ë‹ˆí¬", 38],
      ["ë ˆì–´",   80],
      ["ì¼ë°˜",   100]
    ],
  };
  let rates = table[diff] || table["ì‰¬ì›€"];
  let r = Math.random() * 100;
  let acc = 0;
  for (let [rarity, prob] of rates) {
    acc += prob;
    if (r < acc) return rarity;
  }
  return "ì¼ë°˜";
}
function getExploreItem(diff) {
  let rarity = getExploreRewardRarity(diff);
  return makeItem(false, false, null, rarity);
}
function showExploreProgress() {
  if (!exploring) return;
  let html = `<b>[íƒí—˜: ${exploring.zone} / ${exploring.diff}]</b><br>
  ì§„í–‰ë„: ${exploring.stage > exploring.maxStage ? exploring.maxStage : exploring.stage} / ${exploring.maxStage}<br>
  <span style="color:#ffe161">íšë“: GOLD ${exploring.rewardSum.gold} / EXP ${exploring.rewardSum.exp} / ê°•í™”ì„ ${exploring.rewardSum.stones} / ì•„ì´í…œ ${exploring.rewardSum.item}</span><br>`;
  if (exploring.done || exploring.stage > exploring.maxStage) {
    html += `<br><b>íƒí—˜ ì¢…ë£Œ!</b><br>
    <span style="color:#b8ffad">ë³´ìƒí•©ê³„:<br>
    GOLD:${exploring.rewardSum.gold}, EXP:${exploring.rewardSum.exp}, ê°•í™”ì„:${exploring.rewardSum.stones}, ì•„ì´í…œ:${exploring.rewardSum.item}</span><br>
    <button class="inv-btn" onclick="exploring=null;updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`;
    log(html);
    exploring = null;
    return;
  }
  html += `<button class="inv-btn" onclick="exploreNextStage()">ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰</button>
  <button class="inv-btn" onclick="if(confirm('íƒí—˜ì„ ì •ë§ ì¤‘ë‹¨í•©ë‹ˆê¹Œ?')) { exploring=null; updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°'); }">íƒí—˜ ì¤‘ë‹¨</button>`;
  log(html);
}
function exploreNextStage() {
  if (!exploring || exploring.done) return;
  if (user.hp <= 1) { // HP 1 ì´í•˜: ìë™ ì¢…ë£Œ
    exploring.done = true;
    showExploreProgress();
    return;
  }
  let stage = exploring.stage;
  // ì´ë²¤íŠ¸ ì¢…ë¥˜ ê²°ì • (ì „íˆ¬/ë³´ìƒ/íœ´ì‹)
  let roll = Math.random();
  let eType = "battle";
  if (roll < 0.16) eType = "reward";
  else if (roll < 0.25) eType = "rest";
  else if (roll > 0.92) eType = "elite";
  // ë‚œì´ë„ ë³´ì •
  let diff = exploring.diff;
  let desc = "";
  if (eType === "battle") desc = "ì¼ë°˜ ëª¬ìŠ¤í„°ì™€ ì „íˆ¬!";
  if (eType === "elite") desc = "<span class='unique-monster'>ì—˜ë¦¬íŠ¸ ëª¬ìŠ¤í„°ì™€ ì „íˆ¬!</span>";
  if (eType === "reward") desc = "<span style='color:#bbeeff'>ë³´ë¬¼ ë°œê²¬! ì¶”ê°€ ë³´ìƒ!</span>";
  if (eType === "rest") desc = "<span style='color:#8aff8a'>ì•ˆì „í•œ ì¥ì†Œ ë°œê²¬! íœ´ì‹ ê°€ëŠ¥</span>";
  // ì „íˆ¬/ì´ë²¤íŠ¸ ë²„íŠ¼
  let nextBtn = `<button class="inv-btn" onclick="resolveExploreEvent('${eType}')">ì´ë²¤íŠ¸ ì§„í–‰</button>`;
  log(`<b>[íƒí—˜ - ${exploring.zone}]</b><br>ìŠ¤í…Œì´ì§€ ${stage} / ${exploring.maxStage}<br>${desc}<br>${nextBtn}`);
}
function resolveExploreEvent(eType) {
  let diff = exploring.diff;
  // ë‚œì´ë„ ë°°ìœ¨: ì‰¬ì›€ 0.7, ë³´í†µ 1.0, ì–´ë ¤ì›€ 1.2, ë§¤ìš°ì–´ë ¤ì›€ 1.35
  let diffMap = { "ì‰¬ì›€":0.7, "ë³´í†µ":1.0, "ì–´ë ¤ì›€":1.2, "ë§¤ìš°ì–´ë ¤ì›€":1.35 };
  let diffBonus = diffMap[diff] || 1.0;
if (eType === "battle" || eType === "elite") {
  exploringStageSource = (eType === "battle" ? "hunt" : "dungeon");
  let oldMakeMonster = window.makeMonster;
  // diffëŠ” exploring.diffë¡œë¶€í„° ë°›ì€ ë‚œì´ë„ ë¬¸ìì—´ (ex: "ì‰¬ì›€", "ì§€ì˜¥" ë“±)
  let diffBonus = diffMap[diff] || 1.0;
  window.makeMonster = function(level, isDungeon = false) {
    let m = oldMakeMonster(level, isDungeon);
    m.hp = Math.round(m.hp * diffBonus);
    m.atk = Math.round(m.atk * diffBonus);
    m.def = Math.round(m.def * diffBonus);
    return m;
  };
    let gold0 = user.gold, exp0 = user.exp, stones0 = user.stones, inv0 = user.inv.length;
     battle("explore", diff);
 setTimeout(() => {
      window.makeMonster = oldMakeMonster;
      // *** ë³´ìƒ í›„ [ë‹¤ìŒ] ë²„íŠ¼ ì‚½ì… ***
      let goldGet = user.gold - gold0;
      let expGet = user.exp - exp0;
      let stoneGet = (user.stones||0) - (stones0||0);
      let itemGet = Math.max(0, user.inv.length - inv0);
      exploring.rewardSum.gold += Math.max(0,goldGet);
      exploring.rewardSum.exp += Math.max(0,expGet);
      exploring.rewardSum.stones += Math.max(0,stoneGet);
      exploring.rewardSum.item += itemGet;

      // [ë‹¤ìŒ] ë²„íŠ¼ìœ¼ë¡œë§Œ íƒí—˜ ì§„í–‰
      let btn = `<br><button class="inv-btn" onclick="afterExploreEvent()">ë‹¤ìŒ</button>`;
      let lastLog = document.getElementById("logbox").innerHTML;
      document.getElementById("logbox").innerHTML = lastLog + btn;
    }, 300);
    return;
  }

  if (eType === "reward") {
    // ë‚œì´ë„ë³„ ì¶”ê°€ ë³´ìƒ
    let gold = Math.round(rint(40,90) * diffBonus);
    let stones = rint(0,1+Math.floor(diffBonus*3));
    let exp = Math.round(rint(15,40) * diffBonus);
    user.gold += gold; user.stones = (user.stones||0) + stones; user.exp += exp;
    exploring.rewardSum.gold += gold;
    exploring.rewardSum.stones += stones;
    exploring.rewardSum.exp += exp;
    log(`<span style="color:#bbeeff">[ë³´ë¬¼ ë°œê²¬] GOLD+${gold}, ê°•í™”ì„+${stones}, EXP+${exp}</span><br>
    <button class="inv-btn" onclick="afterExploreEvent()">ë‹¤ìŒ</button>`);
    return;
  }
  if (eType === "rest") {
    let heal = Math.round(user.maxhp * 0.24 + rint(2,10));
    user.hp = Math.min(user.maxhp, user.hp + heal);
    log(`<span style="color:#8aff8a">[íœ´ì‹ ì„±ê³µ] HP +${heal} íšŒë³µ!</span><br>
    <button class="inv-btn" onclick="afterExploreEvent()">ë‹¤ìŒ</button>`);
    return;
  }
}
function afterExploreEvent() {
  exploring.stage++;
  showExploreProgress();
}
// í™˜ìƒ: ì¥ë¹„ ì°©ìš©/ì°½ê³ ë§Œ ìœ ì§€, ì†Œì§€í’ˆ ì´ˆê¸°í™”
function rebirth(){
  if(user.level<999){log("ë ˆë²¨ 999 ë‹¬ì„± ì‹œì—ë§Œ í™˜ìƒ ê°€ëŠ¥!<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>");return;}
  if(!confirm("í™˜ìƒ ì‹œ ë ˆë²¨/ìŠ¤íƒ¯/ì†Œì§€í’ˆ/ê³¨ë“œê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì°©ìš©ì¥ë¹„ì™€ ì°½ê³ ëŠ” ìœ ì§€ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;
  let keepEquip = {};
  for(let slot of equipSlots) if(user.equip[slot]) keepEquip[slot] = user.equip[slot];
  let keepStorage = user.storage||[];
  user.rebirth = (user.rebirth||0) + 1;  // ë¨¼ì € ì¦ê°€ì‹œí‚´!
  user.level=1; user.exp=0; user.gold=100;
  user.stats = [1,1,1,1,1].map(x => x + user.rebirth * 10); // í™˜ìƒ ëˆ„ì !
  user.statmax=9999; user.hp=30; user.maxhp=30;
  user.equip=keepEquip; user.inv=[]; user.stones=0; user.storage = keepStorage;
  log("í™˜ìƒ ì™„ë£Œ! ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ +10ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>");
  updateUser();
}
</script>
</body>
</html>
