<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Elgasia - Text RPG ver1.015</title>
  <style>
    body { font-family: 'Malgun Gothic', sans-serif; background: #232236; color: #fff; margin: 0; padding: 0;}
    #main { max-width: 900px; margin: 40px auto; background: #181828; padding: 30px; border-radius: 20px; box-shadow: 0 0 30px #0008;}
    .stat-box { margin: 12px 0 24px 0; }
    .stat-box span { display: inline-block; margin-right: 18px; font-size: 18px; }
    .btn-bar button { background: #384085; color: #fff; border: none; border-radius: 7px; margin: 4px; padding: 10px 20px; font-size: 17px; cursor: pointer; transition: background 0.15s;}
    .btn-bar button:disabled { background: #333; color: #aaa; cursor: not-allowed; }
    .equip-rare { color: #51cafc; } .equip-unique { color: #d76bff; } .equip-epic { color: #ff90b5; }
    .equip-legend { color: gold; } .equip-myth { color: #fa4242; font-weight: bold;}
    .equip-normal { color: #fff;}
    .log { border: 1px solid #222; background: #191934; margin: 16px 0; border-radius: 10px; min-height: 120px; padding: 14px; font-size:17px;}
    .inv-btn { margin-left: 8px; background: #384085; color: #fff; border: none; border-radius: 5px; padding: 2px 9px; font-size: 14px;}
    .inv-btn:disabled { color: #888;}
    .equipitem { font-size: 15px;}
    .equip-bonus {font-size:14px;color:#b8ffad;}
    .namebox input { font-size:18px; padding:3px 8px; border-radius:7px; border:1px solid #555;}
    .save-bar button { background: #515b9d; color: #fff; border: none; border-radius: 6px; margin: 2px; padding: 7px 15px; font-size: 15px;}
    .save-slot-btn { background:#2e2e4e; color:#fff; margin:7px; padding:15px 30px; font-size:22px; border-radius:10px; border:none;}
    .shop-item { margin:8px 0; padding:12px; border-radius:10px; background: #21214a; box-shadow: 0 2px 8px #0003;}
    .shop-item .equip-bonus { color:#bbeeff; }
    .shop-title { color:#ffe680; font-size: 21px; margin-bottom:10px;}
    .enhance-btn { background: #1f8e26; color: #fff; margin-left:12px; border-radius:6px;}
    .fail-msg { color:#ff6161; font-weight:bold; }
    .succ-msg { color:#8aff8a; font-weight:bold; }
    .enh-lv { color:#e7e553; font-weight:bold;}
    .monname { color:#ffd700; font-weight:bold;}
    .save-del-btn { background:#a23c3c; color:#fff; border-radius:7px; border:none; font-size:14px; padding:4px 14px; margin-left:8px;}
    .ilv-txt { color:#9ed1f7; font-weight:bold; margin-right:8px; }
    .skill-log { color:#ffea64; font-weight:bold; }
    .dmg-log { color:#fba; }
    .dead-log { color:#fa4247; font-weight:bold; }
    .unique-monster { color:#ff5555; font-weight:bold; }
    .set-bonus { color: #ffe161; font-weight: bold;}
  </style>
</head>
<body>
<div id="main">
  <div id="loadslotbox"></div>
  <div id="userinfo" style="display:none"></div>
  <div class="btn-bar" id="menubar" style="display:none">
    <button onclick="action('hunt')">ì‚¬ëƒ¥</button>
    <button onclick="dungeonEnterUI()">ë˜ì „</button>
    <button onclick="showChar()">ìºë¦­í„°</button>
    <button onclick="showInv()">ì†Œì§€í’ˆ</button>
    <button onclick="showTown()">ë§ˆì„</button>
  </div>
  <div class="save-bar" id="savebar" style="display:none">
    <button onclick="saveGame()">ğŸ’¾ ì„¸ì´ë¸Œ</button>
    <button onclick="showLoad()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <span style="color:#aaa;">(ìŠ¬ë¡¯ <span id="slotsel"></span>)</span>
  </div>
  <div class="log" id="logbox"></div>
</div>
<script>
const itemStatTable = {
  "ì¼ë°˜":     { base:[0, 2],    atk:[1, 3]   },
  "ë ˆì–´":     { base:[2, 4],    atk:[3, 6]   },
  "ìœ ë‹ˆí¬":   { base:[4, 7],    atk:[6, 10]  },
  "ì—í”½":     { base:[7, 11],   atk:[10, 15] },
  "ë ˆì „ë”ë¦¬": { base:[12, 18],  atk:[16, 22] },
  "ìœ ì¼":     { base:[18, 27],  atk:[25, 35] }
};
const armorSkillEffectScale = {
  "ì¼ë°˜":     1,
  "ë ˆì–´":     1,
  "ìœ ë‹ˆí¬":   1.2,
  "ì—í”½":     1.5,
  "ë ˆì „ë”ë¦¬": 2,
  "ìœ ì¼":     3
};
const armorSkillPool = [
  { name: "ìƒëª…íšŒë³µ",     type: "regen",      base: [1, 2]  },  // í„´ë§ˆë‹¤ %íšŒë³µ
  { name: "í”¼í•´í¡í˜ˆ",     type: "leech",      base: [1, 2]  },  // í”¼í•´ì˜ % í¡ìˆ˜
  { name: "ë°›ëŠ”í”¼í•´ê°ì†Œ", type: "dmgreduce",  base: [2, 4]  },  // %ê°ì†Œ
  { name: "ì²«í”¼ê²©ë¬´ì‹œ",   type: "ignorehit",  base: [1, 1]  },  // níšŒ
  { name: "ì‚¬ë§ë°©ì§€",     type: "deathproof", base: [1, 1]  },  // níšŒ
  { name: "ê³µê²©ë°˜ì‚¬",     type: "reflect",    base: [2, 3]  },  // %ë°˜ì‚¬
  { name: "íšŒí”¼ì¦ê°€",     type: "evadeup",    base: [3, 4]  },  // %ìƒìŠ¹
  { name: "ì‹¤ë“œë¶€ì—¬",     type: "shield",     base: [20, 24]}   // ì‹¤ë“œëŸ‰
];
const armorSkillLogEffects = {
  "regen":        { icon:"ğŸ’š",  color:"#5eff86",  msg: v=>`HP +${v}% íšŒë³µ` },
  "leech":        { icon:"ğŸ©¸",  color:"#c9488a",  msg: v=>`í”¼í•´ì˜ ${v}% í¡í˜ˆ` },
  "dmgreduce":    { icon:"ğŸ›¡ï¸", color:"#a1f2ff",  msg: v=>`ë°›ëŠ” í”¼í•´ -${v}%` },
  "ignorehit":    { icon:"ğŸ§±",  color:"#c8d7e2",  msg: v=>`ì²« í”¼ê²© ë¬´ì‹œ` },
  "deathproof":   { icon:"âš°ï¸",  color:"#f0f055",  msg: v=>`ì‚¬ë§ë°©ì§€` },
  "reflect":      { icon:"ğŸª",  color:"#8ef6f2",  msg: v=>`ê³µê²©ë°˜ì‚¬ +${v}%` },
  "evadeup":      { icon:"ğŸƒâ€â™‚ï¸",color:"#8af8a7",  msg: v=>`íšŒí”¼ +${v}%` },
  "shield":       { icon:"ğŸ›¡ï¸", color:"#e3ffd8",  msg: v=>`ì‹¤ë“œ +${v}` },
};

const statNames = ["STR", "DEX", "INT", "VIT", "LUK"];
const equipSlots = ["ë¨¸ë¦¬", "ìƒì˜", "í•˜ì˜", "ì†", "ì‹ ë°œ", "ë¬´ê¸°", "ë°©íŒ¨"];
const prefixes = ["ë¶ˆíƒ€ëŠ”", "ì‹ ì†í•œ", "ê³ ëŒ€ì˜", "ë¹›ë‚˜ëŠ”", "ê°•ì¸í•œ", "ì¬ë¹ ë¥¸", "í˜„ìì˜", "ì•”í‘ì˜", "ë‹¨ë‹¨í•œ", "ìš©ë§¹í•œ"];
const suffixes = ["ê´‘ê¸°", "ì§€í˜œ", "ì†ë„", "í–‰ìš´", "í˜", "ìˆ˜í˜¸", "íŒŒë©¸", "ë§ˆë²•", "ë¶ˆë©¸", "ìš©ê¸°"];
const rarityOrder = ["ì¼ë°˜","ë ˆì–´","ìœ ë‹ˆí¬","ì—í”½","ë ˆì „ë”ë¦¬","ìœ ì¼"];
const rarityColors = { "ì¼ë°˜":"equip-normal", "ë ˆì–´":"equip-rare", "ìœ ë‹ˆí¬":"equip-unique", "ì—í”½":"equip-epic", "ë ˆì „ë”ë¦¬":"equip-legend", "ìœ ì¼":"equip-myth" };
const rarityRate = [60,20,5,1,0.01,0];
const dungeonRate = [45,25,10,6,1,0.1];
const inventoryLimit = 40;
const skillTriggerRate = { "ì¼ë°˜": 0.02, "ë ˆì–´": 0.04, "ìœ ë‹ˆí¬": 0.07, "ì—í”½": 0.10, "ë ˆì „ë”ë¦¬": 0.15, "ìœ ì¼": 0.33 };
const skillGiveRate = { "ì¼ë°˜": 0.02, "ë ˆì–´": 0.06, "ìœ ë‹ˆí¬": 0.10, "ì—í”½": 0.18, "ë ˆì „ë”ë¦¬": 0.25, "ìœ ì¼": 1.0 };
const armorSkillTriggerRate = {"ì¼ë°˜": 0.03, "ë ˆì–´": 0.05, "ìœ ë‹ˆí¬": 0.07, "ì—í”½": 0.10, "ë ˆì „ë”ë¦¬": 0.13, "ìœ ì¼": 0.17};
const slotTypePool = {
  "ë¬´ê¸°": [
    {name:"ê²€",type:"ê·¼ì ‘"}, {name:"ë„ë¼",type:"ê·¼ì ‘"}, {name:"ì°½",type:"ê·¼ì ‘"}, {name:"ë ˆì´í”¼ì–´",type:"ê·¼ì ‘"},
    {name:"ëŒ€ê²€",type:"ê·¼ì ‘"}, {name:"ì–‘ì†ë„ë¼",type:"ê·¼ì ‘"},
    {name:"í™œ",type:"ì›ê±°ë¦¬"}, {name:"ì„ê¶",type:"ì›ê±°ë¦¬"}, {name:"ì´",type:"ì›ê±°ë¦¬"},
    {name:"ì›ë“œ",type:"ë§ˆë²•"}, {name:"ìŠ¤íƒœí”„",type:"ë§ˆë²•"}, {name:"ë“€ì–¼ê±´",type:"ë§ˆë²•"}
  ],
  "ë°©íŒ¨": [{name:"ë°©íŒ¨",type:"ë°©ì–´"}],
  "ë¨¸ë¦¬": [{name:"íˆ¬êµ¬"},{name:"ëª¨ì"},{name:"ë‘ê±´"}],
  "ìƒì˜": [{name:"ê°‘ì˜·"},{name:"ë¡œë¸Œ"},{name:"ìì¼“"}],
  "í•˜ì˜": [{name:"ë°”ì§€"},{name:"ë ˆê¹…ìŠ¤"}],
  "ì‹ ë°œ": [{name:"ë¶€ì¸ "},{name:"ì‹ ë°œ"},{name:"ì¥í™”"}],
  "ì†": [{name:"ì¥ê°‘"},{name:"ë°˜ì§€"}]
};
const skillPool = {
  "ê·¼ì ‘": ["íšŒì „ë² ê¸°", "ì§€ì§„ê°•íƒ€", "ê´‘ì—­ì°¸ê²©", "ì°¸ê²©", "ëŒì§„ë² ê¸°"],
  "ì›ê±°ë¦¬": ["ì—°ì†ì‚¬ê²©", "ê´€í†µí™”ì‚´", "ì €ê²©", "í­ë°œí™”ì‚´", "ì§‘ì¤‘ì‚¬ê²©"],
  "ë§ˆë²•": ["íŒŒì´ì–´ë³¼", "ì•„ì´ìŠ¤ìŠ¤í†°", "ì²´ì¸ë¼ì´íŠ¸ë‹", "ì•”í‘êµ¬", "ì—ë„ˆì§€ë¸”ë˜ìŠ¤íŠ¸"]
};
const monsterPrefixes = ["ë¶ˆíƒ€ëŠ”", "ì‚¬ë‚˜ìš´", "ê±°ëŒ€í•œ", "ë‚ ì¹´ë¡œìš´", "ì•”í‘ì˜", "ë¹™ê²°ì˜", "ê´‘ê¸°ì˜", "ë²ˆê°œì˜", "ë…ê¸°ì˜", "ì£½ìŒì˜"];
const monsterNames = [
  "ê·¸ë¦¼ì ë©§ë¼ì§€", "ë¹™ê²° ìŠ¬ë¼ì„", "ë¶ˆì‚¬ë¥¸ í•´ê³¨ê¸°ì‚¬", "ì§€ì˜¥ë°•ì¥", "ëŒì—°ë³€ì´ ëŠ‘ëŒ€",
  "ì•”í‘ì˜ ê³ ë¸”ë¦°", "ê´‘ê¸°ì˜ ì˜¤ìš°ê±°", "ì„œë¦¬ê³¨ë ˜", "ë¶ˆê½ƒ ì™€ì´ë²ˆ", "ì£½ìŒì˜ ë¦¬ì¹˜",
  "í˜¼ëˆì˜ ë¯¸ë…¸íƒ€ìš°ë¥´ìŠ¤", "ë§¹ë… ìŠ¤ì½œí”¼ì˜¨", "ë¬´ì‡  ê³°", "í‰í¬í•œ ëŠ‘ëŒ€", "ë…ì‚¬",
  "ì–´ë‘ ì˜ ì•”ì‚´ì", "ê´‘í¬í•œ ê³°", "ê³ ëŒ€ì˜ ê³¨ë ˜", "ë‚ ë µí•œ íŒ¬ì„œ", "ì €ì£¼ë°›ì€ í•´ê³¨ì „ì‚¬"
];
const uniqueMonsters = [
  "ê´‘íœ˜ë£¡ ë²¨ë¦¬ì˜¤ë¡œìŠ¤", "í‘ì„¬ë£¡ ì•„ë²¨ë¦¬ì˜¤ìŠ¤", "ìˆ˜ì•”ë£¡ íƒ€ë‚˜ë¡œí† ìŠ¤", "ì•”í† ë£¡ ìš°ë¡œë³´ë¡œìŠ¤"
];
const uniqueMonsterPrefixes = {
  "ê´‘íœ˜ë£¡ ë²¨ë¦¬ì˜¤ë¡œìŠ¤": "ê´‘íœ˜",
  "í‘ì„¬ë£¡ ì•„ë²¨ë¦¬ì˜¤ìŠ¤": "í‘ì„¬",
  "ìˆ˜ì•”ë£¡ íƒ€ë‚˜ë¡œí† ìŠ¤": "ìˆ˜ì•”",
  "ì•”í† ë£¡ ìš°ë¡œë³´ë¡œìŠ¤": "í† ì•”"
};
// ìœ ì¼ ì„¸íŠ¸ íš¨ê³¼
const uniqueSetBonus = {
  "ê´‘íœ˜": { name: "ê´‘íœ˜ ì„¸íŠ¸", desc: "1í„´ 2íšŒ ê³µê²©" },
  "í‘ì„¬": { name: "í‘ì„¬ ì„¸íŠ¸", desc: "ê³µê²© ì‹œ 30% í™•ë¥ ë¡œ 1í„´ ìŠ¤í„´" },
  "ìˆ˜ì•”": { name: "ìˆ˜ì•” ì„¸íŠ¸", desc: "í”¼ê²© ì‹œ 40% í™•ë¥ ë¡œ 50% ë°˜ì‚¬" },
  "í† ì•”": { name: "í† ì•” ì„¸íŠ¸", desc: "ì „íˆ¬ ì¤‘ 1íšŒ ì‚¬ë§ ì‹œ 50% ë¶€í™œ" }
};
let user = null; let saveSlot = 1;
function rint(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
// ëª¬ìŠ¤í„° ìƒì„±
function makeMonster(level, isDungeon = false) {
  if(isDungeon && Math.random() < 0.01) {
    let name = uniqueMonsters[rint(0, uniqueMonsters.length-1)];
    let hp = Math.floor(40 + level*4 + rint(10,40));
    let atk = Math.floor(8 + level*2 + rint(5,10));
    let def = Math.floor(level/6 + rint(2,8));
    return { name, hp, atk, def, unique: true };
  }
  let prefix = monsterPrefixes[rint(0, monsterPrefixes.length - 1)];
  let nameBase = monsterNames[rint(0, monsterNames.length - 1)];
  let name = prefix + " " + nameBase;
  let hp = Math.floor(12 + level*2.5 + rint(0,4));
  let atk = Math.floor(3 + level*0.8 + rint(0,2));
  let def = Math.floor(level/5 + rint(0,1));
  return { name, hp, atk, def, unique: false };
}
// ì„¸ì´ë¸Œ/ë¶ˆëŸ¬ì˜¤ê¸°/ìŠ¬ë¡¯ì‚­ì œ
window.onload = function() { renderSaveSlotSelect(); };
function renderSaveSlotSelect() {
  let html = `<div class="save-slot-select"><b>ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `ìŠ¬ë¡¯${i} (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `ìŠ¬ë¡¯${i} (ìƒˆ ì‹œì‘)`;
    html += `<div style="margin-bottom:8px;display:flex;align-items:center;">
      <button class="save-slot-btn" onclick="startGame(${i})">${btnText}</button>
      <button class="save-del-btn" onclick="deleteSaveSlot(${i})">ì‚­ì œ</button>
    </div>`;
  }
  html += `</div>`;
  document.getElementById("loadslotbox").innerHTML = html;
}
function deleteSaveSlot(slot) {
  if(confirm(`ì •ë§ë¡œ ìŠ¬ë¡¯${slot}ì˜ ì €ì¥ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)){
    localStorage.removeItem("elgasia_save_"+slot);
    renderSaveSlotSelect();
  }
}
function saveGame() {
  if (!user) return;
  localStorage.setItem("elgasia_save_"+saveSlot, JSON.stringify(user));
  log(`<span style='color:#aaf'>ìŠ¬ë¡¯ ${saveSlot}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>`);
}
function loadGame(slot) {
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data); saveSlot = slot;
    if(!user.storage) user.storage=[];
    showUI(); updateUser();
    log(`<span style='color:#aff'>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìŠ¬ë¡¯ ${slot}</span>`);
  }
}
function showLoad() {
  let html = `<b>ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ ì„ íƒ</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `ìŠ¬ë¡¯${i} ë¶ˆëŸ¬ì˜¤ê¸° (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `ìŠ¬ë¡¯${i} (ë¹„ì–´ìˆìŒ)`;
    html += `<button class="save-slot-btn" onclick="loadGame(${i});hideLoad();">${btnText}</button>
    <button class="save-del-btn" onclick="deleteSaveSlot(${i})">ì‚­ì œ</button><br>`;
  }
  html += `<br><button class="inv-btn" onclick="hideLoad()">ë‹«ê¸°</button>`;
  document.getElementById("logbox").innerHTML = html;
}
function hideLoad(){ log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°'); }
function startGame(slot) {
  saveSlot = slot;
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data); if(!user.storage) user.storage=[];
    showUI(); updateUser();
    log(`<span style='color:#aff'>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìŠ¬ë¡¯ ${slot}</span>`);
  } else {
    user = {
      name: "ìš©ì‚¬", level: 1, exp: 0, rebirth: 0, gold: 100,
      stats: [1,1,1,1,1], statmax: 9999, hp: 30, maxhp: 30,
      equip: {}, inv: [], town: {restcount:0,skillstone:1}, stones: 0, storage: []
    };
    showUI(); updateUser();
    log(`<b>í™˜ì˜í•©ë‹ˆë‹¤! ìºë¦­í„° ì´ë¦„ì„ ë¨¼ì € ì •í•´ì£¼ì„¸ìš”.</b> <br><div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="ìºë¦­í„° ì´ë¦„"/><button class="inv-btn" onclick="setCharName()">í™•ì¸</button></div>`);
  }
}
function showUI() {
  document.getElementById("loadslotbox").style.display = "none";
  document.getElementById("userinfo").style.display = "";
  document.getElementById("menubar").style.display = "";
  document.getElementById("savebar").style.display = "";
  document.getElementById("slotsel").innerText = saveSlot;
}
function setCharName() {
  let n = document.getElementById("newname").value.trim();
  if (!n) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  user.name = n;
  updateUser();
  log(`ì´ë¦„ì´ <b>${n}</b>ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  saveGame();
}
function promptNameChange() {
  let n = prompt("ìƒˆ ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", user.name || "");
  if(!n) return;
  user.name = n;
  updateUser(); saveGame();
}
function expNeed(lv){ return Math.floor(Math.pow(lv,1.5)*12)+lv*8; }
function log(msg){ document.getElementById("logbox").innerHTML = msg; }
function updateUser() {
  if(!user.storage) user.storage=[];
  document.getElementById("userinfo").innerHTML = `<div class="stat-box">
    <span>ì´ë¦„ <b>${user.name}</b> <button class="inv-btn" onclick="promptNameChange()">ë³€ê²½</button></span>
    <span>ë ˆë²¨ <b>${user.level}</b></span>
    <span>ê²½í—˜ì¹˜ <b>${user.exp}/${expNeed(user.level)}</b></span>
    <span>ê³¨ë“œ <b>${user.gold}</b></span>
    <span>HP <b>${user.hp}/${user.maxhp}</b></span>
    <span>ê°•í™”ì„ <b>${user.stones||0}</b></span>
    <span>ì°½ê³  <b>${user.storage.length}/100</b></span>
  </div>`;
}
function rarityBonus(r){
  if(r=="ì¼ë°˜")return 0; if(r=="ë ˆì–´")return 1; if(r=="ìœ ë‹ˆí¬")return 2;
  if(r=="ì—í”½")return 3; if(r=="ë ˆì „ë”ë¦¬")return 4; if(r=="ìœ ì¼")return 5;
  return 0;
}
// ---- ì•„ì´í…œ ìƒì„± (ìŠ¤í‚¬ í™•ë¥  ë° ìœ ì¼ ì„¸íŠ¸/ìŠ¤í‚¬)
function makeItem(allowMyth, isShop, uniqueMonsterName = null) {
  let rate = allowMyth ? dungeonRate : rarityRate;
  let localRarityOrder = isShop ? ["ì¼ë°˜","ë ˆì–´","ìœ ë‹ˆí¬"] : rarityOrder;
  let localRate = isShop ? [70,25,5] : rate;
  let rarity = "ì¼ë°˜";
  let r = Math.random() * 100, acc = 0;
  for (let i=0;i<localRate.length;i++) { acc += localRate[i]; if (r < acc) { rarity = localRarityOrder[i]; break; } }
  if(!uniqueMonsterName && rarity === "ìœ ì¼") rarity = "ë ˆì „ë”ë¦¬";
  if(uniqueMonsterName) rarity = "ìœ ì¼";

  let slot = equipSlots[rint(0, equipSlots.length-1)];
  let pool = slotTypePool[slot];
  let baseObj = pool[rint(0, pool.length-1)];
  let itemType = baseObj.name;
  let itemAttackType = baseObj.type || null;

  // ìœ ì¼ ì•„ì´í…œ(ì´ë¦„/ìŠ¤íƒ¯/ìŠ¤í‚¬ ê·œì¹™ ì ìš©)
  if(rarity === "ìœ ì¼" && uniqueMonsterName) {
    let uniqPrefix = uniqueMonsterPrefixes[uniqueMonsterName] || "ìœ ì¼";
    let baseName = baseObj.name;
    let name = `${uniqPrefix}ì˜ ${baseName}`;
    let skill = "";
    if(itemAttackType && skillPool[itemAttackType])
      skill = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
    let stat = [];
    let sconf = itemStatTable["ìœ ì¼"];
    for(let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
    let atk = itemAttackType === "ê·¼ì ‘" ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let ratk= itemAttackType === "ì›ê±°ë¦¬"? rint(sconf.atk[0], sconf.atk[1]) : 0;
    let matk= itemAttackType === "ë§ˆë²•"  ? rint(sconf.atk[0], sconf.atk[1]) : 0;
    stat.push(atk); stat.push(ratk); stat.push(matk);
    return {
      name, rarity: "ìœ ì¼", slot, stat, type: baseName, attackType: itemAttackType,
      skill, enh: 0, ilv: null, unique: true, uniqPrefix
    };
  }

  // ì¼ë°˜~ë ˆì „ë”ë¦¬ ì•„ì´í…œ
  let prefix = prefixes[rint(0,prefixes.length-1)];
  let suffix = suffixes[rint(0,suffixes.length-1)];
  let name = `${prefix} ${suffix}ì˜ ${itemType}`;
  let skill = null, skillBase = null, skillBonus=1, trigger = skillTriggerRate[rarity] || 0.05;
  if (itemAttackType && skillPool[itemAttackType]) {
    let chance = skillGiveRate[rarity] || 0.1;
    if(Math.random() < chance) {
      skillBase = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
      skill = prefix ? `${prefix} ${skillBase}` : skillBase;
      if(prefix && prefix.includes("ë¶ˆíƒ€ëŠ”")) skillBonus = 1.2;
    }
  }
  let stat = [];
  let sconf = itemStatTable[rarity];
  for (let i=0;i<5;i++) stat.push(rint(sconf.base[0],sconf.base[1]));
  let atk=0, ratk=0, matk=0;
  if(itemAttackType=="ê·¼ì ‘") atk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="ì›ê±°ë¦¬") ratk = rint(sconf.atk[0],sconf.atk[1]);
  if(itemAttackType=="ë§ˆë²•") matk = rint(sconf.atk[0],sconf.atk[1]);
  stat.push(Math.floor(atk * skillBonus));
  stat.push(Math.floor(ratk * skillBonus));
  stat.push(Math.floor(matk * skillBonus));

  // ğŸŸ¢ ë°©ì–´êµ¬ ìŠ¤í‚¬ ë¶€ì—¬ (ë°©ì–´êµ¬ë§Œ, ë¬´ê¸°/ë°©íŒ¨/ìœ ì¼ ì œì™¸)
  let armorSkill = null;
  if (["ë¨¸ë¦¬","ìƒì˜","í•˜ì˜","ì†","ì‹ ë°œ"].includes(slot) && rarity !== "ìœ ì¼" && Math.random()<0.40) {
    let skillObj = armorSkillPool[rint(0, armorSkillPool.length-1)];
    let scale = armorSkillEffectScale[rarity] || 1;
    let val = rint(skillObj.base[0]*scale, skillObj.base[1]*scale);
    armorSkill = { name: skillObj.name, type: skillObj.type, value: val };
  }

  return {
    name: name, rarity: rarity, slot: slot, stat: stat, type: itemType,
    attackType: itemAttackType, skill: skill, skillBase: skillBase, skillBonus: skillBonus,
    skillTrigger: trigger, enh: 0, ilv: null, unique: false, armorSkill
  };
}


function makeUniqueItem(monsterName, slot){
  const prefix = uniqueMonsterPrefixes[monsterName] || "ì „ì„¤";
  let baseName = slotTypePool[slot][0].name;
  let name = `${prefix}ì˜ ${baseName}`;
  let skill = null;
  switch(prefix){
    case "ê´‘íœ˜": skill = "ë¹›ì˜ í­ë°œ"; break;
    case "í‘ì„¬": skill = "ì•”í‘ ì—°ì‡„"; break;
    case "ìˆ˜ì•”": skill = "ë¬¼ì˜ íŒŒë™"; break;
    case "í† ì•”": skill = "ëŒ€ì§€ ë¶„ì‡„"; break;
    default: skill = "ì „ì„¤ì˜ í˜";
  }
  let stat = [10,5,5,7,3];
  let atk=15, ratk=0, matk=0;
  if(slot === "ë¬´ê¸°") atk = 25;
  return {
    name, rarity: "ìœ ì¼", slot, stat, type: baseName,
    attackType: slot === "ë¬´ê¸°" ? "ê·¼ì ‘" : null, skill, enh: 0, ilv: null, unique: true, uniqPrefix: prefix
  };
}
function itemDisplay(item){
  return `<span class="${rarityColors[item.rarity]}">[${item.rarity}]</span> ${item.name} <span class="equip-bonus">STR:${item.stat[0]} DEX:${item.stat[1]} INT:${item.stat[2]} VIT:${item.stat[3]} LUK:${item.stat[4]} ${item.attackType==="ê·¼ì ‘"?`ATK:${item.stat[5]}`:""}${item.attackType==="ì›ê±°ë¦¬"?`RATK:${item.stat[6]}`:""}${item.attackType==="ë§ˆë²•"?`MATK:${item.stat[7]}`:""}</span> ${item.skill?`<span class="equip-bonus">ìŠ¤í‚¬:${item.skill}</span>`:""}${item.armorSkill?` <span class="equip-bonus">ë°©ì–´êµ¬ìŠ¤í‚¬:${item.armorSkill.name}(+${item.armorSkill.value})</span>`:""}${item.enh?` <span class="enh-lv">+${item.enh}</span>`:""}`;
}

// ì¸ë²¤í† ë¦¬, ì°©ìš©/íŒë§¤/ì¼ê´„íŒë§¤
function showInv() {
  let invhtml = "";
  user.inv.forEach((item,i)=>{
    invhtml += `<div class="equipitem">${itemDisplay(item)}
      <button class="inv-btn" onclick="equipItem(${i})">ì°©ìš©</button>
      <button class="inv-btn" onclick="sellInv(${i})">íŒë§¤</button></div>`;
  });
  if(!invhtml) invhtml="<div style='color:#888'>ì†Œì§€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>";
  log(`<b>[ì†Œì§€í’ˆ]</b> (${user.inv.length}/${inventoryLimit})<br>${invhtml}<br>
    <button class="inv-btn" onclick="sellAllInv()">ì „ì²´ íŒë§¤ (ì°©ìš© ì œì™¸)</button><br>
    <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`);
}
function sellAllInv(){
  if(user.inv.length === 0){
    log("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤."); return;
  }
  let totalGold = 0;
  let soldNames = [];
  let filteredInv = user.inv.filter(item=>{
    for(let slot of equipSlots){
      if(user.equip[slot] && user.equip[slot].name === item.name) return false;
    }
    return true;
  });
  if(filteredInv.length === 0){
    log("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. (ì°©ìš© ì¤‘ ì•„ì´í…œ ì œì™¸)"); return;
  }
  filteredInv.forEach(item=>{
    let idx = user.inv.indexOf(item);
    if(idx >= 0) user.inv.splice(idx,1);
    let sellValue = 5 + (rarityBonus(item.rarity) * 10);
    totalGold += sellValue;
    soldNames.push(item.name);
  });
  user.gold += totalGold;
  log(`ì°©ìš© ì¤‘ì´ ì•„ë‹Œ ëª¨ë“  ì•„ì´í…œ íŒë§¤ ì™„ë£Œ! ì´ ${totalGold}ê³¨ë“œë¥¼ ì–»ì—ˆë‹¤.<br>íŒë§¤í•œ ì•„ì´í…œ: ${soldNames.join(", ")}<br><button class="inv-btn" onclick="showInv()">ì†Œì§€í’ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function equipItem(idx){
  let item = user.inv[idx];
  if(!item || !item.slot || equipSlots.indexOf(item.slot) === -1) return;
  if(user.equip[item.slot]) addInv(user.equip[item.slot]);
  user.equip[item.slot]=item;
  user.inv.splice(idx,1);
  showInv(); updateUser();
}
function sellInv(idx){
  let item = user.inv[idx];
  let sellValue = 5 + (rarityBonus(item.rarity) * 10);
  user.gold += sellValue;
  user.inv.splice(idx,1);
  log(`${itemDisplay(item)}<br><span style="color:#ffe55e">${sellValue}Gì— íŒë§¤ë˜ì—ˆìŠµë‹ˆë‹¤!</span><br><button class="inv-btn" onclick="showInv()">ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function addInv(item){
  if(user.inv.length>=inventoryLimit){log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!"); return false;}
  user.inv.push(item); return true;
}
// ì°½ê³ 
function showStorage() {
  if(!user.storage) user.storage = [];
  let html = `<b>[ì°½ê³ ]</b> (${user.storage.length}/100)<br>`;
  user.storage.forEach((item,i)=>{
    html += `<div class="equipitem">${itemDisplay(item)}
      <button class="inv-btn" onclick="moveToInventory(${i})">ì¸ë²¤í† ë¦¬ë¡œ ì´ë™</button>
      </div>`;
  });
  if(!user.storage.length) html += `<div style='color:#888'>ì°½ê³ ì— ì €ì¥ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  html += `<hr><b>[ì†Œì§€í’ˆì—ì„œ ì°½ê³ ë¡œ ì´ë™]</b><br>`;
  user.inv.forEach((item,i)=>{
    html += `<div class="equipitem">${itemDisplay(item)}
      <button class="inv-btn" onclick="moveToStorage(${i})">ì°½ê³ ë¡œ ì´ë™</button>
      </div>`;
  });
  if(!user.inv.length) html += `<div style='color:#888'>ì†Œì§€í’ˆì— ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  log(html);
}
function moveToStorage(idx) {
  if(user.storage.length >= 100) {
    log("ì°½ê³ ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!"); return;
  }
  let item = user.inv[idx];
  user.storage.push(item);
  user.inv.splice(idx,1);
  showStorage();
  updateUser();
}
function moveToInventory(idx) {
  if(user.inv.length >= inventoryLimit) {
    log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!"); return;
  }
  let item = user.storage[idx];
  user.inv.push(item);
  user.storage.splice(idx,1);
  showStorage();
  updateUser();
}
// ìºë¦­í„°ì°½(ê¸°ë³¸/ì¥ë¹„í•©ì‚° ìŠ¤íƒ¯)
function showChar() {
  let baseStats = user.stats.slice();
  let equipStats = user.stats.slice();
  let addATK = 0, addRATK = 0, addMATK = 0, addDEF = 0;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if(eq && eq.stat){
      for(let i=0; i<5; i++){
        equipStats[i] += eq.stat[i]||0;
      }
      addATK += eq.stat[5]||0;
      addRATK += eq.stat[6]||0;
      addMATK += eq.stat[7]||0;
      addDEF += eq.stat[3]||0;
    }
  }
  let totalATK = addATK + equipStats[0];
  let totalRATK = addRATK + equipStats[1];
  let totalMATK = addMATK + equipStats[2];
  let totalDEF = equipStats[3];
  let statLabel = ["STR(ê·¼ë ¥)","DEX(ë¯¼ì²©)","INT(ì§€ëŠ¥)","VIT(ì²´ë ¥)","LUK(ìš´)"];
  let baseStr = baseStats.map((v,i)=>`${statLabel[i]}: ${v}`).join(" / ");
  let equipStr = equipStats.map((v,i)=>`${statLabel[i]}: ${v}`).join(" / ");
  let eqhtml = "";
  for(let slot of equipSlots){
    let eq = user.equip[slot];
    if(eq){
      eqhtml += `<div><b>${slot}:</b> ${itemDisplay(eq)}
      <button class="inv-btn" onclick="unequip('${slot}')">í•´ì œ</button></div>
      ${eq.skill?`<div class="equip-bonus">ìŠ¤í‚¬: ${eq.skill}</div>`:""}`;
    } else {
      eqhtml += `<div><b>${slot}:</b> <span style="color:#888">ë¹„ì–´ìˆìŒ</span></div>`;
    }
  }
  let setBonusKey = checkUniqueSetBonus();
  let setBonusMsg = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} ì„¸íŠ¸ íš¨ê³¼: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
  log(`<b>[ìºë¦­í„°]</b><br>
    <b>ë ˆë²¨:</b> ${user.level} / <b>í™˜ìƒ:</b> ${user.rebirth}<br>
    <b>ê¸°ë³¸ ìŠ¤íƒ¯:</b> ${baseStr}<br>
    <b>ì¥ë¹„ ì ìš©:</b> ${equipStr}<br>
    <b>[ê³µê²©/ë°©ì–´]</b><br>
    ATK(ê·¼ì ‘): <b>${totalATK}</b> / RATK(ì›ê±°ë¦¬): <b>${totalRATK}</b> / MATK(ë§ˆë²•): <b>${totalMATK}</b> / DEF: <b>${totalDEF}</b><br>
    <b>HP:</b> ${user.hp}/${user.maxhp}<br>
    <b>ì¥ì°©ì¥ë¹„</b><br>${eqhtml}${setBonusMsg}
    <br><button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>
  `);
}
function unequip(slot) {
  if (!user.equip[slot]) return;
  addInv(user.equip[slot]);
  user.equip[slot] = undefined;
  showChar();
}
// ë§ˆì„/ìƒì /ê°•í™”
function showTown(){
  log(`<b>[ë§ˆì„]</b><br>
    <button class="inv-btn" onclick="innRest()">ì—¬ê´€(íœ´ì‹)</button>
    <button class="inv-btn" onclick="showShop()">ì¥ë¹„ìƒì </button>
    <button class="inv-btn" onclick="showEnhance()">ê°•í™”ì†Œ</button>
    <button class="inv-btn" onclick="showStorage()">ì°½ê³ </button>
    <button class="inv-btn" onclick="rebirth()">í™˜ìƒ</button>
    <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`);
}
function innRest(){
  let cost=20+user.level*5;
  if(user.gold<cost){log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");return;}
  user.gold-=cost; user.hp=user.maxhp;
  log(`ì—¬ê´€ì—ì„œ íœ´ì‹ í›„ HP ì „ë¶€ íšŒë³µ! (${cost}ê³¨ë“œ ì†Œëª¨)<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function showShop() {
  let items = [];
  for(let i=0;i<5;i++) items.push(makeItem(false, true)); // isShop = true
  let html = `<div class="shop-title">[ì¥ë¹„ ìƒì ] (ìƒˆë¡œê³ ì¹¨ì‹œ ìƒí’ˆ ë³€ê²½, ì—í”½ ë“±ê¸‰ ì´ìƒì€ ë¯¸ì¶œí˜„)</div>`;
  items.forEach((item, idx)=>{
    html += `<div class="shop-item">${itemDisplay(item)}
      <button class="inv-btn" onclick="buyShopItem(${idx})">êµ¬ë§¤ (${50+user.level*8}G)</button></div>`;
  });
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  log(html); window.shopItems = items;
}
function buyShopItem(idx) {
  let item = window.shopItems[idx];
  let cost = 50 + user.level*8;
  if(user.gold<cost){log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");return;}
  if(user.inv.length>=inventoryLimit){log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!");return;}
  user.gold -= cost;
  user.inv.push(item);
  log(`êµ¬ë§¤ ì™„ë£Œ!<br>${itemDisplay(item)}<br><button class="inv-btn" onclick="showShop()">ìƒì ìœ¼ë¡œ</button>`);
  updateUser();
}
function showEnhance(){
  let html = `<div class="shop-title">[ì¥ë¹„ ê°•í™”]</div>`;
  let equips = Object.values(user.equip).filter(e=>e);
  if(!equips.length){
    html += `<div style="color:#888">ê°•í™”í•  ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    equips.forEach((eq,idx)=>{
      html += `<div class="shop-item">${itemDisplay(eq)}<button class="enhance-btn" onclick="enhanceItem('${eq.slot}')">ê°•í™”</button></div>`;
    });
  }
  html += `<br><button class="inv-btn" onclick="showTown()">ëŒì•„ê°€ê¸°</button>`;
  log(html);
}
function enhanceItem(slot){
  let eq = user.equip[slot];
  if(!eq) return;
  let lv = eq.enh || 0;
  if(lv>=20){ log("ìµœëŒ€ ê°•í™” ë‹¨ê³„ì…ë‹ˆë‹¤."); return; }
  let needStone = lv < 5 ? [1,2,4,8,20][lv] : lv < 10 ? 20*Math.pow(2, lv-4) : lv < 15 ? 60*Math.pow(3, lv-9) : 120*Math.pow(4, lv-14);
  let needGold = 100 + lv * 50;
  if(user.stones < needStone){ log("ê°•í™”ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
  if(user.gold < needGold){ log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
  let prob = lv < 4 ? 1 : lv < 10 ? 0.5-(lv-4)*0.08 : lv < 15 ? 0.12-(lv-10)*0.025 : 0.04-(lv-15)*0.007;
  if(prob < 0.01) prob = 0.01;
  let succ = Math.random() < prob;
  user.stones -= needStone;
  user.gold -= needGold;
  if(succ){
    eq.enh = lv + 1;
    if(eq.slot === "ë¬´ê¸°") {
      let atkIndex = 5;
      if(eq.attackType === "ì›ê±°ë¦¬") atkIndex = 6;
      else if(eq.attackType === "ë§ˆë²•") atkIndex = 7;
      eq.stat[atkIndex] = (eq.stat[atkIndex] || 0) + rint(1,3);
      log(`<span class="succ-msg">[+${eq.enh} ê°•í™” ì„±ê³µ! ì£¼ìš” ê³µê²©ë ¥ì´ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!]</span> ê³¨ë“œ ${needGold}ì†Œëª¨, ê°•í™”ì„ ${needStone}ì†Œëª¨`);
    } else {
      // â­ï¸ 5ê°œ ìŠ¤íƒ¯ ì¤‘ í•˜ë‚˜ê°€ ëœë¤í•˜ê²Œ ì˜¤ë¦„
      let statIdx = rint(0,4); // 0~4
      eq.stat[statIdx] = (eq.stat[statIdx]||0) + rint(1,3);
      log(`<span class="succ-msg">[+${eq.enh} ê°•í™” ì„±ê³µ! ìŠ¤íƒ¯ì´ ëœë¤ìœ¼ë¡œ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!]</span> ê³¨ë“œ ${needGold}ì†Œëª¨, ê°•í™”ì„ ${needStone}ì†Œëª¨`);
    }
  } else {
    log(`<span class="fail-msg">[ê°•í™” ì‹¤íŒ¨] ê³¨ë“œ ${needGold}ì†Œëª¨, ê°•í™”ì„ ${needStone}ì†Œëª¨</span>`);
  }
  updateUser();
  showEnhance();
}
// ì„¸íŠ¸ë³´ë„ˆìŠ¤ ì²´í¬(ìœ ì¼ ì „ìš©)
function checkUniqueSetBonus() {
  const armorSlots = ["ë¨¸ë¦¬", "ìƒì˜", "í•˜ì˜", "ì†", "ì‹ ë°œ"];
  let found = { ê´‘íœ˜:0, í‘ì„¬:0, ìˆ˜ì•”:0, í† ì•”:0 };
  for(let slot of armorSlots){
    let eq = user.equip[slot];
    if(eq && eq.rarity === "ìœ ì¼") {
      let pre = eq.uniqPrefix || (eq.name.split("ì˜")[0]);
      if(found[pre] !== undefined) found[pre]++;
    }
  }
  for(let key in found) if(found[key] >= 4) return key; // 4ì…‹ ë³´ìœ ì‹œ ë°˜í™˜
  return null;
}
function triggerArmorSkills(timing, opts) {
  // opts: {attackDmg, skillAttack, battleLog, userhp, monhp, shieldObj, gotHit, turn, monsterDmg}
  let anyTriggered = false;
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if (eq && eq.armorSkill) {
      let rarity = eq.rarity || "ì¼ë°˜";
      let trigRate = armorSkillTriggerRate[rarity] || 0.02;
      if (Math.random() < trigRate) {
        let v = eq.armorSkill.value;
        let type = eq.armorSkill.type;
        let eff = armorSkillLogEffects[type];
        switch (type) {
          case "regen":
            if (timing === "turn") {
              let heal = Math.max(1, Math.floor(user.maxhp * (v / 100)));
              opts.userhp.val = Math.min(user.maxhp, opts.userhp.val + heal);
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(heal)}</span>`);
              anyTriggered = true;
            }
            break;
          case "leech":
            if (timing === "attack" && opts.attackDmg > 0) {
              let leech = Math.max(1, Math.floor(opts.attackDmg * (v / 100)));
              opts.userhp.val = Math.min(user.maxhp, opts.userhp.val + leech);
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(leech)}</span>`);
              anyTriggered = true;
            }
            break;
          case "skillheal":
            if (timing === "attack" && opts.skillAttack && opts.attackDmg > 0) {
              let sheal = Math.max(1, Math.floor(opts.attackDmg * (v / 100)));
              opts.userhp.val = Math.min(user.maxhp, opts.userhp.val + sheal);
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(sheal)}</span>`);
              anyTriggered = true;
            }
            break;
          case "dmgreduce":
            if (timing === "defend") {
              opts.shieldObj.reducePct += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "reflect":
            if (timing === "defend") {
              opts.shieldObj.reflectPct += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "evadeup":
            if (timing === "defend") {
              opts.shieldObj.evadeAdd += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "shield":
            if (timing === "defend" || timing === "turn") {
              opts.shieldObj.shield += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
          case "ignorehit":
            if (timing === "gotHit" && opts.gotHit) {
              if (!eq._usedIgnore) {
                eq._usedIgnore = true;
                opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg()}</span>`);
                opts.monsterDmg.val = 0;
                anyTriggered = true;
              }
            }
            break;
          case "deathproof":
            if (timing === "death" && opts.userhp.val <= 0) {
              if (!eq._usedDeathProof) {
                eq._usedDeathProof = true;
                opts.userhp.val = Math.floor(user.maxhp * 0.3);
                opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg()}</span>`);
                anyTriggered = true;
              }
            }
            break;
          case "skillred":
            if (timing === "defend" && opts.isSkillHit) {
              opts.shieldObj.skillRed += v;
              opts.battleLog.push(`<span style="color:${eff.color}">${eff.icon} [${slot}] ${eff.msg(v)}</span>`);
              anyTriggered = true;
            }
            break;
        }
      }
    }
  }
  return anyTriggered;
}

// --- ì „íˆ¬ ë©”ì¸ í•¨ìˆ˜ ---
function battle(type) {
  let isDungeon = (type === "dungeon");
  let monster = makeMonster(user.level, isDungeon);
  let userhp = { val: user.hp };
  let monhp = monster.hp + (isDungeon ? rint(5,18) : 0);
  let battleLog = [];
  let weapon = user.equip["ë¬´ê¸°"];
  let myATK = weapon ? (
    (weapon.attackType=="ê·¼ì ‘") ? (weapon.stat[5]||4) :
    (weapon.attackType=="ì›ê±°ë¦¬") ? (weapon.stat[6]||3) :
    (weapon.attackType=="ë§ˆë²•") ? (weapon.stat[7]||3) : 2
  ) : 2;
  myATK += user.stats[0] || 0;
  let myDEF = user.stats[3] || 0;
  let setBonusKey = checkUniqueSetBonus();
  let hasGwanghui = setBonusKey === "ê´‘íœ˜";
  let rebirthUsed = false;
  let maxTurn = 10;
  let shieldObj = { reducePct:0, reflectPct:0, evadeAdd:0, shield:0, skillRed:0 };
  let skillTurn = [], finalSkillMsg = "";

  let turn; // turnì„ ë°”ê¹¥ì— ì„ ì–¸!
  for(turn=1; turn<=maxTurn && userhp.val>0 && monhp>0; turn++) {
    // [1] í„´ ì‹œì‘: íšŒë³µ/ì‹¤ë“œ/ì§€ì†í˜• íš¨ê³¼
    triggerArmorSkills('turn', {battleLog, userhp, monhp, shieldObj});
    // INT(ì§€ë ¥): í„´ ì‹œì‘ íšŒë³µ (healup ì˜í–¥)
    let intChance = Math.min(user.stats[2]/9999 * 0.7, 0.7);
    if(Math.random() < intChance) {
      let heal = Math.floor(user.maxhp * 0.2);
      userhp.val = Math.min(user.maxhp, userhp.val + heal);
      battleLog.push(`<b>[${turn}í„´]</b> <span class="skill-log">âœ¨ [ë§ˆë ¥ íš¨ê³¼] HP ${heal} íšŒë³µ!</span> (ë‚´ HP:${userhp.val})`);
    }

    // [2] ìŠ¤í„´(í‘ì„¬) íš¨ê³¼
    if(user.stunned && user.stunned > 0) {
      battleLog.push(`<b>[${turn}í„´]</b> <span class="set-bonus">â³ [í‘ì„¬ ì„¸íŠ¸] ì ì´ ìŠ¤í„´ ìƒíƒœë¡œ í–‰ë™ë¶ˆê°€!</span>`);
      user.stunned--;
    }

    // [3] í„´ë‹¹ ê³µê²© íšŸìˆ˜ ê²°ì •
    let attacksThisTurn = 1;
    if(hasGwanghui) attacksThisTurn += 1;
    let dexChance = Math.min(user.stats[1]/9999 * 0.7, 0.7);
    let dexExtra = (Math.random() < dexChance) ? 1 : 0;
    if(dexExtra) attacksThisTurn += 1;

    // [4] ê³µê²© ë£¨í”„
    for(let atkNum=0; atkNum<attacksThisTurn; atkNum++) {
      let effects = [];
      let dmg = rint(myATK-2, myATK+3);
      let isStrong = (Math.random() < Math.min(user.stats[0]/9999 * 0.7, 0.7));
      if(isStrong) {
        dmg = dmg * 2;
        effects.push(`<span class="skill-log">ğŸ’¥ [í˜: ê°•ê³µê²©]</span>`);
      }

      // ë¬´ê¸°ìŠ¤í‚¬ í™•ë¥  ë°œë™
      let isSkill = weapon && weapon.skill && Math.random() < (weapon.skillTrigger||0);
      if(isSkill) {
        dmg = Math.floor(dmg*1.8) + rint(1,5);
        skillTurn.push(turn);
        finalSkillMsg = `[ìŠ¤í‚¬ ë°œë™] ${weapon.skill}ë¡œ ê°•ë ¥í•œ ì¼ê²©!`;
        effects.push(`<span class="skill-log">ğŸ”¥ [ë¬´ê¸°ìŠ¤í‚¬: ${weapon.skill}]</span>`);
      }

      // ë°©ì–´êµ¬ ìŠ¤í‚¬: leech/skillheal (í™•ë¥ ë°œë™)
      triggerArmorSkills('attack', {
        attackDmg: dmg, skillAttack: isSkill, battleLog, userhp, monhp, shieldObj
      });

      // í‘ì„¬ ì„¸íŠ¸(30% í™•ë¥  ìŠ¤í„´)
      if(setBonusKey==="í‘ì„¬" && Math.random()<0.3){
        user.stunned = 1;
        effects.push(`<span class="set-bonus">â³ [í‘ì„¬ ì„¸íŠ¸: ìŠ¤í„´!]</span>`);
      }

      let monsterNameDisplay = monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name;
      monhp -= dmg;
      if(monhp < 0) monhp = 0;
      battleLog.push(`<b>[${turn}í„´ ê³µê²©${atkNum+1}]</b> ${effects.join(" ")}<span style="font-weight:bold;">${user.name}ì˜ ê³µê²©!</span> <span class="dmg-log">${monsterNameDisplay}ì—ê²Œ ${dmg}ì˜ í”¼í•´</span> (ëª¬ìŠ¤í„° HP:${Math.max(monhp,0)})`);
      if(monhp <= 0) break;
    }
    if(monhp <= 0) break;
    if(user.stunned && user.stunned > 0) { user.stunned--; continue; }

    // [5] ëª¬ìŠ¤í„° ê³µê²© ë° ë°©ì–´êµ¬ ìŠ¤í‚¬ ë°©ì–´ê³„ì—´ ì ìš©
    let monsterDmg = { val: Math.max(1, monster.atk - rint(Math.floor(myDEF/2), myDEF+1)) };
    triggerArmorSkills('defend', {
      battleLog, userhp, monhp, shieldObj, isSkillHit: false // í•„ìš”ì‹œ êµ¬í˜„
    });

    // ì‹¤ë“œ ì ìš©
    if (shieldObj.shield > 0) {
      let absorb = Math.min(shieldObj.shield, monsterDmg.val);
      shieldObj.shield -= absorb;
      monsterDmg.val -= absorb;
      battleLog.push(`<span style="color:#e3ffd8;font-weight:bold;">ğŸ›¡ï¸ [ì‹¤ë“œ] í”¼í•´ ${absorb} í¡ìˆ˜ (ì”ì—¬ ${shieldObj.shield})</span>`);
    }
    // ë°˜ì‚¬
    if (shieldObj.reflectPct > 0) {
      let reflect = Math.floor(monsterDmg.val * (shieldObj.reflectPct / 100));
      monhp -= reflect;
      battleLog.push(`<span style="color:#8ef6f2">ğŸª [ë°˜ì‚¬] ${reflect} ë°˜ì‚¬</span>`);
    }
    // í”¼í•´ê°ì†Œ
    if (shieldObj.reducePct > 0) {
      monsterDmg.val = Math.max(1, Math.floor(monsterDmg.val * (1-shieldObj.reducePct/100)));
    }
    // ìŠ¤í‚¬í”¼í•´ê°ì†Œ
    if (shieldObj.skillRed > 0) {
      monsterDmg.val = Math.max(1, Math.floor(monsterDmg.val * (1-shieldObj.skillRed/100)));
    }
    // íšŒí”¼ í™•ë¥  (LUK + ë°©ì–´êµ¬ íš¨ê³¼)
    let evadeChance = Math.min(user.stats[4]/9999 * 0.7, 0.7) + (shieldObj.evadeAdd/100);
    if(Math.random() < evadeChance) {
      battleLog.push(`<span class="dmg-log">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}ì˜ ê³µê²©! â†’ <b>ğŸŒ€ [íšŒí”¼!]</b> (ë‚´ HP:${Math.max(userhp.val,0)})</span>`);
      continue;
    }
    // ignorehit
    let gotHit = true;
    triggerArmorSkills('gotHit', {battleLog, userhp, monhp, shieldObj, gotHit, monsterDmg});
    if(monsterDmg.val <= 0) continue; // í”¼ê²© ë¬´ì‹œ ì„±ê³µ

    // ë°ë¯¸ì§€ ì‹¤ì œ ì ìš©
    userhp.val -= monsterDmg.val;
    battleLog.push(`${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}ì˜ ê³µê²©! <span class="dmg-log">${user.name}ì—ê²Œ ${monsterDmg.val} í”¼í•´</span> (ë‚´ HP:${Math.max(userhp.val,0)})`);

    // deathproof
    triggerArmorSkills('death', {battleLog, userhp, monhp, shieldObj});

    // í† ì•” ì„¸íŠ¸ ë¶€í™œ
    if(userhp.val<=0 && setBonusKey==="í† ì•”" && !rebirthUsed){
      rebirthUsed = true; userhp.val = Math.floor(user.maxhp*0.5);
      battleLog.push(`<span class="set-bonus">ğŸª¨ [í† ì•” ì„¸íŠ¸: 1íšŒ ë¶€í™œ! HP ${userhp.val}ë¡œ ë¶€í™œ]</span>`);
    }

    if(userhp.val <= 0) { userhp.val = 0; break; }
    // íš¨ê³¼ ë³€ìˆ˜ ë¦¬ì…‹ (ì‹¤ë“œëŠ” ëˆ„ì )
    shieldObj = { reducePct:0, reflectPct:0, evadeAdd:0, shield:shieldObj.shield, skillRed:0 };
  }
  turn--; // ë§ˆì§€ë§‰ í„´ê°’ ë³´ì •

  // í”Œë˜ê·¸ ì´ˆê¸°í™”(ì¤‘ìš”!)
  for (let slot of equipSlots) {
    let eq = user.equip[slot];
    if(eq) {
      delete eq._usedIgnore;
      delete eq._usedDeathProof;
    }
  }

  // [6] ê²°ê³¼ ë° ë³´ìƒ
  let win = (monhp<=0 && turn<=maxTurn);
  if(turn>maxTurn) win = false;
  let baseExp = isDungeon ? Math.floor(user.level*4)+rint(16,32) : Math.floor(user.level*1.7)+rint(6,16);
  let baseGold = isDungeon ? rint(32,80)+Math.floor(user.level*4.2) : rint(10,20)+Math.floor(user.level*1.4);
  let hpLoss = user.hp-userhp.val;
  let rewardMsg = "";
  if(win){
    let gain = baseExp; let gold = baseGold; let dropMsg = "", stoneMsg="";
    if (Math.random() < (isDungeon?0.5:0.25)) {
      let item = makeItem(isDungeon, false, monster.unique ? monster.name : null);
      if (addInv(item)) dropMsg = `<br>ì•„ì´í…œ íšë“! ${itemDisplay(item)}`;
    }
    if(Math.random()<(isDungeon?0.15:0.10)){
      user.stones=(user.stones||0)+1;
      stoneMsg=`<br><span style="color:#77e;">ê°•í™”ì„ 1ê°œë¥¼ íšë“í–ˆë‹¤!</span>`;
    }
    user.exp += gain; user.gold += gold;
    user.hp = Math.max(1,userhp.val);
    let setBonusDesc = setBonusKey ? `<br><span class="set-bonus">[${uniqueSetBonus[setBonusKey].name} ì„¸íŠ¸ íš¨ê³¼: ${uniqueSetBonus[setBonusKey].desc}]</span>` : "";
    rewardMsg = `<br><b>ìŠ¹ë¦¬!</b> ê²½í—˜ì¹˜ +${gain}, ê³¨ë“œ +${gold}, HP -${hpLoss}${finalSkillMsg?`<br><span class="skill-log">${finalSkillMsg}</span>`:""}${setBonusDesc}${dropMsg}${stoneMsg}`;
    levelupCheck();
  } else {
    user.hp = userhp.val; if(userhp.val<=0) user.hp=1;
    rewardMsg = `<br><span class="dead-log">íŒ¨ë°°! 10í„´ ì´ˆê³¼ í˜¹ì€ ëª¬ìŠ¤í„°ì—ê²Œ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤. HP ${userhp.val<=0?'1ë¡œ ë³µêµ¬':`(${userhp.val})`}.</span>`;
    if(isDungeon && userhp.val<=0){
      let lost = [];
      if(Math.random()<0.2){
        let candidates = equipSlots.filter(s=>user.equip[s]);
        if(candidates.length){
          let lostSlot = candidates[rint(0,candidates.length-1)];
          let lostItem = user.equip[lostSlot];
          user.equip[lostSlot] = undefined; lost.push(lostItem.name);
        }
      }
      if(lost.length) rewardMsg += `<br><span class="dead-log">[ì¥ë¹„ ì†ì‹¤] ${lost.join(", ")}</span>`;
    }
  }
  log(`[${isDungeon?'ë˜ì „':'ì‚¬ëƒ¥'}] <span class="monname">${monster.unique ? `<span class="unique-monster">${monster.name}</span>` : monster.name}</span>ê³¼ì˜ í„´ì œ ì „íˆ¬ (ìµœëŒ€ 10í„´)<br>` + battleLog.join("<br>") + rewardMsg);
  updateUser();
}
function action(type){ battle(type); }
function dungeonEnterUI() {
  log(`<b>[ë˜ì „ ì…ì¥]</b><br>
  <span style="color:#ffd700;">ë˜ì „ì—ì„œ ì£½ìœ¼ë©´ í™•ë¥ ì ìœ¼ë¡œ ì¥ë¹„ë¥¼ ìƒì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span><br><br>
  <button class="inv-btn" onclick="dungeonAction()">ì…ì¥í•˜ê¸°</button>
  <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ì·¨ì†Œ</button>`);
}
function dungeonAction(){ battle("dungeon"); }
// ë ˆë²¨ì—… ë° ìŠ¤íƒ¯
function levelupCheck(){
  while(user.exp>=expNeed(user.level) && user.level<999){
    user.exp -= expNeed(user.level);
    user.level++;
    statRandAdd(user.stats);
    user.maxhp += 5+rint(0,5);
    user.hp = user.maxhp;
    log(`[LEVEL UP!] Lv.${user.level}ë¡œ ì˜¬ëìŠµë‹ˆë‹¤!`);
  }
}
function statRandAdd(stats){
  let idx = rint(0,stats.length-1);
  stats[idx]++;
}
// í™˜ìƒ: ì¥ë¹„ ì°©ìš©/ì°½ê³ ë§Œ ìœ ì§€, ì†Œì§€í’ˆ ì´ˆê¸°í™”
function rebirth(){
  if(user.level<999){log("ë ˆë²¨ 999 ë‹¬ì„± ì‹œì—ë§Œ í™˜ìƒ ê°€ëŠ¥!<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>");return;}
  if(!confirm("í™˜ìƒ ì‹œ ë ˆë²¨/ìŠ¤íƒ¯/ì†Œì§€í’ˆ/ê³¨ë“œê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì°©ìš©ì¥ë¹„ì™€ ì°½ê³ ëŠ” ìœ ì§€ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;
  let keepEquip = {};
  for(let slot of equipSlots) if(user.equip[slot]) keepEquip[slot] = user.equip[slot];
  let keepStorage = user.storage||[];
  user.level=1; user.exp=0; user.gold=100;
  user.stats=user.stats.map(x=>1+user.rebirth*10);
  user.statmax=9999; user.rebirth+=1; user.hp=30; user.maxhp=30;
  user.equip=keepEquip; user.inv=[]; user.stones=0; user.storage = keepStorage;
  log("í™˜ìƒ ì™„ë£Œ! ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ +10ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>");
  updateUser();
}
</script>
</body>
</html>
